set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go




 /*      
'COPYRIGHT NOTICE: Ã 2007 BY BIRD INFORMATION SYSTEMS ALL RIGHTS RESERVED.      
'********************************************************************************************      
' THIS FILE CONTAINS TRADE SECRETS OF BIRD INFORMATION SYSTEMS NO PART      
' MAY BE REPRODUCED OR TRANSMITTED IN ANY FORM BY ANY MEANS OR FOR ANY PURPOSE      
' WITHOUT THE EXPRESS WRITTEN PERMISSION OF BIRD INFORMATION SYSTEMS      
'********************************************************************************************      
NAME: UP_SER_TA_LOCATION_MASTER
PURPOSE: THIS PROCEDURE WILL  GENERATE OFFICEID.      
|--------|--------------------------------------------------------------|
|SL. NO. |DATE		  |DEVELOPER’S NAME		|ACTIVITY					|
|-----------------------------------------------------------------------|
|1.		 |21/12/2007  |TAPAN NATH           |CREATION					|
|-----------------------------------------------------------------------|
*/

ALTER PROCEDURE [dbo].[UP_GET_TA_OFFICEID]   
@CITYID INT,  
@CORPORATECODE CHAR(2),
@CORPORATEQUALIFIER CHAR(1),
@OFFICEID_TYPE_ID INT,
@RETURNID VARCHAR(9)='' OUTPUT  
AS  

DECLARE @NEXT_NUMBER AS CHAR(3)
DECLARE @OFFICEIDTYPENAME AS CHAR(35)

DECLARE @AL_NUM_START AS CHAR(5) --Check starts of the Alphabet Series
DECLARE @NUM_START AS CHAR(5) --Check starts of the Number Series

DECLARE @NR_RANGE_START AS INT
DECLARE @NR_RANGE_END AS INT

DECLARE @AN_RANGE_START AS CHAR(3)
DECLARE @AN_RANGE_END AS CHAR(3)

DECLARE @CITYCODE AS CHAR(3)
DECLARE @OFFFICEID AS CHAR(9)

SET @AL_NUM_START='FALSE'
SET @NUM_START='FALSE'


SELECT @OFFICEIDTYPENAME=LTRIM(RTRIM(UPPER(OFFICEID_TYPE_NAME))),@NR_RANGE_START=NR_RANGE_START,@AN_RANGE_START=AN_RANGE_START,@NR_RANGE_END=NR_RANGE_END,@AN_RANGE_END=AN_RANGE_END FROM T_G_OFFICEID_TYPE WHERE OFFICEID_TYPE_ID=@OFFICEID_TYPE_ID
--GET OFFICE TYPE
IF EXISTS(SELECT * FROM T_C_OFFICEID_POOL_NEXT_NUMBER WHERE CITYID=@CITYID AND CORPORATECODE=@CORPORATECODE AND CORPORATEQUALIFIER=@CORPORATEQUALIFIER AND OFFICEID_TYPE_ID=@OFFICEID_TYPE_ID)
	BEGIN
		--IF MAX NUMERIC VALUE IS GENERATED THEN
		--SELECT THE CHARACTER VALUE
		SELECT @NEXT_NUMBER=NEXT_NUMBER FROM T_C_OFFICEID_POOL_NEXT_NUMBER WHERE CITYID=@CITYID AND CORPORATECODE=@CORPORATECODE AND CORPORATEQUALIFIER=@CORPORATEQUALIFIER AND OFFICEID_TYPE_ID=@OFFICEID_TYPE_ID	
		IF (@OFFICEIDTYPENAME='AIRPORT OFFICE' OR @OFFICEIDTYPENAME='TOWN OFFICE' OR @OFFICEIDTYPENAME='TRAINING OFFICE') AND (@NEXT_NUMBER=CONVERT(VARCHAR(3),@NR_RANGE_END))
			BEGIN
				SET @NEXT_NUMBER=CONVERT(VARCHAR(3),@AN_RANGE_START)
				SET @AL_NUM_START='TRUE'
			END
	END
ELSE
	BEGIN
		--IF NO OFFICEID GENERATED		
		IF (@OFFICEIDTYPENAME='AIRPORT OFFICE') OR (@OFFICEIDTYPENAME='TOWN OFFICE') OR (@OFFICEIDTYPENAME='TRAINING OFFICE')
			BEGIN
				SET @NEXT_NUMBER=@NR_RANGE_START
				SET @NUM_START='TRUE'
			END
		ELSE
			BEGIN
				SET @NEXT_NUMBER=@AN_RANGE_START
			END
		IF (@OFFICEIDTYPENAME='INTERNET OFFICE')
			BEGIN
				SET @NEXT_NUMBER=@AN_RANGE_START
				SET @AL_NUM_START='TRUE'
			END
			INSERT INTO T_C_OFFICEID_POOL_NEXT_NUMBER
			(CITYID,CORPORATECODE,CORPORATEQUALIFIER,OFFICEID_TYPE_ID,NEXT_NUMBER) VALUES
			(@CITYID,@CORPORATECODE,@CORPORATEQUALIFIER,@OFFICEID_TYPE_ID,@NEXT_NUMBER)

	END

IF @AL_NUM_START='TRUE'
	BEGIN
		--UPDATE THE NEXTNUMBER IN THE 'T_C_OFFICEID_POOL_NEXT_NUMBER'		
		UPDATE T_C_OFFICEID_POOL_NEXT_NUMBER SET NEXT_NUMBER=@NEXT_NUMBER
		WHERE CITYID=@CITYID AND CORPORATECODE=@CORPORATECODE AND CORPORATEQUALIFIER=@CORPORATEQUALIFIER AND OFFICEID_TYPE_ID=@OFFICEID_TYPE_ID
		--CONCAT ALL THE VALUE FOR OFFICEID
	END
ELSE
	BEGIN
		--IF @NEXT_NUMBER=@AN_RANGE_END
		--BEGIN
			IF ASCII(RIGHT(@NEXT_NUMBER,1)) BETWEEN 65 AND 90
				BEGIN
					--print '--------------'
					--print @NEXT_NUMBER
					--print @AN_RANGE_END
					--print @OFFICEIDTYPENAME
					--print '--------------'					
					--GET THE ORDINAL PART
					--IF (@OFFICEIDTYPENAME='INTERNET OFFICE') OR (@OFFICEIDTYPENAME='AIRPORT OFFICE') OR @OFFICEIDTYPENAME='TOWN OFFICE'					 					  					  

					  IF (@OFFICEIDTYPENAME='INTERNET OFFICE') OR (@OFFICEIDTYPENAME='AIRPORT OFFICE') OR (@OFFICEIDTYPENAME='TOWN OFFICE')
						BEGIN	
							IF (@OFFICEIDTYPENAME='TOWN OFFICE')
								BEGIN
									IF (ASCII(SUBSTRING(@NEXT_NUMBER,2,1))=90) AND (ASCII(RIGHT(@NEXT_NUMBER,1))=90) AND CONVERT(INT,LEFT(@NEXT_NUMBER,1)) >=7
										--PRINT 'LAST NUMBER GENERATED FOR ' + @OFFICEIDTYPENAME
										RETURN '-1'
									ELSE
										SELECT @NEXT_NUMBER=CONVERT(VARCHAR(3),DBO.FN_GETOFFICEID(RIGHT(@NEXT_NUMBER,3),@OFFICEIDTYPENAME))
								END
							ELSE
								BEGIN		
									IF (ASCII(RIGHT(@NEXT_NUMBER,1))=90) AND  (ASCII(SUBSTRING(@NEXT_NUMBER,2,1))=90)
										--PRINT 'LAST NUMBER GENERATED FOR ' + @OFFICEIDTYPENAME
										RETURN '-1'
									ELSE
									SELECT @NEXT_NUMBER=CONVERT(VARCHAR(3),DBO.FN_GETOFFICEID(RIGHT(@NEXT_NUMBER,3),@OFFICEIDTYPENAME))
								END
						END
					ELSE
						BEGIN
							IF (ASCII(RIGHT(@NEXT_NUMBER,1))=90) AND (CONVERT(INT,LEFT(@NEXT_NUMBER,2)) >=94)
								--PRINT 'LAST NUMBER GENERATED FOR ' + @OFFICEIDTYPENAME
								RETURN '-1'
							ELSE
								IF (ASCII(RIGHT(@NEXT_NUMBER,1))=90 AND (LEFT(@NEXT_NUMBER,2) BETWEEN 91 AND 93))
									BEGIN
										--INCREASE THE VALUES BY 1 OF LEFT TOW NUMERIC PART
										SET @NEXT_NUMBER= CONVERT(VARCHAR(2),(CONVERT(INT,LEFT(@NEXT_NUMBER,2)) + 1)) + RIGHT(@NEXT_NUMBER,1)
										SELECT @NEXT_NUMBER=CONVERT(VARCHAR(3),DBO.FN_GETOFFICEID(RIGHT(@NEXT_NUMBER,3),@OFFICEIDTYPENAME))
									END
								ELSE
									BEGIN
										SELECT @NEXT_NUMBER=CONVERT(VARCHAR(3),DBO.FN_GETOFFICEID(RIGHT(@NEXT_NUMBER,3),@OFFICEIDTYPENAME))
									END
						END

				END
			ELSE
				BEGIN
					IF @NUM_START='FALSE'
						BEGIN
							SET @NEXT_NUMBER=@NEXT_NUMBER + 1
						END
				END
		--END
			UPDATE T_C_OFFICEID_POOL_NEXT_NUMBER SET NEXT_NUMBER=@NEXT_NUMBER
			WHERE CITYID=@CITYID AND CORPORATECODE=@CORPORATECODE AND CORPORATEQUALIFIER=@CORPORATEQUALIFIER AND OFFICEID_TYPE_ID=@OFFICEID_TYPE_ID

		--CONCAT ALL THE VALUE FOR OFFICEID
	END

	SELECT @CITYCODE=CITYCODE FROM T_G_CITY WHERE CITYID=@CITYID			
	--PRINT @CITYCODE 
	--PRINT @CORPORATECODE 
	--PRINT @CORPORATEQUALIFIER 

	--PRINT @NEXT_NUMBER		
	IF LEN(@NEXT_NUMBER)=1
		SET @NEXT_NUMBER = '00' + CONVERT(VARCHAR(3),@NEXT_NUMBER)
	IF LEN(@NEXT_NUMBER)=2
		SET @NEXT_NUMBER = '0' + CONVERT(VARCHAR(3),@NEXT_NUMBER)
		SET @OFFFICEID=@CITYCODE + CONVERT(VARCHAR(2),@CORPORATECODE) + CONVERT(VARCHAR(1),@CORPORATEQUALIFIER) + CONVERT(VARCHAR(3),@NEXT_NUMBER)		
	--PRINT @OFFFICEID	
	--RETURN @RETURNID

	SET @OFFFICEID=rtrim(ltrim(CONVERT(VARCHAR(9),@OFFFICEID)))
	--PRINT @OFFFICEID
	IF NOT EXISTS(SELECT * FROM T_C_OFFICEID_POOL WHERE OFFICEID=@OFFFICEID)
		BEGIN
			INSERT INTO T_C_OFFICEID_POOL
			(OFFICEID,ALLOCATED,PROCESSING_DATE) VALUES
			(@OFFFICEID,0,CONVERT(INTEGER,CONVERT(VARCHAR,GETDATE(),112)))
			SET @RETURNID='1'
			SET @RETURNID=@OFFFICEID
			--RETURN @RETURNID
		END
	ELSE
		BEGIN	
				SET @RETURNID='-1'				
				--RETURN @RETURNID
		END
		













