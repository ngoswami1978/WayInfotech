USE [AAMS]
GO

/****** Object:  UserDefinedFunction [dbo].[FN_1A_AIRLINE_TKT_BOOKINGS]    Script Date: 04/28/2011 15:46:22 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[FN_1A_AIRLINE_TKT_BOOKINGS]
(
	@1A_TICKET BIT=NULL,
	@DAILYBOOKINGS BIT=NULL,	
	@ALLCRS BIT=NULL,	
	
	@CITY VARCHAR(80) =NULL,  
	@COUNTRY VARCHAR(80)=NULL,  
	@LCODE  INT =NULL,  	
	@AGENCYNAME VARCHAR(200) =NULL,  
	@AIRLINE_CODE VARCHAR(5)=NULL,
	@RESP_1A INT =24,  			--employeeid
	@RESPONSIBLESTAFF INT =NULL,  	--1A RESPONSIBLE
	@AGENCYTYPEID INTEGER  =NULL,  
	@AGENCYSTATUSID INTEGER  =NULL,  
	@AOFFICE VARCHAR(3) =NULL,  
	@REGION VARCHAR(50) =NULL,  	
	@DATEFROM INT=NULL,
	@DATETO INT=NULL,
	@GROUPTYPEID INT=NULL,
	@NIDT BIT=NULL
)
RETURNS @A_TKT_BOOKINGS TABLE
(
	LCODE INT,OFFICEID VARCHAR(10),[MONTH] INT,[YEAR] INT,[DATE] INT,AIRLINE_CODE VARCHAR(2),
	[TKT_NETBOOKINGS] INT,DB_NETBOOKINGS INT,[1A_NETBOOKINGS] INT,MT_NETBOOKINGS INT
)
AS
BEGIN
	IF @1A_TICKET=1 and @DAILYBOOKINGS=0 and @ALLCRS=0 AND ISNULL(@NIDT,0)=0
	BEGIN
		INSERT @A_TKT_BOOKINGS
		(LCODE,OFFICEID,[MONTH],[YEAR],[DATE],AIRLINE_CODE,[TKT_NETBOOKINGS],DB_NETBOOKINGS,MT_NETBOOKINGS)
		SELECT T.LCODE,T.OFFICEID,
		SUBSTRING(CAST(DATE AS VARCHAR),5,2) AS [MONTH],LEFT(DATE,4) AS [YEAR],[DATE],AIRLINE_CODE,
		[TKT_NETBOOKINGS]=ISS_E_TKT,0 AS DB_NETBOOKINGS,0 AS MT_NETBOOKINGS 
		FROM T_C_1A_TICKET_BOOKINGS T WITH(NOLOCK)			
		INNER JOIN LOCATION_MASTER LM WITH(NOLOCK) ON LM.LOCATION_CODE=T.LCODE
		INNER JOIN AGROUP G WITH(NOLOCK) ON G.CHAIN_CODE=LM.CHAIN_CODE
		LEFT OUTER JOIN T_C_CLASSIFICATION C WITH(NOLOCK) ON G.GroupClassificationID=C.GroupClassificationID
		LEFT OUTER JOIN T_C_TYPE AT ON LM.AGENCYTYPEID=AT.AGENCYTYPEID
		LEFT OUTER JOIN T_G_EMPLOYEES EMP  WITH (NOLOCK)ON LM.RESP_1A=EMP.EMPLOYEEID
		--LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO WITH(NOLOCK) ON LM.LOCATION_CODE=VO.LCODE
		LEFT OUTER JOIN T_G_GROUP_TYPE GT  WITH(NOLOCK) ON G.GROUPTYPEID=GT.GROUPTYPEID
		WHERE 				
			(@COUNTRY IS NULL OR LM.COUNTRY=@COUNTRY)
			AND (@CITY IS NULL OR LM.CITY=@CITY)
			AND (@LCODE IS NULL OR LM.LOCATION_CODE=@LCODE)
			AND (@AGENCYNAME IS NULL OR LM.NAME LIKE '%' + LTRIM(RTRIM(@AGENCYNAME)) + '%')
			AND (@RESPONSIBLESTAFF IS NULL OR LM.RESP_1A=@RESPONSIBLESTAFF)
			AND (@AGENCYTYPEID IS NULL OR LM.AGENCYTYPEID=@AGENCYTYPEID)
			AND (@AGENCYSTATUSID IS NULL OR LM.AGENCYSTATUSID=@AGENCYSTATUSID)				
			AND (@AOFFICE IS NULL OR LM.AOFFICE=@AOFFICE)								
			AND (@REGION IS NULL OR LM.AOFFICE IN (SELECT AOFFICE FROM BRANCH WITH (NOLOCK) WHERE REGION=@REGION))
			AND (@GROUPTYPEID IS NULL OR GT.GROUPTYPEID=@GROUPTYPEID)				
			AND T.[DATE] BETWEEN @DATEFROM AND @DATETO

	END
  ELSE
	IF @1A_TICKET=0 AND @DAILYBOOKINGS=1 and @ALLCRS=0 AND ISNULL(@NIDT,0)=0
	BEGIN
		INSERT @A_TKT_BOOKINGS
		(LCODE,OFFICEID,[MONTH],[YEAR],[DATE],AIRLINE_CODE,[TKT_NETBOOKINGS],DB_NETBOOKINGS,MT_NETBOOKINGS)
		SELECT DB.LCODE,VO.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,AIRLINE_CODE, 
		0 AS [TKT_NETBOOKINGS],NETBOOKINGS AS DB_NETBOOKINGS,0 AS MT_NETBOOKINGS
		FROM T_C_1A_DAILY_BOOKINGS DB WITH(NOLOCK)		
		INNER JOIN LOCATION_MASTER LM WITH(NOLOCK) ON LM.LOCATION_CODE=DB.LCODE
		INNER JOIN AGROUP G WITH(NOLOCK) ON G.CHAIN_CODE=LM.CHAIN_CODE
		LEFT OUTER JOIN T_C_CLASSIFICATION C WITH(NOLOCK) ON G.GroupClassificationID=C.GroupClassificationID
		LEFT OUTER JOIN T_C_TYPE AT ON LM.AGENCYTYPEID=AT.AGENCYTYPEID
		LEFT OUTER JOIN T_G_EMPLOYEES EMP  WITH (NOLOCK)ON LM.RESP_1A=EMP.EMPLOYEEID
		LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO WITH(NOLOCK) ON LM.LOCATION_CODE=VO.LCODE
		LEFT OUTER JOIN T_G_GROUP_TYPE GT  WITH(NOLOCK) ON G.GROUPTYPEID=GT.GROUPTYPEID
		WHERE 				
			(@COUNTRY IS NULL OR LM.COUNTRY=@COUNTRY)
			AND (@CITY IS NULL OR LM.CITY=@CITY)
			AND (@LCODE IS NULL OR LM.LOCATION_CODE=@LCODE)
			AND (@AGENCYNAME IS NULL OR LM.NAME LIKE '%' + LTRIM(RTRIM(@AGENCYNAME)) + '%')
			AND (@RESPONSIBLESTAFF IS NULL OR LM.RESP_1A=@RESPONSIBLESTAFF)
			AND (@AGENCYTYPEID IS NULL OR LM.AGENCYTYPEID=@AGENCYTYPEID)
			AND (@AGENCYSTATUSID IS NULL OR LM.AGENCYSTATUSID=@AGENCYSTATUSID)				
			AND (@AOFFICE IS NULL OR LM.AOFFICE=@AOFFICE)								
			AND (@REGION IS NULL OR LM.AOFFICE IN (SELECT AOFFICE FROM BRANCH WITH (NOLOCK) WHERE REGION=@REGION))
			AND (@GROUPTYPEID IS NULL OR GT.GROUPTYPEID=@GROUPTYPEID)				
			AND (([YEAR]*100)+[MONTH])*100+1 BETWEEN @DATEFROM AND @DATETO		
	END
  ELSE	
	IF @1A_TICKET=0 AND @DAILYBOOKINGS=0 and @ALLCRS=1 AND ISNULL(@NIDT,0)=0
	BEGIN
		INSERT @A_TKT_BOOKINGS
		(LCODE,OFFICEID,[MONTH],[YEAR],[DATE],AIRLINE_CODE,[TKT_NETBOOKINGS],DB_NETBOOKINGS,MT_NETBOOKINGS)
		SELECT DB.LCODE,VO.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,AIRLINE_CODE,
		0 AS [TKT_NETBOOKINGS],0 AS DB_NETBOOKINGS,NETBOOKINGS AS MT_NETBOOKINGS FROM T_MIDTPRODUCTIVITY_AIR DB WITH(NOLOCK)		
		INNER JOIN LOCATION_MASTER LM WITH(NOLOCK) ON LM.LOCATION_CODE=DB.LCODE
		INNER JOIN AGROUP G WITH(NOLOCK) ON G.CHAIN_CODE=LM.CHAIN_CODE
		LEFT OUTER JOIN T_C_CLASSIFICATION C WITH(NOLOCK) ON G.GroupClassificationID=C.GroupClassificationID
		LEFT OUTER JOIN T_C_TYPE AT ON LM.AGENCYTYPEID=AT.AGENCYTYPEID
		LEFT OUTER JOIN T_G_EMPLOYEES EMP  WITH (NOLOCK)ON LM.RESP_1A=EMP.EMPLOYEEID
		LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO WITH(NOLOCK) ON LM.LOCATION_CODE=VO.LCODE
		LEFT OUTER JOIN T_G_GROUP_TYPE GT  WITH(NOLOCK) ON G.GROUPTYPEID=GT.GROUPTYPEID
	WHERE 				
		(@COUNTRY IS NULL OR LM.COUNTRY=@COUNTRY)
		AND (@CITY IS NULL OR LM.CITY=@CITY)
		AND (@LCODE IS NULL OR LM.LOCATION_CODE=@LCODE)
		AND (@AGENCYNAME IS NULL OR LM.NAME LIKE '%' + LTRIM(RTRIM(@AGENCYNAME)) + '%')
		AND (@RESPONSIBLESTAFF IS NULL OR LM.RESP_1A=@RESPONSIBLESTAFF)
		AND (@AGENCYTYPEID IS NULL OR LM.AGENCYTYPEID=@AGENCYTYPEID)
		AND (@AGENCYSTATUSID IS NULL OR LM.AGENCYSTATUSID=@AGENCYSTATUSID)				
		AND (@AOFFICE IS NULL OR LM.AOFFICE=@AOFFICE)								
		AND (@REGION IS NULL OR LM.AOFFICE IN (SELECT AOFFICE FROM BRANCH WITH (NOLOCK) WHERE REGION=@REGION))
		AND (@GROUPTYPEID IS NULL OR GT.GROUPTYPEID=@GROUPTYPEID)				
		AND (([YEAR]*100)+[MONTH])*100+1 BETWEEN @DATEFROM AND @DATETO	
		
	END
  ELSE
  	IF(@1A_TICKET=1 AND @DAILYBOOKINGS=1 and @ALLCRS=0 AND ISNULL(@NIDT,0)=0)
  		BEGIN
			INSERT @A_TKT_BOOKINGS
			(LCODE,OFFICEID,[MONTH],[YEAR],[DATE],AIRLINE_CODE,[TKT_NETBOOKINGS],DB_NETBOOKINGS,MT_NETBOOKINGS)
			SELECT DB.LCODE,DB.OFFICEID,DB.[MONTH],DB.[YEAR],DB.[DATE],	DB.AIRLINE_CODE,DB.[TKT_NETBOOKINGS],DB.DB_NETBOOKINGS,DB.MT_NETBOOKINGS FROM(
				SELECT T.LCODE,T.OFFICEID,
				SUBSTRING(CAST(DATE AS VARCHAR),5,2) AS [MONTH],LEFT(DATE,4) AS [YEAR],[DATE],AIRLINE_CODE,
				[TKT_NETBOOKINGS]=ISS_E_TKT,0 AS DB_NETBOOKINGS,0 AS MT_NETBOOKINGS 
				FROM T_C_1A_TICKET_BOOKINGS T WITH(NOLOCK)	
			UNION ALL
				SELECT DB.LCODE,VO.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,AIRLINE_CODE, 
				0 AS [TKT_NETBOOKINGS],NETBOOKINGS AS DB_NETBOOKINGS,0 AS MT_NETBOOKINGS
				FROM T_C_1A_DAILY_BOOKINGS DB WITH(NOLOCK)
				LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO ON DB.LCODE=VO.LCODE) AS DB				
				INNER JOIN LOCATION_MASTER LM WITH(NOLOCK) ON LM.LOCATION_CODE=DB.LCODE
				INNER JOIN AGROUP G WITH(NOLOCK) ON G.CHAIN_CODE=LM.CHAIN_CODE
				LEFT OUTER JOIN T_C_CLASSIFICATION C WITH(NOLOCK) ON G.GroupClassificationID=C.GroupClassificationID
				LEFT OUTER JOIN T_C_TYPE AT ON LM.AGENCYTYPEID=AT.AGENCYTYPEID
				LEFT OUTER JOIN T_G_EMPLOYEES EMP  WITH (NOLOCK)ON LM.RESP_1A=EMP.EMPLOYEEID
				LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO WITH(NOLOCK) ON LM.LOCATION_CODE=VO.LCODE
				LEFT OUTER JOIN T_G_GROUP_TYPE GT  WITH(NOLOCK) ON G.GROUPTYPEID=GT.GROUPTYPEID
			WHERE 				
				(@COUNTRY IS NULL OR LM.COUNTRY=@COUNTRY)
				AND (@CITY IS NULL OR LM.CITY=@CITY)
				AND (@LCODE IS NULL OR LM.LOCATION_CODE=@LCODE)
				AND (@AGENCYNAME IS NULL OR LM.NAME LIKE '%' + LTRIM(RTRIM(@AGENCYNAME)) + '%')
				AND (@RESPONSIBLESTAFF IS NULL OR LM.RESP_1A=@RESPONSIBLESTAFF)
				AND (@AGENCYTYPEID IS NULL OR LM.AGENCYTYPEID=@AGENCYTYPEID)
				AND (@AGENCYSTATUSID IS NULL OR LM.AGENCYSTATUSID=@AGENCYSTATUSID)				
				AND (@AOFFICE IS NULL OR LM.AOFFICE=@AOFFICE)								
				AND (@REGION IS NULL OR LM.AOFFICE IN (SELECT AOFFICE FROM BRANCH WITH (NOLOCK) WHERE REGION=@REGION))
				AND (@GROUPTYPEID IS NULL OR GT.GROUPTYPEID=@GROUPTYPEID)				
				AND DB.DATE BETWEEN @DATEFROM AND @DATETO
  		END
  ELSE		
    	IF(@1A_TICKET=1 AND @DAILYBOOKINGS=0 and @ALLCRS=1 AND ISNULL(@NIDT,0)=0)
  		BEGIN
			INSERT @A_TKT_BOOKINGS
			(LCODE,OFFICEID,[MONTH],[YEAR],[DATE],AIRLINE_CODE,[TKT_NETBOOKINGS],DB_NETBOOKINGS,MT_NETBOOKINGS)
			SELECT DB.LCODE,DB.OFFICEID,DB.[MONTH],DB.[YEAR],DB.[DATE],	DB.AIRLINE_CODE,DB.[TKT_NETBOOKINGS],DB.DB_NETBOOKINGS,DB.MT_NETBOOKINGS FROM(
			SELECT T.LCODE,T.OFFICEID,
			SUBSTRING(CAST(DATE AS VARCHAR),5,2) AS [MONTH],LEFT(DATE,4) AS [YEAR],[DATE],AIRLINE_CODE,
			[TKT_NETBOOKINGS]=ISS_E_TKT,0 AS DB_NETBOOKINGS,0 AS MT_NETBOOKINGS 
			FROM T_C_1A_TICKET_BOOKINGS T WITH(NOLOCK)	
		UNION ALL
			SELECT DB.LCODE,VO.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,AIRLINE_CODE,
			0 AS [TKT_NETBOOKINGS],0 AS DB_NETBOOKINGS,NETBOOKINGS AS MT_NETBOOKINGS FROM T_MIDTPRODUCTIVITY_AIR DB WITH(NOLOCK)
			LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO ON DB.LCODE=VO.LCODE)	AS DB
			INNER JOIN LOCATION_MASTER LM WITH(NOLOCK) ON LM.LOCATION_CODE=DB.LCODE
			INNER JOIN AGROUP G WITH(NOLOCK) ON G.CHAIN_CODE=LM.CHAIN_CODE
			LEFT OUTER JOIN T_C_CLASSIFICATION C WITH(NOLOCK) ON G.GroupClassificationID=C.GroupClassificationID
			LEFT OUTER JOIN T_C_TYPE AT ON LM.AGENCYTYPEID=AT.AGENCYTYPEID
			LEFT OUTER JOIN T_G_EMPLOYEES EMP  WITH (NOLOCK)ON LM.RESP_1A=EMP.EMPLOYEEID
			LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO WITH(NOLOCK) ON LM.LOCATION_CODE=VO.LCODE
			LEFT OUTER JOIN T_G_GROUP_TYPE GT  WITH(NOLOCK) ON G.GROUPTYPEID=GT.GROUPTYPEID
		WHERE 				
			(@COUNTRY IS NULL OR LM.COUNTRY=@COUNTRY)
			AND (@CITY IS NULL OR LM.CITY=@CITY)
			AND (@LCODE IS NULL OR LM.LOCATION_CODE=@LCODE)
			AND (@AGENCYNAME IS NULL OR LM.NAME LIKE '%' + LTRIM(RTRIM(@AGENCYNAME)) + '%')
			AND (@RESPONSIBLESTAFF IS NULL OR LM.RESP_1A=@RESPONSIBLESTAFF)
			AND (@AGENCYTYPEID IS NULL OR LM.AGENCYTYPEID=@AGENCYTYPEID)
			AND (@AGENCYSTATUSID IS NULL OR LM.AGENCYSTATUSID=@AGENCYSTATUSID)				
			AND (@AOFFICE IS NULL OR LM.AOFFICE=@AOFFICE)								
			AND (@REGION IS NULL OR LM.AOFFICE IN (SELECT AOFFICE FROM BRANCH WITH (NOLOCK) WHERE REGION=@REGION))
			AND (@GROUPTYPEID IS NULL OR GT.GROUPTYPEID=@GROUPTYPEID)				
			AND DB.DATE BETWEEN @DATEFROM AND @DATETO			
  		END
  ELSE
    	IF(@1A_TICKET=0 AND @DAILYBOOKINGS=1 and @ALLCRS=1 AND ISNULL(@NIDT,0)=0)
  		BEGIN
			INSERT @A_TKT_BOOKINGS
			(LCODE,OFFICEID,[MONTH],[YEAR],[DATE],AIRLINE_CODE,[TKT_NETBOOKINGS],DB_NETBOOKINGS,MT_NETBOOKINGS)
			SELECT DB.LCODE,DB.OFFICEID,DB.[MONTH],DB.[YEAR],DB.[DATE],	DB.AIRLINE_CODE,DB.[TKT_NETBOOKINGS],DB.DB_NETBOOKINGS,DB.MT_NETBOOKINGS FROM(
			SELECT DB.LCODE,VO.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,AIRLINE_CODE, 
			0 AS [TKT_NETBOOKINGS],NETBOOKINGS AS DB_NETBOOKINGS,0 AS MT_NETBOOKINGS
			FROM T_C_1A_DAILY_BOOKINGS DB WITH(NOLOCK)
			LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO ON DB.LCODE=VO.LCODE
		UNION ALL	
			SELECT DB.LCODE,VO.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,AIRLINE_CODE,
			0 AS [TKT_NETBOOKINGS],0 AS DB_NETBOOKINGS,NETBOOKINGS AS MT_NETBOOKINGS FROM T_MIDTPRODUCTIVITY_AIR DB WITH(NOLOCK)
			LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO ON DB.LCODE=VO.LCODE	)AS DB			
			INNER JOIN LOCATION_MASTER LM WITH(NOLOCK) ON LM.LOCATION_CODE=DB.LCODE
			INNER JOIN AGROUP G WITH(NOLOCK) ON G.CHAIN_CODE=LM.CHAIN_CODE
			LEFT OUTER JOIN T_C_CLASSIFICATION C WITH(NOLOCK) ON G.GroupClassificationID=C.GroupClassificationID
			LEFT OUTER JOIN T_C_TYPE AT ON LM.AGENCYTYPEID=AT.AGENCYTYPEID
			LEFT OUTER JOIN T_G_EMPLOYEES EMP  WITH (NOLOCK)ON LM.RESP_1A=EMP.EMPLOYEEID
			LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO WITH(NOLOCK) ON LM.LOCATION_CODE=VO.LCODE
			LEFT OUTER JOIN T_G_GROUP_TYPE GT  WITH(NOLOCK) ON G.GROUPTYPEID=GT.GROUPTYPEID
		WHERE 				
			(@COUNTRY IS NULL OR LM.COUNTRY=@COUNTRY)
			AND (@CITY IS NULL OR LM.CITY=@CITY)
			AND (@LCODE IS NULL OR LM.LOCATION_CODE=@LCODE)
			AND (@AGENCYNAME IS NULL OR LM.NAME LIKE '%' + LTRIM(RTRIM(@AGENCYNAME)) + '%')
			AND (@RESPONSIBLESTAFF IS NULL OR LM.RESP_1A=@RESPONSIBLESTAFF)
			AND (@AGENCYTYPEID IS NULL OR LM.AGENCYTYPEID=@AGENCYTYPEID)
			AND (@AGENCYSTATUSID IS NULL OR LM.AGENCYSTATUSID=@AGENCYSTATUSID)				
			AND (@AOFFICE IS NULL OR LM.AOFFICE=@AOFFICE)								
			AND (@REGION IS NULL OR LM.AOFFICE IN (SELECT AOFFICE FROM BRANCH WITH (NOLOCK) WHERE REGION=@REGION))
			AND (@GROUPTYPEID IS NULL OR GT.GROUPTYPEID=@GROUPTYPEID)				
			AND DB.DATE BETWEEN @DATEFROM AND @DATETO
  		END  		
  ELSE
		BEGIN
			INSERT @A_TKT_BOOKINGS
			(LCODE,OFFICEID,[MONTH],[YEAR],[DATE],AIRLINE_CODE,[TKT_NETBOOKINGS],DB_NETBOOKINGS,MT_NETBOOKINGS)
			SELECT DB.LCODE,DB.OFFICEID,DB.[MONTH],DB.[YEAR],DB.[DATE],	DB.AIRLINE_CODE,DB.[TKT_NETBOOKINGS],DB.DB_NETBOOKINGS,DB.MT_NETBOOKINGS FROM(
			SELECT T.LCODE,T.OFFICEID,
			SUBSTRING(CAST(DATE AS VARCHAR),5,2) AS [MONTH],LEFT(DATE,4) AS [YEAR],[DATE],AIRLINE_CODE,
			[TKT_NETBOOKINGS]=ISS_E_TKT,0 AS DB_NETBOOKINGS,0 AS MT_NETBOOKINGS 
			FROM T_C_1A_TICKET_BOOKINGS T WITH(NOLOCK)	
		UNION ALL
			SELECT DB.LCODE,VO.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,AIRLINE_CODE, 
			0 AS [TKT_NETBOOKINGS],NETBOOKINGS AS DB_NETBOOKINGS,0 AS MT_NETBOOKINGS
			FROM T_C_1A_DAILY_BOOKINGS DB WITH(NOLOCK)
			LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO ON DB.LCODE=VO.LCODE
		UNION ALL			
			SELECT DB.LCODE,VO.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,AIRLINE_CODE,
			0 AS [TKT_NETBOOKINGS],0 AS DB_NETBOOKINGS,NETBOOKINGS AS MT_NETBOOKINGS FROM T_MIDTPRODUCTIVITY_AIR DB WITH(NOLOCK)
			LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO ON DB.LCODE=VO.LCODE)	AS DB
						
			INNER JOIN LOCATION_MASTER LM WITH(NOLOCK) ON LM.LOCATION_CODE=DB.LCODE
			INNER JOIN AGROUP G WITH(NOLOCK) ON G.CHAIN_CODE=LM.CHAIN_CODE
			LEFT OUTER JOIN T_C_CLASSIFICATION C WITH(NOLOCK) ON G.GroupClassificationID=C.GroupClassificationID
			LEFT OUTER JOIN T_C_TYPE AT ON LM.AGENCYTYPEID=AT.AGENCYTYPEID
			LEFT OUTER JOIN T_G_EMPLOYEES EMP  WITH (NOLOCK)ON LM.RESP_1A=EMP.EMPLOYEEID
			LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO WITH(NOLOCK) ON LM.LOCATION_CODE=VO.LCODE
			LEFT OUTER JOIN T_G_GROUP_TYPE GT  WITH(NOLOCK) ON G.GROUPTYPEID=GT.GROUPTYPEID
		WHERE 				
			(@COUNTRY IS NULL OR LM.COUNTRY=@COUNTRY)
			AND (@CITY IS NULL OR LM.CITY=@CITY)
			AND (@LCODE IS NULL OR LM.LOCATION_CODE=@LCODE)
			AND (@AGENCYNAME IS NULL OR LM.NAME LIKE '%' + LTRIM(RTRIM(@AGENCYNAME)) + '%')
			AND (@RESPONSIBLESTAFF IS NULL OR LM.RESP_1A=@RESPONSIBLESTAFF)
			AND (@AGENCYTYPEID IS NULL OR LM.AGENCYTYPEID=@AGENCYTYPEID)
			AND (@AGENCYSTATUSID IS NULL OR LM.AGENCYSTATUSID=@AGENCYSTATUSID)				
			AND (@AOFFICE IS NULL OR LM.AOFFICE=@AOFFICE)								
			AND (@REGION IS NULL OR LM.AOFFICE IN (SELECT AOFFICE FROM BRANCH WITH (NOLOCK) WHERE REGION=@REGION))
			AND (@GROUPTYPEID IS NULL OR GT.GROUPTYPEID=@GROUPTYPEID)				
			AND DB.DATE BETWEEN @DATEFROM AND @DATETO
			
		END		
	RETURN
END


GO

/****** Object:  UserDefinedFunction [dbo].[FN_1A_TKT_BOOKINGS]    Script Date: 04/28/2011 15:46:25 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[FN_1A_TKT_BOOKINGS]
(
	@1A_TICKET BIT=NULL,
	@DAILYBOOKINGS BIT=NULL,
	@1A_PROD BIT=NULL,
	@ALLCRS BIT=NULL,
	
	@CITY VARCHAR(80) =NULL,  
	@COUNTRY VARCHAR(80)=NULL,  
	@LCODE  INT =NULL,  	
	@AGENCYNAME VARCHAR(200) =NULL,  
	@AIRLINE_CODE VARCHAR(5)=NULL,
	@RESP_1A INT =24,  			--employeeid
	@RESPONSIBLESTAFF INT =NULL,  	--1A RESPONSIBLE
	@AGENCYTYPEID INTEGER  =NULL,  
	@AGENCYSTATUSID INTEGER  =NULL,  
	@AOFFICE VARCHAR(3) =NULL,  
	@REGION VARCHAR(50) =NULL,  	
	@DATEFROM INT=NULL,
	@DATETO INT=NULL,
	@GROUPTYPEID INT=NULL,
	@NIDT BIT=NULL,
	@CHAIN_CODE INT=NULL
)
RETURNS @A_TKT_BOOKINGS TABLE
([TYPE] VARCHAR(1),LCODE INT,OFFICEID VARCHAR(10),[MONTH] INT,[YEAR] INT,[DATE] INT,[TKT_NETBOOKINGS] INT,DB_NETBOOKINGS INT,[1A_NETBOOKINGS] INT,MT_NETBOOKINGS INT,CODD INT default 0,HX_BOOKINGS INT default 0)
AS
BEGIN
	 --SINGLE
	  IF (@1A_TICKET=1)  AND (@DAILYBOOKINGS=0) AND(@1A_PROD=0) AND (@ALLCRS=0) AND (ISNULL(@NIDT,0)=0)
		BEGIN			
			INSERT @A_TKT_BOOKINGS
			([TYPE],LCODE,OFFICEID,
			[MONTH],[YEAR],[DATE],[TKT_NETBOOKINGS],DB_NETBOOKINGS,[1A_NETBOOKINGS],MT_NETBOOKINGS)
			SELECT 'A',T.LCODE,T.OFFICEID,
			SUBSTRING(CAST(DATE AS VARCHAR),5,2) AS [MONTH],LEFT(DATE,4) AS [YEAR],
			[DATE],[TKT_NETBOOKINGS]=ISS_E_TKT,0 AS DB_NETBOOKINGS,0 AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS 			
			FROM 	T_C_1A_TICKET_BOOKINGS T WITH(NOLOCK)						
			INNER JOIN LOCATION_MASTER LM WITH(NOLOCK) ON LM.LOCATION_CODE=T.LCODE
			INNER JOIN AGROUP G WITH(NOLOCK) ON G.CHAIN_CODE=LM.CHAIN_CODE
			LEFT OUTER JOIN T_C_CLASSIFICATION C WITH(NOLOCK) ON G.GroupClassificationID=C.GroupClassificationID
			LEFT OUTER JOIN T_C_TYPE AT ON LM.AGENCYTYPEID=AT.AGENCYTYPEID
			LEFT OUTER JOIN T_G_EMPLOYEES EMP  WITH (NOLOCK)ON LM.RESP_1A=EMP.EMPLOYEEID
			LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO WITH(NOLOCK) ON LM.LOCATION_CODE=VO.LCODE
			LEFT OUTER JOIN T_G_GROUP_TYPE GT  WITH(NOLOCK) ON G.GROUPTYPEID=GT.GROUPTYPEID
			WHERE 				
				(@COUNTRY IS NULL OR LM.COUNTRY=@COUNTRY)
				AND (@CITY IS NULL OR LM.CITY=@CITY)
				AND (@LCODE IS NULL OR LM.LOCATION_CODE=@LCODE)
				AND (@AGENCYNAME IS NULL OR LM.NAME LIKE '%' + LTRIM(RTRIM(@AGENCYNAME)) + '%')
				AND (@RESPONSIBLESTAFF IS NULL OR LM.RESP_1A=@RESPONSIBLESTAFF)
				AND (@AGENCYTYPEID IS NULL OR LM.AGENCYTYPEID=@AGENCYTYPEID)
				AND (@AGENCYSTATUSID IS NULL OR LM.AGENCYSTATUSID=@AGENCYSTATUSID)				
				AND (@AOFFICE IS NULL OR LM.AOFFICE=@AOFFICE)								
				AND (@REGION IS NULL OR LM.AOFFICE IN (SELECT AOFFICE FROM BRANCH WITH (NOLOCK) WHERE REGION=@REGION))
				AND (@GROUPTYPEID IS NULL OR GT.GROUPTYPEID=@GROUPTYPEID)				
				AND (@CHAIN_CODE IS NULL OR LM.CHAIN_CODE=@CHAIN_CODE)
				AND T.[DATE] BETWEEN @DATEFROM AND @DATETO
		END
	ELSE
	  IF (@1A_TICKET=0)  AND (@DAILYBOOKINGS=1) AND(@1A_PROD=0) AND (@ALLCRS=0) AND (ISNULL(@NIDT,0)=0)
		BEGIN			
			INSERT @A_TKT_BOOKINGS
			(TYPE,LCODE,OFFICEID,[MONTH],[YEAR],[DATE],[TKT_NETBOOKINGS],DB_NETBOOKINGS,[1A_NETBOOKINGS],MT_NETBOOKINGS)
			SELECT 'B',DB.LCODE,VO.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1, 0 AS [TKT_NETBOOKINGS],NETBOOKINGS,0 AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS
			FROM T_C_1A_DAILY_BOOKINGS DB WITH(NOLOCK)
			--LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO ON DB.LCODE=VO.LCODE			
			INNER JOIN LOCATION_MASTER LM WITH(NOLOCK) ON LM.LOCATION_CODE=DB.LCODE
			INNER JOIN AGROUP G WITH(NOLOCK) ON G.CHAIN_CODE=LM.CHAIN_CODE
			LEFT OUTER JOIN T_C_CLASSIFICATION C WITH(NOLOCK) ON G.GroupClassificationID=C.GroupClassificationID
			LEFT OUTER JOIN T_C_TYPE AT ON LM.AGENCYTYPEID=AT.AGENCYTYPEID
			LEFT OUTER JOIN T_G_EMPLOYEES EMP  WITH (NOLOCK)ON LM.RESP_1A=EMP.EMPLOYEEID
			LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO WITH(NOLOCK) ON LM.LOCATION_CODE=VO.LCODE
			LEFT OUTER JOIN T_G_GROUP_TYPE GT  WITH(NOLOCK) ON G.GROUPTYPEID=GT.GROUPTYPEID
			WHERE 				
				(@COUNTRY IS NULL OR LM.COUNTRY=@COUNTRY)
				AND (@CITY IS NULL OR LM.CITY=@CITY)
				AND (@LCODE IS NULL OR LM.LOCATION_CODE=@LCODE)
				AND (@AGENCYNAME IS NULL OR LM.NAME LIKE '%' + LTRIM(RTRIM(@AGENCYNAME)) + '%')
				AND (@RESPONSIBLESTAFF IS NULL OR LM.RESP_1A=@RESPONSIBLESTAFF)
				AND (@AGENCYTYPEID IS NULL OR LM.AGENCYTYPEID=@AGENCYTYPEID)
				AND (@AGENCYSTATUSID IS NULL OR LM.AGENCYSTATUSID=@AGENCYSTATUSID)				
				AND (@AOFFICE IS NULL OR LM.AOFFICE=@AOFFICE)								
				AND (@REGION IS NULL OR LM.AOFFICE IN (SELECT AOFFICE FROM BRANCH WITH (NOLOCK) WHERE REGION=@REGION))
				AND (@GROUPTYPEID IS NULL OR GT.GROUPTYPEID=@GROUPTYPEID)				
				AND (@CHAIN_CODE IS NULL OR LM.CHAIN_CODE=@CHAIN_CODE)
				AND (([YEAR]*100)+[MONTH])*100+1 BETWEEN @DATEFROM AND @DATETO
		END
	ELSE	
		IF (@1A_TICKET=0)  AND (@DAILYBOOKINGS=0) AND(@1A_PROD=1) AND (@ALLCRS=0) AND (ISNULL(@NIDT,0)=0)
			BEGIN						
				INSERT @A_TKT_BOOKINGS
				(TYPE,LCODE,OFFICEID,[MONTH],[YEAR],[DATE],[TKT_NETBOOKINGS],DB_NETBOOKINGS,[1A_NETBOOKINGS],MT_NETBOOKINGS)
				SELECT 'C',T_C_AIR_BOOKINGS.LCODE,T_C_AIR_BOOKINGS.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,0 AS [TKT_NETBOOKINGS],0 AS DB_NETBOOKINGS,NETBOOKINGS AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS
				FROM T_C_AIR_BOOKINGS  WITH(NOLOCK)				
				INNER JOIN LOCATION_MASTER LM WITH(NOLOCK) ON LM.LOCATION_CODE=T_C_AIR_BOOKINGS.LCODE
				INNER JOIN AGROUP G WITH(NOLOCK) ON G.CHAIN_CODE=LM.CHAIN_CODE
				LEFT OUTER JOIN T_C_CLASSIFICATION C WITH(NOLOCK) ON G.GroupClassificationID=C.GroupClassificationID
				LEFT OUTER JOIN T_C_TYPE AT ON LM.AGENCYTYPEID=AT.AGENCYTYPEID
				LEFT OUTER JOIN T_G_EMPLOYEES EMP  WITH (NOLOCK)ON LM.RESP_1A=EMP.EMPLOYEEID
				--LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO WITH(NOLOCK) ON LM.LOCATION_CODE=VO.LCODE
				LEFT OUTER JOIN T_G_GROUP_TYPE GT  WITH(NOLOCK) ON G.GROUPTYPEID=GT.GROUPTYPEID
			WHERE 				
				(@COUNTRY IS NULL OR LM.COUNTRY=@COUNTRY)
				AND (@CITY IS NULL OR LM.CITY=@CITY)
				AND (@LCODE IS NULL OR LM.LOCATION_CODE=@LCODE)
				AND (@AGENCYNAME IS NULL OR LM.NAME LIKE '%' + LTRIM(RTRIM(@AGENCYNAME)) + '%')
				AND (@RESPONSIBLESTAFF IS NULL OR LM.RESP_1A=@RESPONSIBLESTAFF)
				AND (@AGENCYTYPEID IS NULL OR LM.AGENCYTYPEID=@AGENCYTYPEID)
				AND (@AGENCYSTATUSID IS NULL OR LM.AGENCYSTATUSID=@AGENCYSTATUSID)				
				AND (@AOFFICE IS NULL OR LM.AOFFICE=@AOFFICE)								
				AND (@REGION IS NULL OR LM.AOFFICE IN (SELECT AOFFICE FROM BRANCH WITH (NOLOCK) WHERE REGION=@REGION))
				AND (@GROUPTYPEID IS NULL OR GT.GROUPTYPEID=@GROUPTYPEID)				
				AND (@CHAIN_CODE IS NULL OR LM.CHAIN_CODE=@CHAIN_CODE)
				AND (([YEAR]*100)+[MONTH])*100+1 BETWEEN @DATEFROM AND @DATETO
				AND ACCESS_LEVEL<>'PB'				
			END
	ELSE	
			IF (@1A_TICKET=0)  AND (@DAILYBOOKINGS=0) AND(@1A_PROD=0) AND (@ALLCRS=1) AND (ISNULL(@NIDT,0)=0)
			BEGIN				
				INSERT @A_TKT_BOOKINGS
				(TYPE,LCODE,OFFICEID,[MONTH],[YEAR],[DATE],[TKT_NETBOOKINGS],DB_NETBOOKINGS,[1A_NETBOOKINGS],MT_NETBOOKINGS)
				SELECT 'D',DB.LCODE,VO.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,0 AS [TKT_NETBOOKINGS],0 AS DB_NETBOOKINGS,0 AS [1A_NETBOOKINGS],NETBOOKINGS AS MT_NETBOOKINGS 
				FROM T_MIDTPRODUCTIVITY_AIR DB WITH(NOLOCK)
				--LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO ON DB.LCODE=VO.LCODE
				INNER JOIN LOCATION_MASTER LM WITH(NOLOCK) ON LM.LOCATION_CODE=DB.LCODE
				INNER JOIN AGROUP G WITH(NOLOCK) ON G.CHAIN_CODE=LM.CHAIN_CODE
				LEFT OUTER JOIN T_C_CLASSIFICATION C WITH(NOLOCK) ON G.GroupClassificationID=C.GroupClassificationID
				LEFT OUTER JOIN T_C_TYPE AT ON LM.AGENCYTYPEID=AT.AGENCYTYPEID
				LEFT OUTER JOIN T_G_EMPLOYEES EMP  WITH (NOLOCK)ON LM.RESP_1A=EMP.EMPLOYEEID
				LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO WITH(NOLOCK) ON LM.LOCATION_CODE=VO.LCODE
				LEFT OUTER JOIN T_G_GROUP_TYPE GT  WITH(NOLOCK) ON G.GROUPTYPEID=GT.GROUPTYPEID
			WHERE 				
				(@COUNTRY IS NULL OR LM.COUNTRY=@COUNTRY)
				AND (@CITY IS NULL OR LM.CITY=@CITY)
				AND (@LCODE IS NULL OR LM.LOCATION_CODE=@LCODE)
				AND (@AGENCYNAME IS NULL OR LM.NAME LIKE '%' + LTRIM(RTRIM(@AGENCYNAME)) + '%')
				AND (@RESPONSIBLESTAFF IS NULL OR LM.RESP_1A=@RESPONSIBLESTAFF)
				AND (@AGENCYTYPEID IS NULL OR LM.AGENCYTYPEID=@AGENCYTYPEID)
				AND (@AGENCYSTATUSID IS NULL OR LM.AGENCYSTATUSID=@AGENCYSTATUSID)				
				AND (@AOFFICE IS NULL OR LM.AOFFICE=@AOFFICE)								
				AND (@REGION IS NULL OR LM.AOFFICE IN (SELECT AOFFICE FROM BRANCH WITH (NOLOCK) WHERE REGION=@REGION))
				AND (@GROUPTYPEID IS NULL OR GT.GROUPTYPEID=@GROUPTYPEID)				
				AND (@CHAIN_CODE IS NULL OR LM.CHAIN_CODE=@CHAIN_CODE)
				AND (([YEAR]*100)+[MONTH])*100+1 BETWEEN @DATEFROM AND @DATETO
			END			
	 ELSE	
			IF (@1A_TICKET=0)  AND (@DAILYBOOKINGS=0) AND(@1A_PROD=0) AND (@ALLCRS=0) AND (ISNULL(@NIDT,0)=1)
			BEGIN				
				INSERT @A_TKT_BOOKINGS
				(TYPE,LCODE,OFFICEID,[MONTH],[YEAR],[DATE],[TKT_NETBOOKINGS],DB_NETBOOKINGS,[1A_NETBOOKINGS],MT_NETBOOKINGS,CODD,HX_BOOKINGS)
				SELECT 'E',DB.LCODE,DB.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,0 AS [TKT_NETBOOKINGS],0 AS DB_NETBOOKINGS,0 AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS,CODD,HX_BOOKINGS
				FROM T_INC_NIDT_PRODUCTIVITY_EXPORTED DB WITH(NOLOCK)				
				INNER JOIN LOCATION_MASTER LM WITH(NOLOCK) ON LM.LOCATION_CODE=DB.LCODE
				INNER JOIN AGROUP G WITH(NOLOCK) ON G.CHAIN_CODE=LM.CHAIN_CODE
				LEFT OUTER JOIN T_C_CLASSIFICATION C WITH(NOLOCK) ON G.GroupClassificationID=C.GroupClassificationID
				LEFT OUTER JOIN T_C_TYPE AT ON LM.AGENCYTYPEID=AT.AGENCYTYPEID
				LEFT OUTER JOIN T_G_EMPLOYEES EMP  WITH (NOLOCK)ON LM.RESP_1A=EMP.EMPLOYEEID
				--LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO WITH(NOLOCK) ON LM.LOCATION_CODE=VO.LCODE
				LEFT OUTER JOIN T_G_GROUP_TYPE GT  WITH(NOLOCK) ON G.GROUPTYPEID=GT.GROUPTYPEID
			WHERE 				
				(@COUNTRY IS NULL OR LM.COUNTRY=@COUNTRY)
				AND (@CITY IS NULL OR LM.CITY=@CITY)
				AND (@LCODE IS NULL OR LM.LOCATION_CODE=@LCODE)
				AND (@AGENCYNAME IS NULL OR LM.NAME LIKE '%' + LTRIM(RTRIM(@AGENCYNAME)) + '%')
				AND (@RESPONSIBLESTAFF IS NULL OR LM.RESP_1A=@RESPONSIBLESTAFF)
				AND (@AGENCYTYPEID IS NULL OR LM.AGENCYTYPEID=@AGENCYTYPEID)
				AND (@AGENCYSTATUSID IS NULL OR LM.AGENCYSTATUSID=@AGENCYSTATUSID)				
				AND (@AOFFICE IS NULL OR LM.AOFFICE=@AOFFICE)								
				AND (@REGION IS NULL OR LM.AOFFICE IN (SELECT AOFFICE FROM BRANCH WITH (NOLOCK) WHERE REGION=@REGION))
				AND (@GROUPTYPEID IS NULL OR GT.GROUPTYPEID=@GROUPTYPEID)	
				AND (@CHAIN_CODE IS NULL OR LM.CHAIN_CODE=@CHAIN_CODE)			
				AND (([YEAR]*100)+[MONTH])*100+1 BETWEEN @DATEFROM AND @DATETO

			END
		ELSE 	--MULTI -2
			IF (@1A_TICKET=1)  AND (@DAILYBOOKINGS=1) AND(@1A_PROD=0) AND (@ALLCRS=0) AND (ISNULL(@NIDT,0)=0)
				BEGIN							
						INSERT @A_TKT_BOOKINGS
						(TYPE,LCODE,OFFICEID,
						[MONTH],[YEAR],[DATE],[TKT_NETBOOKINGS],DB_NETBOOKINGS,[1A_NETBOOKINGS],MT_NETBOOKINGS)
						SELECT 'F',DB.LCODE,DB.OFFICEID,DB.[MONTH],DB.[YEAR],DB.[DATE],DB.[TKT_NETBOOKINGS],DB.DB_NETBOOKINGS,DB.[1A_NETBOOKINGS],DB.MT_NETBOOKINGS FROM(
							SELECT T.LCODE,T.OFFICEID,
							SUBSTRING(CAST(DATE AS VARCHAR),5,2) AS [MONTH],LEFT(DATE,4) AS [YEAR],
							[DATE],[TKT_NETBOOKINGS]=ISS_E_TKT,0 AS DB_NETBOOKINGS,0 AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS 
							FROM 	T_C_1A_TICKET_BOOKINGS T WITH(NOLOCK)
						UNION ALL
							SELECT DB.LCODE,VO.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1, 0 AS [TKT_NETBOOKINGS],NETBOOKINGS,0 AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS
							FROM T_C_1A_DAILY_BOOKINGS DB WITH(NOLOCK)
							LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO ON DB.LCODE=VO.LCODE	) AS DB			
							INNER JOIN LOCATION_MASTER LM WITH(NOLOCK) ON LM.LOCATION_CODE=DB.LCODE
							INNER JOIN AGROUP G WITH(NOLOCK) ON G.CHAIN_CODE=LM.CHAIN_CODE
							LEFT OUTER JOIN T_C_CLASSIFICATION C WITH(NOLOCK) ON G.GroupClassificationID=C.GroupClassificationID
							LEFT OUTER JOIN T_C_TYPE AT ON LM.AGENCYTYPEID=AT.AGENCYTYPEID
							LEFT OUTER JOIN T_G_EMPLOYEES EMP  WITH (NOLOCK)ON LM.RESP_1A=EMP.EMPLOYEEID
							LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO WITH(NOLOCK) ON LM.LOCATION_CODE=VO.LCODE
							LEFT OUTER JOIN T_G_GROUP_TYPE GT  WITH(NOLOCK) ON G.GROUPTYPEID=GT.GROUPTYPEID
						WHERE 				
							(@COUNTRY IS NULL OR LM.COUNTRY=@COUNTRY)
							AND (@CITY IS NULL OR LM.CITY=@CITY)
							AND (@LCODE IS NULL OR LM.LOCATION_CODE=@LCODE)
							AND (@AGENCYNAME IS NULL OR LM.NAME LIKE '%' + LTRIM(RTRIM(@AGENCYNAME)) + '%')
							AND (@RESPONSIBLESTAFF IS NULL OR LM.RESP_1A=@RESPONSIBLESTAFF)
							AND (@AGENCYTYPEID IS NULL OR LM.AGENCYTYPEID=@AGENCYTYPEID)
							AND (@AGENCYSTATUSID IS NULL OR LM.AGENCYSTATUSID=@AGENCYSTATUSID)				
							AND (@AOFFICE IS NULL OR LM.AOFFICE=@AOFFICE)								
							AND (@REGION IS NULL OR LM.AOFFICE IN (SELECT AOFFICE FROM BRANCH WITH (NOLOCK) WHERE REGION=@REGION))
							AND (@GROUPTYPEID IS NULL OR GT.GROUPTYPEID=@GROUPTYPEID)				
							AND (@CHAIN_CODE IS NULL OR LM.CHAIN_CODE=@CHAIN_CODE)
							AND DB.DATE BETWEEN @DATEFROM AND @DATETO
				END	
		ELSE					
			IF (@1A_TICKET=1)  AND (@DAILYBOOKINGS=0) AND(@1A_PROD=1) AND (@ALLCRS=0) AND (ISNULL(@NIDT,0)=0)
				BEGIN
						INSERT @A_TKT_BOOKINGS
						(TYPE,LCODE,OFFICEID,
						[MONTH],[YEAR],[DATE],[TKT_NETBOOKINGS],DB_NETBOOKINGS,[1A_NETBOOKINGS],MT_NETBOOKINGS)
						SELECT 'G',DB.LCODE,DB.OFFICEID,DB.[MONTH],DB.[YEAR],DB.[DATE],DB.[TKT_NETBOOKINGS],DB.DB_NETBOOKINGS,DB.[1A_NETBOOKINGS],DB.MT_NETBOOKINGS 
						FROM(
							SELECT T.LCODE,T.OFFICEID,
							SUBSTRING(CAST(DATE AS VARCHAR),5,2) AS [MONTH],LEFT(DATE,4) AS [YEAR],
							[DATE],[TKT_NETBOOKINGS]=ISS_E_TKT,0 AS DB_NETBOOKINGS,0 AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS 
							FROM 	T_C_1A_TICKET_BOOKINGS T WITH(NOLOCK)
						UNION ALL
							SELECT LCODE,OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,0 AS [TKT_NETBOOKINGS],0 AS DB_NETBOOKINGS,NETBOOKINGS AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS
							FROM T_C_AIR_BOOKINGS  WITH(NOLOCK)
							WHERE ACCESS_LEVEL<>'PB'
							) AS DB			
							INNER JOIN LOCATION_MASTER LM WITH(NOLOCK) ON LM.LOCATION_CODE=DB.LCODE
							INNER JOIN AGROUP G WITH(NOLOCK) ON G.CHAIN_CODE=LM.CHAIN_CODE
							LEFT OUTER JOIN T_C_CLASSIFICATION C WITH(NOLOCK) ON G.GroupClassificationID=C.GroupClassificationID
							LEFT OUTER JOIN T_C_TYPE AT ON LM.AGENCYTYPEID=AT.AGENCYTYPEID
							LEFT OUTER JOIN T_G_EMPLOYEES EMP  WITH (NOLOCK)ON LM.RESP_1A=EMP.EMPLOYEEID
							LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO WITH(NOLOCK) ON LM.LOCATION_CODE=VO.LCODE
							LEFT OUTER JOIN T_G_GROUP_TYPE GT  WITH(NOLOCK) ON G.GROUPTYPEID=GT.GROUPTYPEID
						WHERE 				
							(@COUNTRY IS NULL OR LM.COUNTRY=@COUNTRY)
							AND (@CITY IS NULL OR LM.CITY=@CITY)
							AND (@LCODE IS NULL OR LM.LOCATION_CODE=@LCODE)
							AND (@AGENCYNAME IS NULL OR LM.NAME LIKE '%' + LTRIM(RTRIM(@AGENCYNAME)) + '%')
							AND (@RESPONSIBLESTAFF IS NULL OR LM.RESP_1A=@RESPONSIBLESTAFF)
							AND (@AGENCYTYPEID IS NULL OR LM.AGENCYTYPEID=@AGENCYTYPEID)
							AND (@AGENCYSTATUSID IS NULL OR LM.AGENCYSTATUSID=@AGENCYSTATUSID)				
							AND (@AOFFICE IS NULL OR LM.AOFFICE=@AOFFICE)								
							AND (@REGION IS NULL OR LM.AOFFICE IN (SELECT AOFFICE FROM BRANCH WITH (NOLOCK) WHERE REGION=@REGION))
							AND (@GROUPTYPEID IS NULL OR GT.GROUPTYPEID=@GROUPTYPEID)				
							AND (@CHAIN_CODE IS NULL OR LM.CHAIN_CODE=@CHAIN_CODE)
							AND (([YEAR]*100)+[MONTH])*100+1 BETWEEN @DATEFROM AND @DATETO							
				END					
		ELSE
			IF (@1A_TICKET=1)  AND (@DAILYBOOKINGS=0) AND(@1A_PROD=0) AND (@ALLCRS=1) AND (ISNULL(@NIDT,0)=0)
				BEGIN
						
						INSERT @A_TKT_BOOKINGS
						(TYPE,LCODE,OFFICEID,
						[MONTH],[YEAR],[DATE],[TKT_NETBOOKINGS],DB_NETBOOKINGS,[1A_NETBOOKINGS],MT_NETBOOKINGS)
						SELECT 'H',DB.LCODE,DB.OFFICEID,DB.[MONTH],DB.[YEAR],DB.[DATE],DB.[TKT_NETBOOKINGS],DB.DB_NETBOOKINGS,DB.[1A_NETBOOKINGS],DB.MT_NETBOOKINGS 
						FROM(
							SELECT T.LCODE,T.OFFICEID,
							SUBSTRING(CAST(DATE AS VARCHAR),5,2) AS [MONTH],LEFT(DATE,4) AS [YEAR],
							[DATE],[TKT_NETBOOKINGS]=ISS_E_TKT,0 AS DB_NETBOOKINGS,0 AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS 
							FROM 	T_C_1A_TICKET_BOOKINGS T WITH(NOLOCK)
						UNION ALL
							SELECT DB.LCODE,VO.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,0 AS [TKT_NETBOOKINGS],0 AS DB_NETBOOKINGS,0 AS [1A_NETBOOKINGS],NETBOOKINGS AS MT_NETBOOKINGS FROM T_MIDTPRODUCTIVITY_AIR DB WITH(NOLOCK)
							LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO ON DB.LCODE=VO.LCODE			
						) AS DB			
							INNER JOIN LOCATION_MASTER LM WITH(NOLOCK) ON LM.LOCATION_CODE=DB.LCODE
							INNER JOIN AGROUP G WITH(NOLOCK) ON G.CHAIN_CODE=LM.CHAIN_CODE
							LEFT OUTER JOIN T_C_CLASSIFICATION C WITH(NOLOCK) ON G.GroupClassificationID=C.GroupClassificationID
							LEFT OUTER JOIN T_C_TYPE AT ON LM.AGENCYTYPEID=AT.AGENCYTYPEID
							LEFT OUTER JOIN T_G_EMPLOYEES EMP  WITH (NOLOCK)ON LM.RESP_1A=EMP.EMPLOYEEID
							LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO WITH(NOLOCK) ON LM.LOCATION_CODE=VO.LCODE
							LEFT OUTER JOIN T_G_GROUP_TYPE GT  WITH(NOLOCK) ON G.GROUPTYPEID=GT.GROUPTYPEID
						WHERE 				
							(@COUNTRY IS NULL OR LM.COUNTRY=@COUNTRY)
							AND (@CITY IS NULL OR LM.CITY=@CITY)
							AND (@LCODE IS NULL OR LM.LOCATION_CODE=@LCODE)
							AND (@AGENCYNAME IS NULL OR LM.NAME LIKE '%' + LTRIM(RTRIM(@AGENCYNAME)) + '%')
							AND (@RESPONSIBLESTAFF IS NULL OR LM.RESP_1A=@RESPONSIBLESTAFF)
							AND (@AGENCYTYPEID IS NULL OR LM.AGENCYTYPEID=@AGENCYTYPEID)
							AND (@AGENCYSTATUSID IS NULL OR LM.AGENCYSTATUSID=@AGENCYSTATUSID)				
							AND (@AOFFICE IS NULL OR LM.AOFFICE=@AOFFICE)								
							AND (@REGION IS NULL OR LM.AOFFICE IN (SELECT AOFFICE FROM BRANCH WITH (NOLOCK) WHERE REGION=@REGION))
							AND (@GROUPTYPEID IS NULL OR GT.GROUPTYPEID=@GROUPTYPEID)				
							AND (@CHAIN_CODE IS NULL OR LM.CHAIN_CODE=@CHAIN_CODE)
							AND DB.[DATE] BETWEEN @DATEFROM AND @DATETO							
				END		
		ELSE
			IF (@1A_TICKET=1)  AND (@DAILYBOOKINGS=0) AND(@1A_PROD=0) AND (@ALLCRS=0) AND (ISNULL(@NIDT,0)=1)
				BEGIN						
					INSERT @A_TKT_BOOKINGS
					(TYPE,LCODE,OFFICEID,
					[MONTH],[YEAR],[DATE],[TKT_NETBOOKINGS],DB_NETBOOKINGS,[1A_NETBOOKINGS],MT_NETBOOKINGS,CODD,HX_BOOKINGS)
					SELECT 'I',DB.LCODE,DB.OFFICEID,DB.[MONTH],DB.[YEAR],DB.[DATE],DB.[TKT_NETBOOKINGS],DB.DB_NETBOOKINGS,DB.[1A_NETBOOKINGS],DB.MT_NETBOOKINGS,DB.CODD,DB.HX_BOOKINGS 
					FROM(
						SELECT T.LCODE,T.OFFICEID,
						SUBSTRING(CAST(DATE AS VARCHAR),5,2) AS [MONTH],LEFT(DATE,4) AS [YEAR],[DATE],
							[TKT_NETBOOKINGS]=ISS_E_TKT,
							0 AS DB_NETBOOKINGS,
							0 AS [1A_NETBOOKINGS],
							0 AS MT_NETBOOKINGS,
							0 AS CODD,
							0 AS HX_BOOKINGS
						FROM 	T_C_1A_TICKET_BOOKINGS T WITH(NOLOCK)
					UNION ALL
						SELECT DB.LCODE,DB.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,
							0 AS [TKT_NETBOOKINGS],
							0 AS DB_NETBOOKINGS,
							0 AS [1A_NETBOOKINGS],
							0 AS MT_NETBOOKINGS,
							CODD,
							HX_BOOKINGS
						FROM T_INC_NIDT_PRODUCTIVITY_EXPORTED DB WITH(NOLOCK) )AS DB
					
					INNER JOIN LOCATION_MASTER LM WITH(NOLOCK) ON LM.LOCATION_CODE=DB.LCODE
					INNER JOIN AGROUP G WITH(NOLOCK) ON G.CHAIN_CODE=LM.CHAIN_CODE
					LEFT OUTER JOIN T_C_CLASSIFICATION C WITH(NOLOCK) ON G.GroupClassificationID=C.GroupClassificationID
					LEFT OUTER JOIN T_C_TYPE AT ON LM.AGENCYTYPEID=AT.AGENCYTYPEID
					LEFT OUTER JOIN T_G_EMPLOYEES EMP  WITH (NOLOCK)ON LM.RESP_1A=EMP.EMPLOYEEID
					--LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO WITH(NOLOCK) ON LM.LOCATION_CODE=VO.LCODE
					LEFT OUTER JOIN T_G_GROUP_TYPE GT  WITH(NOLOCK) ON G.GROUPTYPEID=GT.GROUPTYPEID
				WHERE 				
					(@COUNTRY IS NULL OR LM.COUNTRY=@COUNTRY)
					AND (@CITY IS NULL OR LM.CITY=@CITY)
					AND (@LCODE IS NULL OR LM.LOCATION_CODE=@LCODE)
					AND (@AGENCYNAME IS NULL OR LM.NAME LIKE '%' + LTRIM(RTRIM(@AGENCYNAME)) + '%')
					AND (@RESPONSIBLESTAFF IS NULL OR LM.RESP_1A=@RESPONSIBLESTAFF)
					AND (@AGENCYTYPEID IS NULL OR LM.AGENCYTYPEID=@AGENCYTYPEID)
					AND (@AGENCYSTATUSID IS NULL OR LM.AGENCYSTATUSID=@AGENCYSTATUSID)				
					AND (@AOFFICE IS NULL OR LM.AOFFICE=@AOFFICE)								
					AND (@REGION IS NULL OR LM.AOFFICE IN (SELECT AOFFICE FROM BRANCH WITH (NOLOCK) WHERE REGION=@REGION))
					AND (@GROUPTYPEID IS NULL OR GT.GROUPTYPEID=@GROUPTYPEID)				
					AND (@CHAIN_CODE IS NULL OR LM.CHAIN_CODE=@CHAIN_CODE)
					AND (([YEAR]*100)+[MONTH])*100+1 BETWEEN @DATEFROM AND @DATETO
				END	
/*ADDED*/
		ELSE
			IF (@1A_TICKET=0)  AND (@DAILYBOOKINGS=1) AND(@1A_PROD=1) AND (@ALLCRS=0) AND (ISNULL(@NIDT,0)=0)
				BEGIN
					INSERT @A_TKT_BOOKINGS
					(TYPE,LCODE,OFFICEID,
					[MONTH],[YEAR],[DATE],[TKT_NETBOOKINGS],DB_NETBOOKINGS,[1A_NETBOOKINGS],MT_NETBOOKINGS)
					SELECT 'J',DB.LCODE,DB.OFFICEID,DB.[MONTH],DB.[YEAR],DB.[DATE],DB.[TKT_NETBOOKINGS],DB.DB_NETBOOKINGS,DB.[1A_NETBOOKINGS],DB.MT_NETBOOKINGS
					FROM(
						SELECT DB.LCODE,VO.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,0 AS [TKT_NETBOOKINGS],NETBOOKINGS as DB_NETBOOKINGS,0 AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS
						FROM T_C_1A_DAILY_BOOKINGS DB WITH(NOLOCK)
						LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO ON DB.LCODE=VO.LCODE
					UNION ALL
						SELECT LCODE,OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,0 AS [TKT_NETBOOKINGS],0 AS DB_NETBOOKINGS,NETBOOKINGS AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS
						FROM T_C_AIR_BOOKINGS  WITH(NOLOCK)
						WHERE ACCESS_LEVEL<>'PB' )AS DB					
					INNER JOIN LOCATION_MASTER LM WITH(NOLOCK) ON LM.LOCATION_CODE=DB.LCODE
					INNER JOIN AGROUP G WITH(NOLOCK) ON G.CHAIN_CODE=LM.CHAIN_CODE
					LEFT OUTER JOIN T_C_CLASSIFICATION C WITH(NOLOCK) ON G.GroupClassificationID=C.GroupClassificationID
					LEFT OUTER JOIN T_C_TYPE AT ON LM.AGENCYTYPEID=AT.AGENCYTYPEID
					LEFT OUTER JOIN T_G_EMPLOYEES EMP  WITH (NOLOCK)ON LM.RESP_1A=EMP.EMPLOYEEID
					--LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO WITH(NOLOCK) ON LM.LOCATION_CODE=VO.LCODE
					LEFT OUTER JOIN T_G_GROUP_TYPE GT  WITH(NOLOCK) ON G.GROUPTYPEID=GT.GROUPTYPEID
				WHERE 				
					(@COUNTRY IS NULL OR LM.COUNTRY=@COUNTRY)
					AND (@CITY IS NULL OR LM.CITY=@CITY)
					AND (@LCODE IS NULL OR LM.LOCATION_CODE=@LCODE)
					AND (@AGENCYNAME IS NULL OR LM.NAME LIKE '%' + LTRIM(RTRIM(@AGENCYNAME)) + '%')
					AND (@RESPONSIBLESTAFF IS NULL OR LM.RESP_1A=@RESPONSIBLESTAFF)
					AND (@AGENCYTYPEID IS NULL OR LM.AGENCYTYPEID=@AGENCYTYPEID)
					AND (@AGENCYSTATUSID IS NULL OR LM.AGENCYSTATUSID=@AGENCYSTATUSID)				
					AND (@AOFFICE IS NULL OR LM.AOFFICE=@AOFFICE)								
					AND (@REGION IS NULL OR LM.AOFFICE IN (SELECT AOFFICE FROM BRANCH WITH (NOLOCK) WHERE REGION=@REGION))
					AND (@GROUPTYPEID IS NULL OR GT.GROUPTYPEID=@GROUPTYPEID)				
					AND (@CHAIN_CODE IS NULL OR LM.CHAIN_CODE=@CHAIN_CODE)
					AND (([YEAR]*100)+[MONTH])*100+1 BETWEEN @DATEFROM AND @DATETO
				END
		ELSE
			IF (@1A_TICKET=0)  AND (@DAILYBOOKINGS=1) AND(@1A_PROD=0) AND (@ALLCRS=1) AND (ISNULL(@NIDT,0)=0)
				BEGIN
					INSERT @A_TKT_BOOKINGS
					(TYPE,LCODE,OFFICEID,
					[MONTH],[YEAR],[DATE],[TKT_NETBOOKINGS],DB_NETBOOKINGS,[1A_NETBOOKINGS],MT_NETBOOKINGS)
					SELECT 'K',DB.LCODE,DB.OFFICEID,DB.[MONTH],DB.[YEAR],DB.[DATE],DB.[TKT_NETBOOKINGS],DB.DB_NETBOOKINGS,DB.[1A_NETBOOKINGS],DB.MT_NETBOOKINGS
					FROM(
						SELECT DB.LCODE,VO.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,0 AS [TKT_NETBOOKINGS],NETBOOKINGS as DB_NETBOOKINGS,0 AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS
						FROM T_C_1A_DAILY_BOOKINGS DB WITH(NOLOCK)
						LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO ON DB.LCODE=VO.LCODE
					UNION ALL
						SELECT DB.LCODE,VO.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,0 AS [TKT_NETBOOKINGS],0 AS DB_NETBOOKINGS,0 AS [1A_NETBOOKINGS],NETBOOKINGS AS MT_NETBOOKINGS 
						FROM T_MIDTPRODUCTIVITY_AIR DB WITH(NOLOCK)
						LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO ON DB.LCODE=VO.LCODE
					)AS DB					
					INNER JOIN LOCATION_MASTER LM WITH(NOLOCK) ON LM.LOCATION_CODE=DB.LCODE
					INNER JOIN AGROUP G WITH(NOLOCK) ON G.CHAIN_CODE=LM.CHAIN_CODE
					LEFT OUTER JOIN T_C_CLASSIFICATION C WITH(NOLOCK) ON G.GroupClassificationID=C.GroupClassificationID
					LEFT OUTER JOIN T_C_TYPE AT ON LM.AGENCYTYPEID=AT.AGENCYTYPEID
					LEFT OUTER JOIN T_G_EMPLOYEES EMP  WITH (NOLOCK)ON LM.RESP_1A=EMP.EMPLOYEEID
					--LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO WITH(NOLOCK) ON LM.LOCATION_CODE=VO.LCODE
					LEFT OUTER JOIN T_G_GROUP_TYPE GT  WITH(NOLOCK) ON G.GROUPTYPEID=GT.GROUPTYPEID
				WHERE 				
					(@COUNTRY IS NULL OR LM.COUNTRY=@COUNTRY)
					AND (@CITY IS NULL OR LM.CITY=@CITY)
					AND (@LCODE IS NULL OR LM.LOCATION_CODE=@LCODE)
					AND (@AGENCYNAME IS NULL OR LM.NAME LIKE '%' + LTRIM(RTRIM(@AGENCYNAME)) + '%')
					AND (@RESPONSIBLESTAFF IS NULL OR LM.RESP_1A=@RESPONSIBLESTAFF)
					AND (@AGENCYTYPEID IS NULL OR LM.AGENCYTYPEID=@AGENCYTYPEID)
					AND (@AGENCYSTATUSID IS NULL OR LM.AGENCYSTATUSID=@AGENCYSTATUSID)				
					AND (@AOFFICE IS NULL OR LM.AOFFICE=@AOFFICE)								
					AND (@REGION IS NULL OR LM.AOFFICE IN (SELECT AOFFICE FROM BRANCH WITH (NOLOCK) WHERE REGION=@REGION))
					AND (@GROUPTYPEID IS NULL OR GT.GROUPTYPEID=@GROUPTYPEID)				
					AND (@CHAIN_CODE IS NULL OR LM.CHAIN_CODE=@CHAIN_CODE)
					AND (([YEAR]*100)+[MONTH])*100+1 BETWEEN @DATEFROM AND @DATETO
				END
		ELSE
			IF (@1A_TICKET=0)  AND (@DAILYBOOKINGS=1) AND(@1A_PROD=0) AND (@ALLCRS=0) AND (ISNULL(@NIDT,0)=1)
				BEGIN
					INSERT @A_TKT_BOOKINGS
					(TYPE,LCODE,OFFICEID,
					[MONTH],[YEAR],[DATE],[TKT_NETBOOKINGS],DB_NETBOOKINGS,[1A_NETBOOKINGS],MT_NETBOOKINGS,CODD,HX_BOOKINGS)
					SELECT 'L',DB.LCODE,DB.OFFICEID,DB.[MONTH],DB.[YEAR],DB.[DATE],DB.[TKT_NETBOOKINGS],DB.DB_NETBOOKINGS,DB.[1A_NETBOOKINGS],DB.MT_NETBOOKINGS,DB.CODD,DB.HX_BOOKINGS
					FROM(
						SELECT DB.LCODE,VO.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,
							0 AS [TKT_NETBOOKINGS],
							NETBOOKINGS as DB_NETBOOKINGS,
							0 AS [1A_NETBOOKINGS],
							0 AS MT_NETBOOKINGS,
							0 as CODD,
							0 as HX_BOOKINGS
						FROM T_C_1A_DAILY_BOOKINGS DB WITH(NOLOCK)
						LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO ON DB.LCODE=VO.LCODE
					UNION ALL
						SELECT DB.LCODE,DB.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,
							0 AS [TKT_NETBOOKINGS],
							0 AS DB_NETBOOKINGS,
							0 AS [1A_NETBOOKINGS],
							0 AS MT_NETBOOKINGS,
							CODD,
							HX_BOOKINGS
						FROM T_INC_NIDT_PRODUCTIVITY_EXPORTED DB WITH(NOLOCK)	

					)AS DB					
					INNER JOIN LOCATION_MASTER LM WITH(NOLOCK) ON LM.LOCATION_CODE=DB.LCODE
					INNER JOIN AGROUP G WITH(NOLOCK) ON G.CHAIN_CODE=LM.CHAIN_CODE
					LEFT OUTER JOIN T_C_CLASSIFICATION C WITH(NOLOCK) ON G.GroupClassificationID=C.GroupClassificationID
					LEFT OUTER JOIN T_C_TYPE AT ON LM.AGENCYTYPEID=AT.AGENCYTYPEID
					LEFT OUTER JOIN T_G_EMPLOYEES EMP  WITH (NOLOCK)ON LM.RESP_1A=EMP.EMPLOYEEID
					--LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO WITH(NOLOCK) ON LM.LOCATION_CODE=VO.LCODE
					LEFT OUTER JOIN T_G_GROUP_TYPE GT  WITH(NOLOCK) ON G.GROUPTYPEID=GT.GROUPTYPEID
				WHERE 				
					(@COUNTRY IS NULL OR LM.COUNTRY=@COUNTRY)
					AND (@CITY IS NULL OR LM.CITY=@CITY)
					AND (@LCODE IS NULL OR LM.LOCATION_CODE=@LCODE)
					AND (@AGENCYNAME IS NULL OR LM.NAME LIKE '%' + LTRIM(RTRIM(@AGENCYNAME)) + '%')
					AND (@RESPONSIBLESTAFF IS NULL OR LM.RESP_1A=@RESPONSIBLESTAFF)
					AND (@AGENCYTYPEID IS NULL OR LM.AGENCYTYPEID=@AGENCYTYPEID)
					AND (@AGENCYSTATUSID IS NULL OR LM.AGENCYSTATUSID=@AGENCYSTATUSID)				
					AND (@AOFFICE IS NULL OR LM.AOFFICE=@AOFFICE)								
					AND (@REGION IS NULL OR LM.AOFFICE IN (SELECT AOFFICE FROM BRANCH WITH (NOLOCK) WHERE REGION=@REGION))
					AND (@GROUPTYPEID IS NULL OR GT.GROUPTYPEID=@GROUPTYPEID)		
					AND (@CHAIN_CODE IS NULL OR LM.CHAIN_CODE=@CHAIN_CODE)		
					AND (([YEAR]*100)+[MONTH])*100+1 BETWEEN @DATEFROM AND @DATETO
				END
		ELSE
			IF (@1A_TICKET=0)  AND (@DAILYBOOKINGS=0) AND(@1A_PROD=1) AND (@ALLCRS=1) AND (ISNULL(@NIDT,0)=0)
				BEGIN
					INSERT @A_TKT_BOOKINGS
					(TYPE,LCODE,OFFICEID,
					[MONTH],[YEAR],[DATE],[TKT_NETBOOKINGS],DB_NETBOOKINGS,[1A_NETBOOKINGS],MT_NETBOOKINGS,CODD,HX_BOOKINGS)
					SELECT 'M',DB.LCODE,DB.OFFICEID,DB.[MONTH],DB.[YEAR],DB.[DATE],DB.[TKT_NETBOOKINGS],DB.DB_NETBOOKINGS,DB.[1A_NETBOOKINGS],DB.MT_NETBOOKINGS,DB.CODD,DB.HX_BOOKINGS
					FROM(
						SELECT LCODE,OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,
							0 AS [TKT_NETBOOKINGS],
							0 AS DB_NETBOOKINGS,
							NETBOOKINGS AS [1A_NETBOOKINGS],
							0 AS MT_NETBOOKINGS,
							0 AS CODD,
							0 AS HX_BOOKINGS
						FROM T_C_AIR_BOOKINGS  WITH(NOLOCK)
						WHERE ACCESS_LEVEL<>'PB'
					UNION ALL
						SELECT DB.LCODE,VO.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,
							0 AS [TKT_NETBOOKINGS],
							0 AS DB_NETBOOKINGS,
							0 AS [1A_NETBOOKINGS],
							NETBOOKINGS AS MT_NETBOOKINGS, 
							0 AS CODD,
							0 AS HX_BOOKINGS
							FROM T_MIDTPRODUCTIVITY_AIR DB WITH(NOLOCK)
						LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO ON DB.LCODE=VO.LCODE								
					)AS DB					
					INNER JOIN LOCATION_MASTER LM WITH(NOLOCK) ON LM.LOCATION_CODE=DB.LCODE
					INNER JOIN AGROUP G WITH(NOLOCK) ON G.CHAIN_CODE=LM.CHAIN_CODE
					LEFT OUTER JOIN T_C_CLASSIFICATION C WITH(NOLOCK) ON G.GroupClassificationID=C.GroupClassificationID
					LEFT OUTER JOIN T_C_TYPE AT ON LM.AGENCYTYPEID=AT.AGENCYTYPEID
					LEFT OUTER JOIN T_G_EMPLOYEES EMP  WITH (NOLOCK)ON LM.RESP_1A=EMP.EMPLOYEEID
					--LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO WITH(NOLOCK) ON LM.LOCATION_CODE=VO.LCODE
					LEFT OUTER JOIN T_G_GROUP_TYPE GT  WITH(NOLOCK) ON G.GROUPTYPEID=GT.GROUPTYPEID
				WHERE 				
					(@COUNTRY IS NULL OR LM.COUNTRY=@COUNTRY)
					AND (@CITY IS NULL OR LM.CITY=@CITY)
					AND (@LCODE IS NULL OR LM.LOCATION_CODE=@LCODE)
					AND (@AGENCYNAME IS NULL OR LM.NAME LIKE '%' + LTRIM(RTRIM(@AGENCYNAME)) + '%')
					AND (@RESPONSIBLESTAFF IS NULL OR LM.RESP_1A=@RESPONSIBLESTAFF)
					AND (@AGENCYTYPEID IS NULL OR LM.AGENCYTYPEID=@AGENCYTYPEID)
					AND (@AGENCYSTATUSID IS NULL OR LM.AGENCYSTATUSID=@AGENCYSTATUSID)				
					AND (@AOFFICE IS NULL OR LM.AOFFICE=@AOFFICE)								
					AND (@REGION IS NULL OR LM.AOFFICE IN (SELECT AOFFICE FROM BRANCH WITH (NOLOCK) WHERE REGION=@REGION))
					AND (@GROUPTYPEID IS NULL OR GT.GROUPTYPEID=@GROUPTYPEID)
					AND (@CHAIN_CODE IS NULL OR LM.CHAIN_CODE=@CHAIN_CODE)				
					AND (([YEAR]*100)+[MONTH])*100+1 BETWEEN @DATEFROM AND @DATETO

				END
		ELSE
			IF (@1A_TICKET=0)  AND (@DAILYBOOKINGS=0) AND(@1A_PROD=1) AND (@ALLCRS=0) AND (ISNULL(@NIDT,0)=1)
				BEGIN
					INSERT @A_TKT_BOOKINGS
					(TYPE,LCODE,OFFICEID,
					[MONTH],[YEAR],[DATE],[TKT_NETBOOKINGS],DB_NETBOOKINGS,[1A_NETBOOKINGS],MT_NETBOOKINGS,CODD,HX_BOOKINGS)
					SELECT 'N',DB.LCODE,DB.OFFICEID,DB.[MONTH],DB.[YEAR],DB.[DATE],DB.[TKT_NETBOOKINGS],DB.DB_NETBOOKINGS,DB.[1A_NETBOOKINGS],DB.MT_NETBOOKINGS,DB.CODD,DB.HX_BOOKINGS
					FROM(
						SELECT LCODE,OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,
								0 AS [TKT_NETBOOKINGS],
								0 AS DB_NETBOOKINGS,
								NETBOOKINGS AS [1A_NETBOOKINGS],
								0 AS MT_NETBOOKINGS,
								0 AS CODD,
								0 AS HX_BOOKINGS
						FROM T_C_AIR_BOOKINGS  WITH(NOLOCK)
						WHERE ACCESS_LEVEL<>'PB'
					UNION ALL
						SELECT DB.LCODE,DB.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,
							0 AS [TKT_NETBOOKINGS],
							0 AS DB_NETBOOKINGS,
							0 AS [1A_NETBOOKINGS],
							0 AS MT_NETBOOKINGS,
							CODD,
							HX_BOOKINGS
						FROM T_INC_NIDT_PRODUCTIVITY_EXPORTED DB WITH(NOLOCK)	

					)AS DB					
					INNER JOIN LOCATION_MASTER LM WITH(NOLOCK) ON LM.LOCATION_CODE=DB.LCODE
					INNER JOIN AGROUP G WITH(NOLOCK) ON G.CHAIN_CODE=LM.CHAIN_CODE
					LEFT OUTER JOIN T_C_CLASSIFICATION C WITH(NOLOCK) ON G.GroupClassificationID=C.GroupClassificationID
					LEFT OUTER JOIN T_C_TYPE AT ON LM.AGENCYTYPEID=AT.AGENCYTYPEID
					LEFT OUTER JOIN T_G_EMPLOYEES EMP  WITH (NOLOCK)ON LM.RESP_1A=EMP.EMPLOYEEID
					--LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO WITH(NOLOCK) ON LM.LOCATION_CODE=VO.LCODE
					LEFT OUTER JOIN T_G_GROUP_TYPE GT  WITH(NOLOCK) ON G.GROUPTYPEID=GT.GROUPTYPEID
				WHERE 				
					(@COUNTRY IS NULL OR LM.COUNTRY=@COUNTRY)
					AND (@CITY IS NULL OR LM.CITY=@CITY)
					AND (@LCODE IS NULL OR LM.LOCATION_CODE=@LCODE)
					AND (@AGENCYNAME IS NULL OR LM.NAME LIKE '%' + LTRIM(RTRIM(@AGENCYNAME)) + '%')
					AND (@RESPONSIBLESTAFF IS NULL OR LM.RESP_1A=@RESPONSIBLESTAFF)
					AND (@AGENCYTYPEID IS NULL OR LM.AGENCYTYPEID=@AGENCYTYPEID)
					AND (@AGENCYSTATUSID IS NULL OR LM.AGENCYSTATUSID=@AGENCYSTATUSID)				
					AND (@AOFFICE IS NULL OR LM.AOFFICE=@AOFFICE)								
					AND (@REGION IS NULL OR LM.AOFFICE IN (SELECT AOFFICE FROM BRANCH WITH (NOLOCK) WHERE REGION=@REGION))
					AND (@GROUPTYPEID IS NULL OR GT.GROUPTYPEID=@GROUPTYPEID)	
					AND (@CHAIN_CODE IS NULL OR LM.CHAIN_CODE=@CHAIN_CODE)			
					AND (([YEAR]*100)+[MONTH])*100+1 BETWEEN @DATEFROM AND @DATETO
				END
		ELSE
			IF (@1A_TICKET=0)  AND (@DAILYBOOKINGS=0) AND(@1A_PROD=0) AND (@ALLCRS=1) AND (ISNULL(@NIDT,0)=1)
				BEGIN
					INSERT @A_TKT_BOOKINGS
					(TYPE,LCODE,OFFICEID,
					[MONTH],[YEAR],[DATE],[TKT_NETBOOKINGS],DB_NETBOOKINGS,[1A_NETBOOKINGS],MT_NETBOOKINGS,CODD,HX_BOOKINGS)
					SELECT 'O',DB.LCODE,DB.OFFICEID,DB.[MONTH],DB.[YEAR],DB.[DATE],DB.[TKT_NETBOOKINGS],DB.DB_NETBOOKINGS,DB.[1A_NETBOOKINGS],DB.MT_NETBOOKINGS,DB.CODD,DB.HX_BOOKINGS
					FROM(
						SELECT DB.LCODE,VO.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,
							0 AS [TKT_NETBOOKINGS],
							0 AS DB_NETBOOKINGS,
							0 AS [1A_NETBOOKINGS],
							NETBOOKINGS AS MT_NETBOOKINGS, 
							0 AS CODD,
							0 AS HX_BOOKINGS
							FROM T_MIDTPRODUCTIVITY_AIR DB WITH(NOLOCK)
						LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO ON DB.LCODE=VO.LCODE			
					UNION ALL
						SELECT DB.LCODE,DB.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,
							0 AS [TKT_NETBOOKINGS],
							0 AS DB_NETBOOKINGS,
							0 AS [1A_NETBOOKINGS],
							0 AS MT_NETBOOKINGS,
							CODD,
							HX_BOOKINGS
						FROM T_INC_NIDT_PRODUCTIVITY_EXPORTED DB WITH(NOLOCK)	
					)AS DB					
					INNER JOIN LOCATION_MASTER LM WITH(NOLOCK) ON LM.LOCATION_CODE=DB.LCODE
					INNER JOIN AGROUP G WITH(NOLOCK) ON G.CHAIN_CODE=LM.CHAIN_CODE
					LEFT OUTER JOIN T_C_CLASSIFICATION C WITH(NOLOCK) ON G.GroupClassificationID=C.GroupClassificationID
					LEFT OUTER JOIN T_C_TYPE AT ON LM.AGENCYTYPEID=AT.AGENCYTYPEID
					LEFT OUTER JOIN T_G_EMPLOYEES EMP  WITH (NOLOCK)ON LM.RESP_1A=EMP.EMPLOYEEID
					--LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO WITH(NOLOCK) ON LM.LOCATION_CODE=VO.LCODE
					LEFT OUTER JOIN T_G_GROUP_TYPE GT  WITH(NOLOCK) ON G.GROUPTYPEID=GT.GROUPTYPEID
				WHERE 				
					(@COUNTRY IS NULL OR LM.COUNTRY=@COUNTRY)
					AND (@CITY IS NULL OR LM.CITY=@CITY)
					AND (@LCODE IS NULL OR LM.LOCATION_CODE=@LCODE)
					AND (@AGENCYNAME IS NULL OR LM.NAME LIKE '%' + LTRIM(RTRIM(@AGENCYNAME)) + '%')
					AND (@RESPONSIBLESTAFF IS NULL OR LM.RESP_1A=@RESPONSIBLESTAFF)
					AND (@AGENCYTYPEID IS NULL OR LM.AGENCYTYPEID=@AGENCYTYPEID)
					AND (@AGENCYSTATUSID IS NULL OR LM.AGENCYSTATUSID=@AGENCYSTATUSID)				
					AND (@AOFFICE IS NULL OR LM.AOFFICE=@AOFFICE)								
					AND (@REGION IS NULL OR LM.AOFFICE IN (SELECT AOFFICE FROM BRANCH WITH (NOLOCK) WHERE REGION=@REGION))
					AND (@GROUPTYPEID IS NULL OR GT.GROUPTYPEID=@GROUPTYPEID)		
					AND (@CHAIN_CODE IS NULL OR LM.CHAIN_CODE=@CHAIN_CODE)		
					AND (([YEAR]*100)+[MONTH])*100+1 BETWEEN @DATEFROM AND @DATETO
				END
		ELSE --MULTI -3
			IF (@1A_TICKET=1)  AND (@DAILYBOOKINGS=1) AND(@1A_PROD=1) AND (@ALLCRS=0) AND (ISNULL(@NIDT,0)=0)
			BEGIN
				INSERT @A_TKT_BOOKINGS
				(TYPE,LCODE,OFFICEID,
				[MONTH],[YEAR],[DATE],[TKT_NETBOOKINGS],DB_NETBOOKINGS,[1A_NETBOOKINGS],MT_NETBOOKINGS,CODD,HX_BOOKINGS)						
				SELECT 'P',DB.LCODE,DB.OFFICEID,DB.[MONTH],DB.[YEAR],DB.[DATE],DB.[TKT_NETBOOKINGS],DB.DB_NETBOOKINGS,DB.[1A_NETBOOKINGS],DB.MT_NETBOOKINGS,DB.CODD,DB.HX_BOOKINGS 
				FROM(
					SELECT T.LCODE,T.OFFICEID,
					SUBSTRING(CAST(DATE AS VARCHAR),5,2) AS [MONTH],LEFT(DATE,4) AS [YEAR],
					[DATE],[TKT_NETBOOKINGS]=ISS_E_TKT,0 AS DB_NETBOOKINGS,0 AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS,0 AS CODD,0 AS HX_BOOKINGS
					FROM 	T_C_1A_TICKET_BOOKINGS T WITH(NOLOCK)
					UNION ALL
					SELECT DB.LCODE,VO.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1, 0 AS [TKT_NETBOOKINGS],NETBOOKINGS,0 AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS,0 AS CODD,0 AS HX_BOOKINGS
					FROM T_C_1A_DAILY_BOOKINGS DB WITH(NOLOCK)
					LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO ON DB.LCODE=VO.LCODE
					UNION ALL
					SELECT LCODE,OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,0 AS [TKT_NETBOOKINGS],0 AS DB_NETBOOKINGS,NETBOOKINGS AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS,0 AS CODD,0 AS HX_BOOKINGS
					FROM T_C_AIR_BOOKINGS  WITH(NOLOCK)
					WHERE ACCESS_LEVEL<>'PB'
--					UNION ALL
--					SELECT DB.LCODE,VO.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,0 AS [TKT_NETBOOKINGS],0 AS DB_NETBOOKINGS,0 AS [1A_NETBOOKINGS],NETBOOKINGS AS MT_NETBOOKINGS,0 AS CODD,0 AS HX_BOOKINGS 
--					FROM T_MIDTPRODUCTIVITY_AIR DB WITH(NOLOCK)
--					LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO ON DB.LCODE=VO.LCODE	
--					UNION ALL
--					SELECT LCODE,OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,0 AS [TKT_NETBOOKINGS],0 AS DB_NETBOOKINGS,0 AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS,CODD,HX_BOOKINGS
--					FROM T_INC_NIDT_PRODUCTIVITY_EXPORTED WITH(NOLOCK)							
				) AS DB			
					INNER JOIN LOCATION_MASTER LM WITH(NOLOCK) ON LM.LOCATION_CODE=DB.LCODE
					INNER JOIN AGROUP G WITH(NOLOCK) ON G.CHAIN_CODE=LM.CHAIN_CODE
					LEFT OUTER JOIN T_C_CLASSIFICATION C WITH(NOLOCK) ON G.GroupClassificationID=C.GroupClassificationID
					LEFT OUTER JOIN T_C_TYPE AT ON LM.AGENCYTYPEID=AT.AGENCYTYPEID
					LEFT OUTER JOIN T_G_EMPLOYEES EMP  WITH (NOLOCK)ON LM.RESP_1A=EMP.EMPLOYEEID
					LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO WITH(NOLOCK) ON LM.LOCATION_CODE=VO.LCODE
					LEFT OUTER JOIN T_G_GROUP_TYPE GT  WITH(NOLOCK) ON G.GROUPTYPEID=GT.GROUPTYPEID
				WHERE 				
					(@COUNTRY IS NULL OR LM.COUNTRY=@COUNTRY)
					AND (@CITY IS NULL OR LM.CITY=@CITY)
					AND (@LCODE IS NULL OR LM.LOCATION_CODE=@LCODE)
					AND (@AGENCYNAME IS NULL OR LM.NAME LIKE '%' + LTRIM(RTRIM(@AGENCYNAME)) + '%')
					AND (@RESPONSIBLESTAFF IS NULL OR LM.RESP_1A=@RESPONSIBLESTAFF)
					AND (@AGENCYTYPEID IS NULL OR LM.AGENCYTYPEID=@AGENCYTYPEID)
					AND (@AGENCYSTATUSID IS NULL OR LM.AGENCYSTATUSID=@AGENCYSTATUSID)				
					AND (@AOFFICE IS NULL OR LM.AOFFICE=@AOFFICE)								
					AND (@REGION IS NULL OR LM.AOFFICE IN (SELECT AOFFICE FROM BRANCH WITH (NOLOCK) WHERE REGION=@REGION))
					AND (@GROUPTYPEID IS NULL OR GT.GROUPTYPEID=@GROUPTYPEID)	
					AND (@CHAIN_CODE IS NULL OR LM.CHAIN_CODE=@CHAIN_CODE)			
					AND DB.[DATE] BETWEEN @DATEFROM AND @DATETO
			END
		ELSE
			IF (@1A_TICKET=1)  AND (@DAILYBOOKINGS=1) AND(@1A_PROD=0) AND (@ALLCRS=1) AND (ISNULL(@NIDT,0)=0)
			BEGIN
				INSERT @A_TKT_BOOKINGS
				(TYPE,LCODE,OFFICEID,
				[MONTH],[YEAR],[DATE],[TKT_NETBOOKINGS],DB_NETBOOKINGS,[1A_NETBOOKINGS],MT_NETBOOKINGS,CODD,HX_BOOKINGS)						
				SELECT 'Q',DB.LCODE,DB.OFFICEID,DB.[MONTH],DB.[YEAR],DB.[DATE],DB.[TKT_NETBOOKINGS],DB.DB_NETBOOKINGS,DB.[1A_NETBOOKINGS],DB.MT_NETBOOKINGS,DB.CODD,DB.HX_BOOKINGS 
				FROM(
					SELECT T.LCODE,T.OFFICEID,
					SUBSTRING(CAST(DATE AS VARCHAR),5,2) AS [MONTH],LEFT(DATE,4) AS [YEAR],
					[DATE],[TKT_NETBOOKINGS]=ISS_E_TKT,0 AS DB_NETBOOKINGS,0 AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS,0 AS CODD,0 AS HX_BOOKINGS
					FROM 	T_C_1A_TICKET_BOOKINGS T WITH(NOLOCK)
					UNION ALL
					SELECT DB.LCODE,VO.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1, 0 AS [TKT_NETBOOKINGS],NETBOOKINGS,0 AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS,0 AS CODD,0 AS HX_BOOKINGS
					FROM T_C_1A_DAILY_BOOKINGS DB WITH(NOLOCK)
					LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO ON DB.LCODE=VO.LCODE
--					UNION ALL
--					SELECT LCODE,OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,0 AS [TKT_NETBOOKINGS],0 AS DB_NETBOOKINGS,NETBOOKINGS AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS,0 AS CODD,0 AS HX_BOOKINGS
--					FROM T_C_AIR_BOOKINGS  WITH(NOLOCK)
--					WHERE ACCESS_LEVEL<>'PB'
					UNION ALL
					SELECT DB.LCODE,VO.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,0 AS [TKT_NETBOOKINGS],0 AS DB_NETBOOKINGS,0 AS [1A_NETBOOKINGS],NETBOOKINGS AS MT_NETBOOKINGS,0 AS CODD,0 AS HX_BOOKINGS 
					FROM T_MIDTPRODUCTIVITY_AIR DB WITH(NOLOCK)
					LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO ON DB.LCODE=VO.LCODE	
--					UNION ALL
--					SELECT LCODE,OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,0 AS [TKT_NETBOOKINGS],0 AS DB_NETBOOKINGS,0 AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS,CODD,HX_BOOKINGS
--					FROM T_INC_NIDT_PRODUCTIVITY_EXPORTED WITH(NOLOCK)							
				) AS DB			
					INNER JOIN LOCATION_MASTER LM WITH(NOLOCK) ON LM.LOCATION_CODE=DB.LCODE
					INNER JOIN AGROUP G WITH(NOLOCK) ON G.CHAIN_CODE=LM.CHAIN_CODE
					LEFT OUTER JOIN T_C_CLASSIFICATION C WITH(NOLOCK) ON G.GroupClassificationID=C.GroupClassificationID
					LEFT OUTER JOIN T_C_TYPE AT ON LM.AGENCYTYPEID=AT.AGENCYTYPEID
					LEFT OUTER JOIN T_G_EMPLOYEES EMP  WITH (NOLOCK)ON LM.RESP_1A=EMP.EMPLOYEEID
					LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO WITH(NOLOCK) ON LM.LOCATION_CODE=VO.LCODE
					LEFT OUTER JOIN T_G_GROUP_TYPE GT  WITH(NOLOCK) ON G.GROUPTYPEID=GT.GROUPTYPEID
				WHERE 				
					(@COUNTRY IS NULL OR LM.COUNTRY=@COUNTRY)
					AND (@CITY IS NULL OR LM.CITY=@CITY)
					AND (@LCODE IS NULL OR LM.LOCATION_CODE=@LCODE)
					AND (@AGENCYNAME IS NULL OR LM.NAME LIKE '%' + LTRIM(RTRIM(@AGENCYNAME)) + '%')
					AND (@RESPONSIBLESTAFF IS NULL OR LM.RESP_1A=@RESPONSIBLESTAFF)
					AND (@AGENCYTYPEID IS NULL OR LM.AGENCYTYPEID=@AGENCYTYPEID)
					AND (@AGENCYSTATUSID IS NULL OR LM.AGENCYSTATUSID=@AGENCYSTATUSID)				
					AND (@AOFFICE IS NULL OR LM.AOFFICE=@AOFFICE)								
					AND (@REGION IS NULL OR LM.AOFFICE IN (SELECT AOFFICE FROM BRANCH WITH (NOLOCK) WHERE REGION=@REGION))
					AND (@GROUPTYPEID IS NULL OR GT.GROUPTYPEID=@GROUPTYPEID)		
					AND (@CHAIN_CODE IS NULL OR LM.CHAIN_CODE=@CHAIN_CODE)		
					AND DB.[DATE] BETWEEN @DATEFROM AND @DATETO
			END
		ELSE
			IF (@1A_TICKET=1)  AND (@DAILYBOOKINGS=1) AND(@1A_PROD=0) AND (@ALLCRS=0) AND (ISNULL(@NIDT,0)=1)
			BEGIN
				INSERT @A_TKT_BOOKINGS
				(TYPE,LCODE,OFFICEID,
				[MONTH],[YEAR],[DATE],[TKT_NETBOOKINGS],DB_NETBOOKINGS,[1A_NETBOOKINGS],MT_NETBOOKINGS,CODD,HX_BOOKINGS)						
				SELECT 'R',DB.LCODE,DB.OFFICEID,DB.[MONTH],DB.[YEAR],DB.[DATE],DB.[TKT_NETBOOKINGS],DB.DB_NETBOOKINGS,DB.[1A_NETBOOKINGS],DB.MT_NETBOOKINGS,DB.CODD,DB.HX_BOOKINGS 
				FROM(
					SELECT T.LCODE,T.OFFICEID,
					SUBSTRING(CAST(DATE AS VARCHAR),5,2) AS [MONTH],LEFT(DATE,4) AS [YEAR],
					[DATE],[TKT_NETBOOKINGS]=ISS_E_TKT,0 AS DB_NETBOOKINGS,0 AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS,0 AS CODD,0 AS HX_BOOKINGS
					FROM 	T_C_1A_TICKET_BOOKINGS T WITH(NOLOCK)
					UNION ALL
					SELECT DB.LCODE,VO.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1, 0 AS [TKT_NETBOOKINGS],NETBOOKINGS,0 AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS,0 AS CODD,0 AS HX_BOOKINGS
					FROM T_C_1A_DAILY_BOOKINGS DB WITH(NOLOCK)
					LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO ON DB.LCODE=VO.LCODE
--					UNION ALL
--					SELECT LCODE,OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,0 AS [TKT_NETBOOKINGS],0 AS DB_NETBOOKINGS,NETBOOKINGS AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS,0 AS CODD,0 AS HX_BOOKINGS
--					FROM T_C_AIR_BOOKINGS  WITH(NOLOCK)
--					WHERE ACCESS_LEVEL<>'PB'
--					UNION ALL
--					SELECT DB.LCODE,VO.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,0 AS [TKT_NETBOOKINGS],0 AS DB_NETBOOKINGS,0 AS [1A_NETBOOKINGS],NETBOOKINGS AS MT_NETBOOKINGS,0 AS CODD,0 AS HX_BOOKINGS 
--					FROM T_MIDTPRODUCTIVITY_AIR DB WITH(NOLOCK)
--					LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO ON DB.LCODE=VO.LCODE	
					UNION ALL
					SELECT LCODE,OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,0 AS [TKT_NETBOOKINGS],0 AS DB_NETBOOKINGS,0 AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS,CODD,HX_BOOKINGS
					FROM T_INC_NIDT_PRODUCTIVITY_EXPORTED WITH(NOLOCK)							
				) AS DB			
					INNER JOIN LOCATION_MASTER LM WITH(NOLOCK) ON LM.LOCATION_CODE=DB.LCODE
					INNER JOIN AGROUP G WITH(NOLOCK) ON G.CHAIN_CODE=LM.CHAIN_CODE
					LEFT OUTER JOIN T_C_CLASSIFICATION C WITH(NOLOCK) ON G.GroupClassificationID=C.GroupClassificationID
					LEFT OUTER JOIN T_C_TYPE AT ON LM.AGENCYTYPEID=AT.AGENCYTYPEID
					LEFT OUTER JOIN T_G_EMPLOYEES EMP  WITH (NOLOCK)ON LM.RESP_1A=EMP.EMPLOYEEID
					LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO WITH(NOLOCK) ON LM.LOCATION_CODE=VO.LCODE
					LEFT OUTER JOIN T_G_GROUP_TYPE GT  WITH(NOLOCK) ON G.GROUPTYPEID=GT.GROUPTYPEID
				WHERE 				
					(@COUNTRY IS NULL OR LM.COUNTRY=@COUNTRY)
					AND (@CITY IS NULL OR LM.CITY=@CITY)
					AND (@LCODE IS NULL OR LM.LOCATION_CODE=@LCODE)
					AND (@AGENCYNAME IS NULL OR LM.NAME LIKE '%' + LTRIM(RTRIM(@AGENCYNAME)) + '%')
					AND (@RESPONSIBLESTAFF IS NULL OR LM.RESP_1A=@RESPONSIBLESTAFF)
					AND (@AGENCYTYPEID IS NULL OR LM.AGENCYTYPEID=@AGENCYTYPEID)
					AND (@AGENCYSTATUSID IS NULL OR LM.AGENCYSTATUSID=@AGENCYSTATUSID)				
					AND (@AOFFICE IS NULL OR LM.AOFFICE=@AOFFICE)								
					AND (@REGION IS NULL OR LM.AOFFICE IN (SELECT AOFFICE FROM BRANCH WITH (NOLOCK) WHERE REGION=@REGION))
					AND (@GROUPTYPEID IS NULL OR GT.GROUPTYPEID=@GROUPTYPEID)				
					AND (@CHAIN_CODE IS NULL OR LM.CHAIN_CODE=@CHAIN_CODE)
					AND DB.[DATE] BETWEEN @DATEFROM AND @DATETO
			END
		ELSE
			IF (@1A_TICKET=1)  AND (@DAILYBOOKINGS=0) AND(@1A_PROD=0) AND (@ALLCRS=1) AND (ISNULL(@NIDT,0)=1)
			BEGIN
				INSERT @A_TKT_BOOKINGS
				(TYPE,LCODE,OFFICEID,
				[MONTH],[YEAR],[DATE],[TKT_NETBOOKINGS],DB_NETBOOKINGS,[1A_NETBOOKINGS],MT_NETBOOKINGS,CODD,HX_BOOKINGS)						
				SELECT 'S',DB.LCODE,DB.OFFICEID,DB.[MONTH],DB.[YEAR],DB.[DATE],DB.[TKT_NETBOOKINGS],DB.DB_NETBOOKINGS,DB.[1A_NETBOOKINGS],DB.MT_NETBOOKINGS,DB.CODD,DB.HX_BOOKINGS 
				FROM(
					SELECT T.LCODE,T.OFFICEID,
					SUBSTRING(CAST(DATE AS VARCHAR),5,2) AS [MONTH],LEFT(DATE,4) AS [YEAR],
					[DATE],[TKT_NETBOOKINGS]=ISS_E_TKT,0 AS DB_NETBOOKINGS,0 AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS,0 AS CODD,0 AS HX_BOOKINGS
					FROM 	T_C_1A_TICKET_BOOKINGS T WITH(NOLOCK)
--					UNION ALL
--					SELECT DB.LCODE,VO.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1, 0 AS [TKT_NETBOOKINGS],NETBOOKINGS,0 AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS,0 AS CODD,0 AS HX_BOOKINGS
--					FROM T_C_1A_DAILY_BOOKINGS DB WITH(NOLOCK)
--					LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO ON DB.LCODE=VO.LCODE
--					UNION ALL
--					SELECT LCODE,OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,0 AS [TKT_NETBOOKINGS],0 AS DB_NETBOOKINGS,NETBOOKINGS AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS,0 AS CODD,0 AS HX_BOOKINGS
--					FROM T_C_AIR_BOOKINGS  WITH(NOLOCK)
--					WHERE ACCESS_LEVEL<>'PB'
					UNION ALL
					SELECT DB.LCODE,VO.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,0 AS [TKT_NETBOOKINGS],0 AS DB_NETBOOKINGS,0 AS [1A_NETBOOKINGS],NETBOOKINGS AS MT_NETBOOKINGS,0 AS CODD,0 AS HX_BOOKINGS 
					FROM T_MIDTPRODUCTIVITY_AIR DB WITH(NOLOCK)
					LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO ON DB.LCODE=VO.LCODE	
					UNION ALL
					SELECT LCODE,OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,0 AS [TKT_NETBOOKINGS],0 AS DB_NETBOOKINGS,0 AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS,CODD,HX_BOOKINGS
					FROM T_INC_NIDT_PRODUCTIVITY_EXPORTED WITH(NOLOCK)							
				) AS DB			
					INNER JOIN LOCATION_MASTER LM WITH(NOLOCK) ON LM.LOCATION_CODE=DB.LCODE
					INNER JOIN AGROUP G WITH(NOLOCK) ON G.CHAIN_CODE=LM.CHAIN_CODE
					LEFT OUTER JOIN T_C_CLASSIFICATION C WITH(NOLOCK) ON G.GroupClassificationID=C.GroupClassificationID
					LEFT OUTER JOIN T_C_TYPE AT ON LM.AGENCYTYPEID=AT.AGENCYTYPEID
					LEFT OUTER JOIN T_G_EMPLOYEES EMP  WITH (NOLOCK)ON LM.RESP_1A=EMP.EMPLOYEEID
					LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO WITH(NOLOCK) ON LM.LOCATION_CODE=VO.LCODE
					LEFT OUTER JOIN T_G_GROUP_TYPE GT  WITH(NOLOCK) ON G.GROUPTYPEID=GT.GROUPTYPEID
				WHERE 				
					(@COUNTRY IS NULL OR LM.COUNTRY=@COUNTRY)
					AND (@CITY IS NULL OR LM.CITY=@CITY)
					AND (@LCODE IS NULL OR LM.LOCATION_CODE=@LCODE)
					AND (@AGENCYNAME IS NULL OR LM.NAME LIKE '%' + LTRIM(RTRIM(@AGENCYNAME)) + '%')
					AND (@RESPONSIBLESTAFF IS NULL OR LM.RESP_1A=@RESPONSIBLESTAFF)
					AND (@AGENCYTYPEID IS NULL OR LM.AGENCYTYPEID=@AGENCYTYPEID)
					AND (@AGENCYSTATUSID IS NULL OR LM.AGENCYSTATUSID=@AGENCYSTATUSID)				
					AND (@AOFFICE IS NULL OR LM.AOFFICE=@AOFFICE)								
					AND (@REGION IS NULL OR LM.AOFFICE IN (SELECT AOFFICE FROM BRANCH WITH (NOLOCK) WHERE REGION=@REGION))
					AND (@GROUPTYPEID IS NULL OR GT.GROUPTYPEID=@GROUPTYPEID)				
					AND (@CHAIN_CODE IS NULL OR LM.CHAIN_CODE=@CHAIN_CODE)
					AND DB.[DATE] BETWEEN @DATEFROM AND @DATETO
			END
		ELSE
			IF (@1A_TICKET=0)  AND (@DAILYBOOKINGS=1) AND(@1A_PROD=1) AND (@ALLCRS=1) AND (ISNULL(@NIDT,0)=0)
			BEGIN
				INSERT @A_TKT_BOOKINGS
				(TYPE,LCODE,OFFICEID,
				[MONTH],[YEAR],[DATE],[TKT_NETBOOKINGS],DB_NETBOOKINGS,[1A_NETBOOKINGS],MT_NETBOOKINGS,CODD,HX_BOOKINGS)						
				SELECT 'T',DB.LCODE,DB.OFFICEID,DB.[MONTH],DB.[YEAR],DB.[DATE],DB.[TKT_NETBOOKINGS],DB.DB_NETBOOKINGS,DB.[1A_NETBOOKINGS],DB.MT_NETBOOKINGS,DB.CODD,DB.HX_BOOKINGS 
				FROM(
--					SELECT T.LCODE,T.OFFICEID,
--					SUBSTRING(CAST(DATE AS VARCHAR),5,2) AS [MONTH],LEFT(DATE,4) AS [YEAR],
--					[DATE],[TKT_NETBOOKINGS]=ISS_E_TKT,0 AS DB_NETBOOKINGS,0 AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS,0 AS CODD,0 AS HX_BOOKINGS
--					FROM 	T_C_1A_TICKET_BOOKINGS T WITH(NOLOCK)
--					UNION ALL
					SELECT DB.LCODE,VO.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1, 0 AS [TKT_NETBOOKINGS],NETBOOKINGS as DB_NETBOOKINGS,0 AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS,0 AS CODD,0 AS HX_BOOKINGS
					FROM T_C_1A_DAILY_BOOKINGS DB WITH(NOLOCK)
					LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO ON DB.LCODE=VO.LCODE
					UNION ALL
					SELECT LCODE,OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,0 AS [TKT_NETBOOKINGS],0 AS DB_NETBOOKINGS,NETBOOKINGS AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS,0 AS CODD,0 AS HX_BOOKINGS
					FROM T_C_AIR_BOOKINGS  WITH(NOLOCK)
					WHERE ACCESS_LEVEL<>'PB'
					UNION ALL
					SELECT DB.LCODE,VO.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,0 AS [TKT_NETBOOKINGS],0 AS DB_NETBOOKINGS,0 AS [1A_NETBOOKINGS],NETBOOKINGS AS MT_NETBOOKINGS,0 AS CODD,0 AS HX_BOOKINGS 
					FROM T_MIDTPRODUCTIVITY_AIR DB WITH(NOLOCK)
					LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO ON DB.LCODE=VO.LCODE	
--					UNION ALL
--					SELECT LCODE,OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,0 AS [TKT_NETBOOKINGS],0 AS DB_NETBOOKINGS,0 AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS,CODD,HX_BOOKINGS
--					FROM T_INC_NIDT_PRODUCTIVITY_EXPORTED WITH(NOLOCK)							
				) AS DB			
					INNER JOIN LOCATION_MASTER LM WITH(NOLOCK) ON LM.LOCATION_CODE=DB.LCODE
					INNER JOIN AGROUP G WITH(NOLOCK) ON G.CHAIN_CODE=LM.CHAIN_CODE
					LEFT OUTER JOIN T_C_CLASSIFICATION C WITH(NOLOCK) ON G.GroupClassificationID=C.GroupClassificationID
					LEFT OUTER JOIN T_C_TYPE AT ON LM.AGENCYTYPEID=AT.AGENCYTYPEID
					LEFT OUTER JOIN T_G_EMPLOYEES EMP  WITH (NOLOCK)ON LM.RESP_1A=EMP.EMPLOYEEID
					LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO WITH(NOLOCK) ON LM.LOCATION_CODE=VO.LCODE
					LEFT OUTER JOIN T_G_GROUP_TYPE GT  WITH(NOLOCK) ON G.GROUPTYPEID=GT.GROUPTYPEID
				WHERE 				
					(@COUNTRY IS NULL OR LM.COUNTRY=@COUNTRY)
					AND (@CITY IS NULL OR LM.CITY=@CITY)
					AND (@LCODE IS NULL OR LM.LOCATION_CODE=@LCODE)
					AND (@AGENCYNAME IS NULL OR LM.NAME LIKE '%' + LTRIM(RTRIM(@AGENCYNAME)) + '%')
					AND (@RESPONSIBLESTAFF IS NULL OR LM.RESP_1A=@RESPONSIBLESTAFF)
					AND (@AGENCYTYPEID IS NULL OR LM.AGENCYTYPEID=@AGENCYTYPEID)
					AND (@AGENCYSTATUSID IS NULL OR LM.AGENCYSTATUSID=@AGENCYSTATUSID)				
					AND (@AOFFICE IS NULL OR LM.AOFFICE=@AOFFICE)								
					AND (@REGION IS NULL OR LM.AOFFICE IN (SELECT AOFFICE FROM BRANCH WITH (NOLOCK) WHERE REGION=@REGION))
					AND (@GROUPTYPEID IS NULL OR GT.GROUPTYPEID=@GROUPTYPEID)	
					AND (@CHAIN_CODE IS NULL OR LM.CHAIN_CODE=@CHAIN_CODE)			
					AND DB.[DATE] BETWEEN @DATEFROM AND @DATETO
			END
		ELSE
			IF (@1A_TICKET=0)  AND (@DAILYBOOKINGS=0) AND(@1A_PROD=1) AND (@ALLCRS=1) AND (ISNULL(@NIDT,0)=1)
			BEGIN
				INSERT @A_TKT_BOOKINGS
				(TYPE,LCODE,OFFICEID,
				[MONTH],[YEAR],[DATE],[TKT_NETBOOKINGS],DB_NETBOOKINGS,[1A_NETBOOKINGS],MT_NETBOOKINGS,CODD,HX_BOOKINGS)						
				SELECT 'U',DB.LCODE,DB.OFFICEID,DB.[MONTH],DB.[YEAR],DB.[DATE],DB.[TKT_NETBOOKINGS],DB.DB_NETBOOKINGS,DB.[1A_NETBOOKINGS],DB.MT_NETBOOKINGS,DB.CODD,DB.HX_BOOKINGS 
				FROM(
--					SELECT T.LCODE,T.OFFICEID,
--					SUBSTRING(CAST(DATE AS VARCHAR),5,2) AS [MONTH],LEFT(DATE,4) AS [YEAR],
--					[DATE],[TKT_NETBOOKINGS]=ISS_E_TKT,0 AS DB_NETBOOKINGS,0 AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS,0 AS CODD,0 AS HX_BOOKINGS
--					FROM 	T_C_1A_TICKET_BOOKINGS T WITH(NOLOCK)
--					UNION ALL
--					SELECT DB.LCODE,VO.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1, 0 AS [TKT_NETBOOKINGS],NETBOOKINGS,0 AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS,0 AS CODD,0 AS HX_BOOKINGS
--					FROM T_C_1A_DAILY_BOOKINGS DB WITH(NOLOCK)
--					LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO ON DB.LCODE=VO.LCODE
--					UNION ALL
					SELECT LCODE,OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,0 AS [TKT_NETBOOKINGS],0 AS DB_NETBOOKINGS,NETBOOKINGS AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS,0 AS CODD,0 AS HX_BOOKINGS
					FROM T_C_AIR_BOOKINGS  WITH(NOLOCK)
					WHERE ACCESS_LEVEL<>'PB'
					UNION ALL
					SELECT DB.LCODE,VO.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,0 AS [TKT_NETBOOKINGS],0 AS DB_NETBOOKINGS,0 AS [1A_NETBOOKINGS],NETBOOKINGS AS MT_NETBOOKINGS,0 AS CODD,0 AS HX_BOOKINGS 
					FROM T_MIDTPRODUCTIVITY_AIR DB WITH(NOLOCK)
					LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO ON DB.LCODE=VO.LCODE	
					UNION ALL
					SELECT LCODE,OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,0 AS [TKT_NETBOOKINGS],0 AS DB_NETBOOKINGS,0 AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS,CODD,HX_BOOKINGS
					FROM T_INC_NIDT_PRODUCTIVITY_EXPORTED WITH(NOLOCK)							
				) AS DB			
					INNER JOIN LOCATION_MASTER LM WITH(NOLOCK) ON LM.LOCATION_CODE=DB.LCODE
					INNER JOIN AGROUP G WITH(NOLOCK) ON G.CHAIN_CODE=LM.CHAIN_CODE
					LEFT OUTER JOIN T_C_CLASSIFICATION C WITH(NOLOCK) ON G.GroupClassificationID=C.GroupClassificationID
					LEFT OUTER JOIN T_C_TYPE AT ON LM.AGENCYTYPEID=AT.AGENCYTYPEID
					LEFT OUTER JOIN T_G_EMPLOYEES EMP  WITH (NOLOCK)ON LM.RESP_1A=EMP.EMPLOYEEID
					LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO WITH(NOLOCK) ON LM.LOCATION_CODE=VO.LCODE
					LEFT OUTER JOIN T_G_GROUP_TYPE GT  WITH(NOLOCK) ON G.GROUPTYPEID=GT.GROUPTYPEID
				WHERE 				
					(@COUNTRY IS NULL OR LM.COUNTRY=@COUNTRY)
					AND (@CITY IS NULL OR LM.CITY=@CITY)
					AND (@LCODE IS NULL OR LM.LOCATION_CODE=@LCODE)
					AND (@AGENCYNAME IS NULL OR LM.NAME LIKE '%' + LTRIM(RTRIM(@AGENCYNAME)) + '%')
					AND (@RESPONSIBLESTAFF IS NULL OR LM.RESP_1A=@RESPONSIBLESTAFF)
					AND (@AGENCYTYPEID IS NULL OR LM.AGENCYTYPEID=@AGENCYTYPEID)
					AND (@AGENCYSTATUSID IS NULL OR LM.AGENCYSTATUSID=@AGENCYSTATUSID)				
					AND (@AOFFICE IS NULL OR LM.AOFFICE=@AOFFICE)								
					AND (@REGION IS NULL OR LM.AOFFICE IN (SELECT AOFFICE FROM BRANCH WITH (NOLOCK) WHERE REGION=@REGION))
					AND (@GROUPTYPEID IS NULL OR GT.GROUPTYPEID=@GROUPTYPEID)				
					AND (@CHAIN_CODE IS NULL OR LM.CHAIN_CODE=@CHAIN_CODE)
					AND DB.[DATE] BETWEEN @DATEFROM AND @DATETO
			END
	ELSE
			IF (@1A_TICKET=1)  AND (@DAILYBOOKINGS=0) AND(@1A_PROD=1) AND (@ALLCRS=1) AND (ISNULL(@NIDT,0)=0)
			BEGIN
				INSERT @A_TKT_BOOKINGS
				(TYPE,LCODE,OFFICEID,
				[MONTH],[YEAR],[DATE],[TKT_NETBOOKINGS],DB_NETBOOKINGS,[1A_NETBOOKINGS],MT_NETBOOKINGS,CODD,HX_BOOKINGS)						
				SELECT 'W',DB.LCODE,DB.OFFICEID,DB.[MONTH],DB.[YEAR],DB.[DATE],DB.[TKT_NETBOOKINGS],DB.DB_NETBOOKINGS,DB.[1A_NETBOOKINGS],DB.MT_NETBOOKINGS,DB.CODD,DB.HX_BOOKINGS 
				FROM(
					SELECT T.LCODE,T.OFFICEID,
					SUBSTRING(CAST(DATE AS VARCHAR),5,2) AS [MONTH],LEFT(DATE,4) AS [YEAR],
					[DATE],[TKT_NETBOOKINGS]=ISS_E_TKT,0 AS DB_NETBOOKINGS,0 AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS,0 AS CODD,0 AS HX_BOOKINGS
					FROM 	T_C_1A_TICKET_BOOKINGS T WITH(NOLOCK)
					UNION ALL
					SELECT LCODE,OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,0 AS [TKT_NETBOOKINGS],0 AS DB_NETBOOKINGS,NETBOOKINGS AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS,0 AS CODD,0 AS HX_BOOKINGS
					FROM T_C_AIR_BOOKINGS  WITH(NOLOCK)
					WHERE ACCESS_LEVEL<>'PB'
					UNION ALL
					SELECT DB.LCODE,VO.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,0 AS [TKT_NETBOOKINGS],0 AS DB_NETBOOKINGS,0 AS [1A_NETBOOKINGS],NETBOOKINGS AS MT_NETBOOKINGS,0 AS CODD,0 AS HX_BOOKINGS 
					FROM T_MIDTPRODUCTIVITY_AIR DB WITH(NOLOCK)
					LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO ON DB.LCODE=VO.LCODE	
					) AS DB			
						INNER JOIN LOCATION_MASTER LM WITH(NOLOCK) ON LM.LOCATION_CODE=DB.LCODE
						INNER JOIN AGROUP G WITH(NOLOCK) ON G.CHAIN_CODE=LM.CHAIN_CODE
						LEFT OUTER JOIN T_C_CLASSIFICATION C WITH(NOLOCK) ON G.GroupClassificationID=C.GroupClassificationID
						LEFT OUTER JOIN T_C_TYPE AT ON LM.AGENCYTYPEID=AT.AGENCYTYPEID
						LEFT OUTER JOIN T_G_EMPLOYEES EMP  WITH (NOLOCK)ON LM.RESP_1A=EMP.EMPLOYEEID
						LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO WITH(NOLOCK) ON LM.LOCATION_CODE=VO.LCODE
						LEFT OUTER JOIN T_G_GROUP_TYPE GT  WITH(NOLOCK) ON G.GROUPTYPEID=GT.GROUPTYPEID
					WHERE 				
						(@COUNTRY IS NULL OR LM.COUNTRY=@COUNTRY)
						AND (@CITY IS NULL OR LM.CITY=@CITY)
						AND (@LCODE IS NULL OR LM.LOCATION_CODE=@LCODE)
						AND (@AGENCYNAME IS NULL OR LM.NAME LIKE '%' + LTRIM(RTRIM(@AGENCYNAME)) + '%')
						AND (@RESPONSIBLESTAFF IS NULL OR LM.RESP_1A=@RESPONSIBLESTAFF)
						AND (@AGENCYTYPEID IS NULL OR LM.AGENCYTYPEID=@AGENCYTYPEID)
						AND (@AGENCYSTATUSID IS NULL OR LM.AGENCYSTATUSID=@AGENCYSTATUSID)				
						AND (@AOFFICE IS NULL OR LM.AOFFICE=@AOFFICE)								
						AND (@REGION IS NULL OR LM.AOFFICE IN (SELECT AOFFICE FROM BRANCH WITH (NOLOCK) WHERE REGION=@REGION))
						AND (@GROUPTYPEID IS NULL OR GT.GROUPTYPEID=@GROUPTYPEID)	
						AND (@CHAIN_CODE IS NULL OR LM.CHAIN_CODE=@CHAIN_CODE)			
						AND DB.[DATE] BETWEEN @DATEFROM AND @DATETO
			END

/*ADDED*/	
		ELSE
			BEGIN	
				INSERT @A_TKT_BOOKINGS
				(TYPE,LCODE,OFFICEID,
				[MONTH],[YEAR],[DATE],[TKT_NETBOOKINGS],DB_NETBOOKINGS,[1A_NETBOOKINGS],MT_NETBOOKINGS,CODD,HX_BOOKINGS)						
				SELECT 'V',DB.LCODE,DB.OFFICEID,DB.[MONTH],DB.[YEAR],DB.[DATE],DB.[TKT_NETBOOKINGS],DB.DB_NETBOOKINGS,DB.[1A_NETBOOKINGS],DB.MT_NETBOOKINGS,DB.CODD,DB.HX_BOOKINGS 
				FROM(
					SELECT T.LCODE,T.OFFICEID,
					SUBSTRING(CAST(DATE AS VARCHAR),5,2) AS [MONTH],LEFT(DATE,4) AS [YEAR],
					[DATE],[TKT_NETBOOKINGS]=ISS_E_TKT,0 AS DB_NETBOOKINGS,0 AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS,0 AS CODD,0 AS HX_BOOKINGS
					FROM 	T_C_1A_TICKET_BOOKINGS T WITH(NOLOCK)
					UNION ALL
					SELECT DB.LCODE,VO.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1, 0 AS [TKT_NETBOOKINGS],NETBOOKINGS,0 AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS,0 AS CODD,0 AS HX_BOOKINGS
					FROM T_C_1A_DAILY_BOOKINGS DB WITH(NOLOCK)
					LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO ON DB.LCODE=VO.LCODE
					UNION ALL
					SELECT LCODE,OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,0 AS [TKT_NETBOOKINGS],0 AS DB_NETBOOKINGS,NETBOOKINGS AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS,0 AS CODD,0 AS HX_BOOKINGS
					FROM T_C_AIR_BOOKINGS  WITH(NOLOCK)
					WHERE ACCESS_LEVEL<>'PB'
					UNION ALL
					SELECT DB.LCODE,VO.OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,0 AS [TKT_NETBOOKINGS],0 AS DB_NETBOOKINGS,0 AS [1A_NETBOOKINGS],NETBOOKINGS AS MT_NETBOOKINGS,0 AS CODD,0 AS HX_BOOKINGS 
					FROM T_MIDTPRODUCTIVITY_AIR DB WITH(NOLOCK)
					LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO ON DB.LCODE=VO.LCODE	
					UNION ALL
					SELECT LCODE,OFFICEID,MONTH,YEAR,[DATE]=(([YEAR]*100)+[MONTH])*100+1,0 AS [TKT_NETBOOKINGS],0 AS DB_NETBOOKINGS,0 AS [1A_NETBOOKINGS],0 AS MT_NETBOOKINGS,CODD,HX_BOOKINGS
					FROM T_INC_NIDT_PRODUCTIVITY_EXPORTED WITH(NOLOCK)							
				) AS DB			
					INNER JOIN LOCATION_MASTER LM WITH(NOLOCK) ON LM.LOCATION_CODE=DB.LCODE
					INNER JOIN AGROUP G WITH(NOLOCK) ON G.CHAIN_CODE=LM.CHAIN_CODE
					LEFT OUTER JOIN T_C_CLASSIFICATION C WITH(NOLOCK) ON G.GroupClassificationID=C.GroupClassificationID
					LEFT OUTER JOIN T_C_TYPE AT ON LM.AGENCYTYPEID=AT.AGENCYTYPEID
					LEFT OUTER JOIN T_G_EMPLOYEES EMP  WITH (NOLOCK)ON LM.RESP_1A=EMP.EMPLOYEEID
					LEFT OUTER JOIN V_CURRENT_OFFICEIDS VO WITH(NOLOCK) ON LM.LOCATION_CODE=VO.LCODE
					LEFT OUTER JOIN T_G_GROUP_TYPE GT  WITH(NOLOCK) ON G.GROUPTYPEID=GT.GROUPTYPEID
				WHERE 				
					(@COUNTRY IS NULL OR LM.COUNTRY=@COUNTRY)
					AND (@CITY IS NULL OR LM.CITY=@CITY)
					AND (@LCODE IS NULL OR LM.LOCATION_CODE=@LCODE)
					AND (@AGENCYNAME IS NULL OR LM.NAME LIKE '%' + LTRIM(RTRIM(@AGENCYNAME)) + '%')
					AND (@RESPONSIBLESTAFF IS NULL OR LM.RESP_1A=@RESPONSIBLESTAFF)
					AND (@AGENCYTYPEID IS NULL OR LM.AGENCYTYPEID=@AGENCYTYPEID)
					AND (@AGENCYSTATUSID IS NULL OR LM.AGENCYSTATUSID=@AGENCYSTATUSID)				
					AND (@AOFFICE IS NULL OR LM.AOFFICE=@AOFFICE)								
					AND (@REGION IS NULL OR LM.AOFFICE IN (SELECT AOFFICE FROM BRANCH WITH (NOLOCK) WHERE REGION=@REGION))
					AND (@GROUPTYPEID IS NULL OR GT.GROUPTYPEID=@GROUPTYPEID)	
					AND (@CHAIN_CODE IS NULL OR LM.CHAIN_CODE=@CHAIN_CODE)			
					AND DB.[DATE] BETWEEN @DATEFROM AND @DATETO
			
					
												
			END
	RETURN
END



GO

/****** Object:  UserDefinedFunction [dbo].[FN_AGENCYLTRS]    Script Date: 04/28/2011 15:46:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




 /*      
'COPYRIGHT NOTICE:  2007 BY BIRD INFORMATION SYSTEMS ALL RIGHTS RESERVED.      
'********************************************************************************************      
' THIS FILE CONTAINS TRADE SECRETS OF BIRD INFORMATION SYSTEMS NO PART      
' MAY BE REPRODUCED OR TRANSMITTED IN ANY FORM BY ANY MEANS OR FOR ANY PURPOSE      
' WITHOUT THE EXPRESS WRITTEN PERMISSION OF BIRD INFORMATION SYSTEMS      
'********************************************************************************************      
NAME: [FN_AGENCYLTRS]
PURPOSE: THIS FUNCTION RETURNs Last Duplicate LTR of the Agency.      
|--------|--------------------------------------------------------------|
|SL. NO. |DATE		  |DEVELOPERS NAME		|ACTIVITY					|
|-----------------------------------------------------------------------|
|1.		 |10/01/2009  |TAPAN NATH           |CREATION					|
|-----------------------------------------------------------------------|

BEGIN
  DECLARE @LCODE INT
  DECLARE @HD_QUERY_GROUP_ID INT
  DECLARE @CALL_SUB_GROUP_ID INT
  DECLARE @CALL_CATEGORY_ID INT
  DECLARE @CALL_SUB_CATEGORY_ID INT
  DECLARE @RESAVE INT

  SET @LCODE =21555
  SET @HD_QUERY_GROUP_ID =2
  SET @CALL_SUB_GROUP_ID =2
  SET @CALL_CATEGORY_ID =1
  SET @CALL_SUB_CATEGORY_ID =68
  SET @RESAVE=NULL

	SELECT * FROM DBO.FN_AGENCYLTRS(@LCODE,@HD_QUERY_GROUP_ID,@CALL_SUB_GROUP_ID,@CALL_CATEGORY_ID,@CALL_SUB_CATEGORY_ID,@RESAVE)
END


*/

CREATE FUNCTION [dbo].[FN_AGENCYLTRS]
(
  @LCODE INT=NULL,  
  @HD_QUERY_GROUP_ID INT=NULL,
  @CALL_SUB_GROUP_ID INT=NULL,
  @CALL_CATEGORY_ID INT=NULL,
  @CALL_SUB_CATEGORY_ID INT=NULL,
  @RESAVE INT=NULL
) 
 RETURNS @LTR TABLE
	(HD_RE_ID INT)
AS  		
	BEGIN
		IF @HD_QUERY_GROUP_ID=1
			BEGIN
				INSERT INTO @LTR
				SELECT HR.HD_RE_ID FROM T_HD_REQUESTS HR				
					INNER JOIN T_HD_STATUS HS ON HR.HD_STATUS_ID=HS.HD_STATUS_ID
				WHERE 
					HR.HD_QUERY_GROUP_ID=1			
					AND HR.CALL_SUB_GROUP_ID=@CALL_SUB_GROUP_ID 
					AND HR.CALL_CATEGORY_ID=@CALL_CATEGORY_ID
					AND CONVERT(INTEGER,CONVERT(VARCHAR,HR.HD_RE_OPEN_DATE,112))=CONVERT(INTEGER,CONVERT(VARCHAR,GETDATE(),112))
					AND HR.LCODE=@LCODE				
					AND HS.HD_STATUS_CLOSE=0
					AND ISNULL(@RESAVE,0)=0
			END

			IF @HD_QUERY_GROUP_ID=2
				BEGIN
					INSERT INTO @LTR
					SELECT HR.HD_RE_ID FROM T_HD_REQUESTS HR				
						INNER JOIN T_HD_STATUS HS ON HR.HD_STATUS_ID=HS.HD_STATUS_ID
					WHERE 
						HR.HD_QUERY_GROUP_ID=2			
						AND CONVERT(INTEGER,CONVERT(VARCHAR,HR.HD_RE_OPEN_DATE,112))=CONVERT(INTEGER,CONVERT(VARCHAR,GETDATE(),112))
						AND HR.LCODE=@LCODE				
						AND ISNULL(@RESAVE,0)=0				
				END
		RETURN
	END










  







GO

/****** Object:  UserDefinedFunction [dbo].[FN_AIRLINE_BREAKUP_MIDT]    Script Date: 04/28/2011 15:46:27 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


 /*      
'COPYRIGHT NOTICE:  2007 BY BIRD INFORMATION SYSTEMS ALL RIGHTS RESERVED.      
'********************************************************************************************      
' THIS FILE CONTAINS TRADE SECRETS OF BIRD INFORMATION SYSTEMS NO PART      
' MAY BE REPRODUCED OR TRANSMITTED IN ANY FORM BY ANY MEANS OR FOR ANY PURPOSE      
' WITHOUT THE EXPRESS WRITTEN PERMISSION OF BIRD INFORMATION SYSTEMS      
'********************************************************************************************      
NAME: [FN_AIRLINE_BREAKUP]
PURPOSE: THIS FUNCTION RETURNs Last Duplicate LTR of the Agency.      
|--------|--------------------------------------------------------------|
|SL. NO. |DATE		  |DEVELOPERS NAME		|ACTIVITY					|
|-----------------------------------------------------------------------|
|1.		 |01/09/2009  |TAPAN NATH           |CREATION					|
|-----------------------------------------------------------------------|
*/

CREATE FUNCTION [dbo].[FN_AIRLINE_BREAKUP_MIDT](
@STARTDATE INT,
@ENDDATE INT,
@CHAIN_CODE INT
) 
 RETURNS @AIRLINE_BREAKUP TABLE
 (TYPE VARCHAR(20),CHAIN_CODE INT,[1A] INT,[1B] INT,[1G] INT,[1P] INT,[1W] INT,[TOTAL] INT)
AS  		
BEGIN	
	--set nocount on
	INSERT INTO @AIRLINE_BREAKUP
	(TYPE,CHAIN_CODE,[1A],[1B],[1G],[1P],[1W],[TOTAL])
	SELECT 'TYPE'='TOTAL',B.CHAIN_CODE,SUM([1A]),SUM([1B]),SUM([1G]),SUM([1P]),SUM([1W]),(SUM([1A]) + SUM([1B]) + SUM([1G]) + SUM([1P]) + SUM([1W]))
	FROM(
		SELECT 	
			M.LCODE,LM.CHAIN_CODE,
		'1A'=CASE CRSCODETEXT WHEN '1A' THEN ROUND(SUM(NETBOOKINGS)/3.,0) ELSE 0 END,
		'1B'=CASE CRSCODETEXT WHEN '1B' THEN ROUND(SUM(NETBOOKINGS)/3.,0) ELSE 0 END,
		'1G'=CASE CRSCODETEXT WHEN '1G' THEN ROUND(SUM(NETBOOKINGS)/3.,0) ELSE 0 END,
		'1P'=CASE CRSCODETEXT WHEN '1P' THEN ROUND(SUM(NETBOOKINGS)/3.,0) ELSE 0 END,
		'1W'=CASE CRSCODETEXT WHEN '1W' THEN ROUND(SUM(NETBOOKINGS)/3.,0) ELSE 0 END
		FROM T_MIDTPRODUCTIVITY M WITH(NOLOCK)
		INNER JOIN LOCATION_MASTER LM WITH(NOLOCK) ON LM.LOCATION_CODE=M.LCODE
		INNER JOIN T_CRS C WITH(NOLOCK) ON C.CRSCODE=M.CRSCODE		
		WHERE  (((CONVERT(INT,YEAR)*100)+CONVERT(INT,MONTH))*100)+1 BETWEEN @STARTDATE AND @ENDDATE
		AND LM.CHAIN_CODE=@CHAIN_CODE
		GROUP BY M.LCODE,LM.CHAIN_CODE,CRSCODETEXT) AS B		
		GROUP BY B.CHAIN_CODE

	INSERT INTO @AIRLINE_BREAKUP
	(TYPE,CHAIN_CODE,[1A],[1B],[1G],[1P],[1W],[TOTAL])
	SELECT 
	'TYPE'=AIRLINE_CODE,
	CHAIN_CODE,	
	'1A'=SUM([1A]),
	'1B'=SUM([1B]),	
	'1G'=SUM([1G]),
	'1P'=SUM([1P]),
	'1W'=SUM([1W]), 
	'TOTAL'=SUM([1A]) + SUM([1B]) + SUM([1G])+ SUM([1P])+ SUM([1W])
	FROM(
		SELECT LCODE,CHAIN_CODE,AIRLINE_CODE,
		'1A'=CASE WHEN CRSCODETEXT='1A' THEN NETBOOKINGS ELSE 0 END,
		'1B'=CASE WHEN CRSCODETEXT='1B' THEN NETBOOKINGS ELSE 0  END,
		'1G'=CASE WHEN CRSCODETEXT='1G' THEN NETBOOKINGS ELSE 0 END,
		'1P'=CASE WHEN CRSCODETEXT='1P' THEN NETBOOKINGS ELSE 0 END,
		'1W'=CASE WHEN CRSCODETEXT='1W' THEN NETBOOKINGS ELSE 0 END
		FROM(
			SELECT 
			CHAIN_CODE,LCODE,C.CRSCODETEXT,AIRLINE_CODE,
			NETBOOKINGS=ROUND(SUM(CAST(NETBOOKINGS AS FLOAT))/3,0) FROM [VW_MIDT_AIRLINE_BREAKUP] B
			INNER JOIN T_CRS C WITH(NOLOCK) ON C.CRSCODE=B.CRSCODE			
			WHERE  DATE BETWEEN @STARTDATE AND @ENDDATE
			AND AIRLINE_CODE IN('IC','IT','9W','S2')
			AND CHAIN_CODE=@CHAIN_CODE
			GROUP BY CHAIN_CODE,LCODE,AIRLINE_CODE,C.CRSCODETEXT,AIRLINE_CODE
		) AS A
	) AS B
	GROUP BY CHAIN_CODE,AIRLINE_CODE

	INSERT INTO @AIRLINE_BREAKUP
	(TYPE,CHAIN_CODE,[1A],[1B],[1G],[1P],[1W],[TOTAL])
	SELECT 
	'DOM',CHAIN_CODE,SUM([1A]),SUM([1B]),SUM([1G]),SUM([1P]),SUM([1W]),SUM([TOTAL]) FROM  @AIRLINE_BREAKUP
	WHERE TYPE IN('IC','IT','9W','S2')
	GROUP BY CHAIN_CODE

	INSERT INTO @AIRLINE_BREAKUP
	(TYPE,CHAIN_CODE,[1A],[1B],[1G],[1P],[1W],[TOTAL])
	SELECT 'INTL',T.CHAIN_CODE,T.[1A]-D.[1A],T.[1B]-D.[1B],T.[1G]-D.[1G],T.[1P]-D.[1P],T.[1W]-D.[1W],T.[TOTAL]-D.[TOTAL]
		 FROM(
			  SELECT TYPE,CHAIN_CODE,[1A],[1B],[1G],[1P],[1W],[TOTAL] FROM @AIRLINE_BREAKUP WHERE TYPE='TOTAL'
			 ) AS T
			INNER JOIN 
			(SELECT TYPE,CHAIN_CODE,[1A],[1B],[1G],[1P],[1W],[TOTAL] FROM @AIRLINE_BREAKUP WHERE TYPE='DOM') D
			ON T.CHAIN_CODE=D.CHAIN_CODE

	RETURN
END










  








GO

/****** Object:  UserDefinedFunction [dbo].[FN_BR_AGENCYLTRS]    Script Date: 04/28/2011 15:46:27 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




 /*      
'COPYRIGHT NOTICE:  2007 BY BIRD INFORMATION SYSTEMS ALL RIGHTS RESERVED.      
'********************************************************************************************      
' THIS FILE CONTAINS TRADE SECRETS OF BIRD INFORMATION SYSTEMS NO PART      
' MAY BE REPRODUCED OR TRANSMITTED IN ANY FORM BY ANY MEANS OR FOR ANY PURPOSE      
' WITHOUT THE EXPRESS WRITTEN PERMISSION OF BIRD INFORMATION SYSTEMS      
'********************************************************************************************      
NAME: [FN_AGENCYLTRS]
PURPOSE: THIS FUNCTION RETURNs Last Duplicate LTR of the Agency.      
|--------|--------------------------------------------------------------|
|SL. NO. |DATE		  |DEVELOPERS NAME		|ACTIVITY					|
|-----------------------------------------------------------------------|
|1.		 |10/01/2009  |TAPAN NATH           |CREATION					|
|-----------------------------------------------------------------------|

BEGIN
  DECLARE @LCODE INT
  DECLARE @HD_QUERY_GROUP_ID INT
  DECLARE @CALL_SUB_GROUP_ID INT
  DECLARE @CALL_CATEGORY_ID INT
  DECLARE @CALL_SUB_CATEGORY_ID INT
  DECLARE @RESAVE INT

  SET @LCODE =21555
  SET @HD_QUERY_GROUP_ID =2
  SET @CALL_SUB_GROUP_ID =2
  SET @CALL_CATEGORY_ID =1
  SET @CALL_SUB_CATEGORY_ID =68
  SET @RESAVE=NULL

	SELECT * FROM DBO.FN_AGENCYLTRS(@LCODE,@HD_QUERY_GROUP_ID,@CALL_SUB_GROUP_ID,@CALL_CATEGORY_ID,@CALL_SUB_CATEGORY_ID,@RESAVE)
END


*/

create FUNCTION [dbo].[FN_BR_AGENCYLTRS]
(
  @LCODE INT=NULL,  
  @HD_QUERY_GROUP_ID INT=NULL,
  @CALL_SUB_GROUP_ID INT=NULL,
  @CALL_CATEGORY_ID INT=NULL,
  @CALL_SUB_CATEGORY_ID INT=NULL,
  @RESAVE INT=NULL
) 
 RETURNS @LTR TABLE
	(HD_RE_ID INT)
AS  		
	BEGIN
		IF @HD_QUERY_GROUP_ID=1
			BEGIN
				INSERT INTO @LTR
				SELECT HR.HD_RE_ID FROM T_BR_HD_REQUESTS HR				
					INNER JOIN T_BR_HD_STATUS HS ON HR.HD_STATUS_ID=HS.HD_STATUS_ID
				WHERE 
					HR.HD_QUERY_GROUP_ID=1			
					AND HR.CALL_SUB_GROUP_ID=@CALL_SUB_GROUP_ID 
					AND HR.CALL_CATEGORY_ID=@CALL_CATEGORY_ID
					AND CONVERT(INTEGER,CONVERT(VARCHAR,HR.HD_RE_OPEN_DATE,112))=CONVERT(INTEGER,CONVERT(VARCHAR,GETDATE(),112))
					AND HR.LCODE=@LCODE				
					AND HS.HD_STATUS_CLOSE=0
					AND ISNULL(@RESAVE,0)=0
			END

			IF @HD_QUERY_GROUP_ID=2
				BEGIN
					INSERT INTO @LTR
					SELECT HR.HD_RE_ID FROM T_BR_HD_REQUESTS HR				
						INNER JOIN T_BR_HD_STATUS HS ON HR.HD_STATUS_ID=HS.HD_STATUS_ID
					WHERE 
						HR.HD_QUERY_GROUP_ID=2			
						AND CONVERT(INTEGER,CONVERT(VARCHAR,HR.HD_RE_OPEN_DATE,112))=CONVERT(INTEGER,CONVERT(VARCHAR,GETDATE(),112))
						AND HR.LCODE=@LCODE				
						AND ISNULL(@RESAVE,0)=0				
				END
		RETURN
	END










  







GO

/****** Object:  UserDefinedFunction [dbo].[FN_EMPLOYEE_AGENCY]    Script Date: 04/28/2011 15:46:28 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[FN_EMPLOYEE_AGENCY]
	(@EMPLOYEEID INT)
	RETURNS @EMPLOYEE_LCODE TABLE
	(LCODE INT)

BEGIN
	
	DECLARE @LIMITED_TO_OWNAGENCY BIT		
	DECLARE @IMMEDIATESUPERVISORID_1 INT

	
	DECLARE @LIMITED_TO_AOFFICE BIT
	DECLARE @AOFFICE VARCHAR(3)
	DECLARE @LIMITED_TO_REGION BIT
	DECLARE @SECURITYREGIONID INT

	SELECT 
	@LIMITED_TO_OWNAGENCY=LIMITED_TO_OWNAGENCY, 
	@LIMITED_TO_REGION=LIMITED_TO_REGION,
	@LIMITED_TO_AOFFICE=LIMITED_TO_AOFFICE,
	@AOFFICE=AOFFICE,
	@SECURITYREGIONID=SECURITYREGIONID,
	@IMMEDIATESUPERVISORID_1=IMMEDIATESUPERVISORID
	FROM T_G_EMPLOYEES WHERE EMPLOYEEID=@EMPLOYEEID

	
	IF ISNULL(@LIMITED_TO_OWNAGENCY,0)=1
		BEGIN			
			INSERT INTO @EMPLOYEE_LCODE
			SELECT LOCATION_CODE FROM LOCATION_MASTER 
			WHERE (LOCATION_MASTER.RESP_1A=@EMPLOYEEID)
		END
	IF (ISNULL(@LIMITED_TO_AOFFICE,0)=1) 
		BEGIN	
			INSERT INTO @EMPLOYEE_LCODE
			SELECT LOCATION_CODE FROM LOCATION_MASTER 
			WHERE (LOCATION_MASTER.AOFFICE =@AOFFICE)
		END	
	IF (ISNULL(@LIMITED_TO_REGION,0)=1) 
		BEGIN
			INSERT INTO @EMPLOYEE_LCODE
			SELECT LOCATION_CODE FROM LOCATION_MASTER 
			WHERE (LOCATION_MASTER.AOFFICE IN (SELECT AOFFICE  FROM T_G_SECURITY_REGION_AOFFICE WHERE REGIONID=@SECURITYREGIONID))
		END			

		INSERT INTO @EMPLOYEE_LCODE
		SELECT LOCATION_CODE FROM LOCATION_MASTER 
		WHERE CHAIN_CODE IN
		(SELECT CHAIN_CODE FROM T_G_EMP_AGENCY_GROUP WHERE EMPLOYEEID
		IN(SELECT EMPLOYEEID FROM T_G_EMPLOYEES WHERE IMMEDIATESUPERVISORID=@EMPLOYEEID))

	RETURN
END


GO

/****** Object:  UserDefinedFunction [dbo].[FN_GET_CHAIN_MIDT]    Script Date: 04/28/2011 15:46:28 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




 /*      
'COPYRIGHT NOTICE:  2007 BY BIRD INFORMATION SYSTEMS ALL RIGHTS RESERVED.      
'********************************************************************************************      
' THIS FILE CONTAINS TRADE SECRETS OF BIRD INFORMATION SYSTEMS NO PART      
' MAY BE REPRODUCED OR TRANSMITTED IN ANY FORM BY ANY MEANS OR FOR ANY PURPOSE      
' WITHOUT THE EXPRESS WRITTEN PERMISSION OF BIRD INFORMATION SYSTEMS      
'********************************************************************************************      
NAME: [UP_RPT_PR_CMR]
PURPOSE: THIS PROCEDURE RETURNs MIDT for CMR.      
|--------|--------------------------------------------------------------|
|SL. NO. |DATE		  |DEVELOPERS NAME		|ACTIVITY					|
|-----------------------------------------------------------------------|
|1.		 |01/09/2009  |TAPAN NATH           |CREATION					|
|-----------------------------------------------------------------------|
--SELECT * FROM DBO.FN_GET_CHAIN_MIDT(20090501,20090731,794)
*/

CREATE FUNCTION [dbo].[FN_GET_CHAIN_MIDT]
(
@STARTDATE INT,
@ENDDATE INT,
@CHAIN_CODE INT
) 
 RETURNS TABLE
AS   RETURN (

		SELECT MIDT.CHAIN_CODE ,  
		'1A'=SUM(ISNULL(MIDT.[1A],0)),
		'1B'=SUM(ISNULL(MIDT.[1B],0)),
		'1G'=SUM(ISNULL(MIDT.[1G],0)),
		'1P'=SUM(ISNULL(MIDT.[1P],0)),
		'1W'=SUM(ISNULL(MIDT.[1W],0)),
		'TOTAL'=SUM(ISNULL(MIDT.[TOTAL],0)) ,

		'1A_PER'= case when SUM(ISNULL(MIDT.[TOTAL],0))=0 then 0 else ROUND((CAST(SUM(ISNULL(MIDT.[1A],0))AS FLOAT)/ CAST(SUM(ISNULL(MIDT.[TOTAL],0)) AS FLOAT)),2)*100  end,
		'1B_PER'=case when SUM(ISNULL(MIDT.[TOTAL],0))=0 then 0 else ROUND((CAST(SUM(ISNULL(MIDT.[1B],0))AS FLOAT)/ CAST(SUM(ISNULL(MIDT.[TOTAL],0)) AS FLOAT)),2)*100  end,	
		'1G_PER'=case when SUM(ISNULL(MIDT.[TOTAL],0))=0 then 0 else ROUND((CAST(SUM(ISNULL(MIDT.[1G],0))AS FLOAT)/ CAST(SUM(ISNULL(MIDT.[TOTAL],0)) AS FLOAT)),2)*100  end,
		'1P_PER'=case when SUM(ISNULL(MIDT.[TOTAL],0))=0 then 0 else ROUND((CAST(SUM(ISNULL(MIDT.[1P],0))AS FLOAT)/ CAST(SUM(ISNULL(MIDT.[TOTAL],0)) AS FLOAT)),2)*100  end,
		'1W_PER'=case when SUM(ISNULL(MIDT.[TOTAL],0))=0 then 0 else ROUND((CAST(SUM(ISNULL(MIDT.[1W],0))AS FLOAT)/ CAST(SUM(ISNULL(MIDT.[TOTAL],0)) AS FLOAT)),2)*100 end 
		FROM 
		(
		SELECT 
		GP.CHAIN_CODE,
		GP.LCODE,
		'1A'=SUM(ISNULL(GP.[1A],0)),
		'1B'=SUM(ISNULL(GP.[1B],0)),
		'1G'=SUM(ISNULL(GP.[1G],0)),
		'1P'=SUM(ISNULL(GP.[1P],0)),
		'1W'=SUM(ISNULL(GP.[1W],0)),
		'TOTAL'=SUM(ISNULL(GP.[TOTAL],0)) 
		FROM(

		SELECT GRP.CHAIN_CODE,GRP.LCODE  ,GRP.CRSCODETEXT,GRP.PRODUCTIVITY AS TOTAL, 
		'1A'=CASE WHEN CRSCODETEXT='1A' THEN GRP.PRODUCTIVITY END,
		'1B'=CASE WHEN CRSCODETEXT='1B' THEN GRP.PRODUCTIVITY END,
		'1G'=CASE WHEN CRSCODETEXT='1G' THEN GRP.PRODUCTIVITY END,
		'1P'=CASE WHEN CRSCODETEXT='1P' THEN GRP.PRODUCTIVITY END,
		'1W'=CASE WHEN CRSCODETEXT='1W' THEN GRP.PRODUCTIVITY END
		FROM(
			SELECT 
			AG.CHAIN_CODE,MP.LCODE, CRS.CRSCODETEXT,
			'PRODUCTIVITY'=AVG(ISNULL(MP.NETBOOKINGS,0)) 
			FROM T_MIDTPRODUCTIVITY MP WITH(NOLOCK)
			INNER JOIN LOCATION_MASTER LM WITH(NOLOCK) ON LM.LOCATION_CODE=MP.LCODE		
			INNER JOIN AGROUP AG WITH(NOLOCK) ON LM.CHAIN_CODE=AG.CHAIN_CODE		
			INNER JOIN T_CRS CRS WITH(NOLOCK) ON CRS.CRSCODE=MP.CRSCODE
			WHERE CONVERT(INTEGER,CONVERT(VARCHAR,MP.DATE,112)) BETWEEN @STARTDATE AND @ENDDATE
			AND LOCATION_CODE IN
				(SELECT DISTINCT LCODE FROM T_MIDTPRODUCTIVITY WITH(NOLOCK) 
				WHERE CONVERT(INTEGER,CONVERT(VARCHAR,MP.DATE,112)) BETWEEN @STARTDATE AND @ENDDATE) 
			GROUP BY AG.CHAIN_CODE,MP.LCODE,CRS.CRSCODETEXT) AS GRP 
			) AS GP
		WHERE 
		CHAIN_CODE = @CHAIN_CODE
		GROUP BY GP.CHAIN_CODE,GP.LCODE
		) AS MIDT
		GROUP BY MIDT.CHAIN_CODE
)
















GO

/****** Object:  UserDefinedFunction [dbo].[FN_GET_GP_HARDWARE]    Script Date: 04/28/2011 15:46:29 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE FUNCTION [dbo].[FN_GET_GP_HARDWARE]
(
	@CITY VARCHAR(50) =NULL,  
	@COUNTRY VARCHAR(50) =NULL,  
	@REGION VARCHAR(50) =NULL,  
	@CHAINCODE  INT =NULL,  	
	@CHAINNAME VARCHAR(200) =NULL,  	
	@AOFFICE VARCHAR(3)=NULL,
	@CRS VARCHAR(5)=NULL,
	@TP_SYMBOL VARCHAR(50) =NULL,
	@TP_FROM INT=10,
	@TP_TO INT=NULL,
	@CRSTYPE VARCHAR(10)=NULL,
	@GROUPDATA BIT=NULL,	
	@GROUPTYPEID INT=NULL,
	@DATEFROM VARCHAR(10)=NULL,
	@DATETO VARCHAR(10)=NULL,
	@EMPLOYEEID INT=24,
	@LIMITED_TO_AOFFICE VARCHAR(3)=NULL, --SEND AOFFICE
	@LIMITED_TO_REGION INT=NULL,  -- SECURITY REGION
	@LIMITED_TO_OWNAAGENCY INT=NULL,
	@BRANCHAOFFICE VARCHAR(3)=null
) 
RETURNS TABLE
AS  		
	RETURN
	(
		SELECT A.CHAIN_CODE,A.CHAIN_NAME,
		A.NO_OF_PC,NO_OF_PRINTER=A.PRINTERS,NO_OF_TICKET=A.TICKETPRINTERS 
		FROM
		(SELECT AGROUP.CHAIN_CODE,CHAIN_NAME,
		T1.NO_OF_PC,
		T2.NO_OF_PRINTERS AS PRINTERS,
		T3.NO_OF_PRINTERS AS TICKETPRINTERS FROM(
		SELECT CHAIN_CODE ,'NO_OF_PC'=COUNT(LOCATION_CODE)FROM LOCATION_MASTER, PCINSTALLATION WHERE LOCATION_CODE = LCODE GROUP BY CHAIN_CODE) AS  T1, 
		(SELECT CHAIN_CODE, 'NO_OF_PRINTERS'=COUNT(LOCATION_CODE) FROM LOCATION_MASTER,MISCINSTALLATION,EQUIPMENT_MASTER WHERE  LOCATION_CODE = LCODE AND LCODE =LOCATION_CODE AND EGROUP_CODE = 'DPR' AND EQUIPMENT_TYPE = EQUIPMENT_CODE GROUP BY CHAIN_CODE ) AS T2, 
		(SELECT CHAIN_CODE, 'NO_OF_PRINTERS'=COUNT(LOCATION_CODE) FROM LOCATION_MASTER,MISCINSTALLATION,EQUIPMENT_MASTER  WHERE  LOCATION_CODE = LCODE AND LCODE =LOCATION_CODE AND EGROUP_CODE = 'TPR' AND EQUIPMENT_TYPE = EQUIPMENT_CODE GROUP BY CHAIN_CODE) AS T3,  
		AGROUP,LOCATION_MASTER 
			WHERE LOCATION_MASTER.CHAIN_CODE = AGROUP.CHAIN_CODE  
			AND LOCATION_MASTER.CHAIN_CODE *= T1.CHAIN_CODE 
			AND LOCATION_MASTER.CHAIN_CODE *= T2.CHAIN_CODE 
			AND LOCATION_MASTER.CHAIN_CODE *= T3.CHAIN_CODE   
		GROUP BY   AGROUP.CHAIN_CODE,CHAIN_NAME, T1.NO_OF_PC,T2.NO_OF_PRINTERS,T3.NO_OF_PRINTERS) AS A

	)





GO

/****** Object:  UserDefinedFunction [dbo].[FN_GET_GROUP_CONNECTION]    Script Date: 04/28/2011 15:46:30 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


  
  
 /*        
'COPYRIGHT NOTICE:  2007 BY BIRD INFORMATION SYSTEMS ALL RIGHTS RESERVED.        
'********************************************************************************************        
' THIS FILE CONTAINS TRADE SECRETS OF BIRD INFORMATION SYSTEMS NO PART        
' MAY BE REPRODUCED OR TRANSMITTED IN ANY FORM BY ANY MEANS OR FOR ANY PURPOSE        
' WITHOUT THE EXPRESS WRITTEN PERMISSION OF BIRD INFORMATION SYSTEMS        
'********************************************************************************************        
NAME: [FN_GET_GROUP_HARDWARE]  
PURPOSE: THIS PROCEDURE RETURNs GROUP HARDWARE OF THE GROUP  
|--------|--------------------------------------------------------------|  
|SL. NO. |DATE    |DEVELOPERS NAME  |ACTIVITY     |  
|-----------------------------------------------------------------------|  
|1.   |11/11/2009  |TAPAN NATH           |CREATION     |  
|-----------------------------------------------------------------------|  
 SELECT * FROM DBO.[FN_GET_GROUP_CONNECTION](2052,1)  
*/  
CREATE FUNCTION [dbo].[FN_GET_GROUP_CONNECTION]  
(  
@CHAIN_CODE INT,  
@COUNTRYID INT  
)   
 RETURNS TABLE  
AS   RETURN (  
  
 SELECT BC_ONLINE_CATG_ID,C_COUNT=SUM(C_COUNT)  
 FROM(  
  SELECT A.BC_ONLINE_CATG_ID,A.ONLINESTATUS,A.COUNTRYID,C_COUNT FROM  
   (
		SELECT CD.BC_ONLINE_CATG_ID,CD.ONLINESTATUS,CD.COUNTRYID   
		FROM T_INC_CONN_CATEGORY_DETAILS CD WITH(NOLOCK)  
		INNER JOIN T_INC_CONN_CATEGORY C WITH(NOLOCK) ON C.BC_ONLINE_CATG_ID=CD.BC_ONLINE_CATG_ID  
		INNER JOIN T_ONLINESTATUS S WITH(NOLOCK) ON CD.ONLINESTATUS=S.STATUSCODE  
		WHERE C.COUNTRYID=@COUNTRYID

	) AS A  
  LEFT OUTER JOIN  
   (  
   SELECT LM.CHAIN_CODE,ONLINE_STATUS=ISNULL(ONLINE_STATUS,''),C_COUNT=COUNT((ONLINE_STATUS)) FROM LOCATION_MASTER LM WITH(NOLOCK)   
   WHERE LM.CHAIN_CODE=@CHAIN_CODE  
   GROUP BY LM.CHAIN_CODE,ONLINE_STATUS  
   ) AS B ON A.ONLINESTATUS=B.ONLINE_STATUS  
  ) AS C  
  GROUP BY BC_ONLINE_CATG_ID  
)  
  
  
  
  
  
  
  
  
  
  
  
GO

/****** Object:  UserDefinedFunction [dbo].[FN_GET_GROUP_HARDWARE]    Script Date: 04/28/2011 15:46:30 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


  
  
 /*        
'COPYRIGHT NOTICE:  2007 BY BIRD INFORMATION SYSTEMS ALL RIGHTS RESERVED.        
'********************************************************************************************        
' THIS FILE CONTAINS TRADE SECRETS OF BIRD INFORMATION SYSTEMS NO PART        
' MAY BE REPRODUCED OR TRANSMITTED IN ANY FORM BY ANY MEANS OR FOR ANY PURPOSE        
' WITHOUT THE EXPRESS WRITTEN PERMISSION OF BIRD INFORMATION SYSTEMS        
'********************************************************************************************        
NAME: [FN_GET_GROUP_HARDWARE]  
PURPOSE: THIS PROCEDURE RETURNs GROUP HARDWARE OF THE GROUP  
|--------|--------------------------------------------------------------|  
|SL. NO. |DATE    |DEVELOPERS NAME  |ACTIVITY     |  
|-----------------------------------------------------------------------|  
|1.   |11/11/2009  |TAPAN NATH           |CREATION     |  
|-----------------------------------------------------------------------|  

SELECT * FROM DBO.[FN_GET_GROUP_HARDWARE_TEMP](7510,1)  

SELECT * FROM T_INC_EQP_CATEGORY_DETAILS WHERE BC_EQP_CATG_ID=36
SELECT * FROM T_INC_EQP_CATEGORY WHERE COUNTRYID=1 AND BC_EQP_CATG_TYPE='DMP IN'
SELECT * FROM EQUIPMENT_MASTER WHERE EQUIPMENT_CODE = 'LX8'


*/  

CREATE FUNCTION [dbo].[FN_GET_GROUP_HARDWARE]  
(  
@CHAIN_CODE INT,  
@COUNTRYID INT  
)   
 RETURNS TABLE  
AS   RETURN (  
  SELECT C.BC_EQP_CATG_ID,AGENCYPC=SUM(ISNULL(C.AGENCYPC,0)),AMADEUSPC=SUM(ISNULL(C.AMADEUSPC,0))   
  FROM  
   (SELECT A.BC_EQP_CATG_ID,A.BC_EQP_CATG_TYPE,A.BC_EQP_CATG_COST,A.PRODUCTID,B.AGENCYPC,B.AMADEUSPC FROM(  
   
   
	SELECT    
	ED.BC_EQP_CATG_ID,  
	EC.BC_EQP_CATG_TYPE,EC.BC_EQP_CATG_COST,ED.PRODUCTID  
	FROM T_INC_EQP_CATEGORY_DETAILS ED WITH(NOLOCK)  
	INNER JOIN T_INC_EQP_CATEGORY EC WITH(NOLOCK) ON EC.BC_EQP_CATG_ID=ED.BC_EQP_CATG_ID  	
	WHERE EC.COUNTRYID=@COUNTRYID) AS A  
	LEFT OUTER JOIN (  
	
	SELECT   
	A.CHAIN_CODE,  
	E.PRODUCTID,      
	AGENCYPC  = COUNT(CASE WHEN (CPUTYPE='CPP' or CPUTYPE='CPL') AND ((CPUNO='NA' or CPUNO='N/A') AND MONNO = 'NA') then 1 END),
	AMADEUSPC = COUNT(CASE WHEN (CPUTYPE<>'CPP' AND CPUNO<>'NA') OR (CPUTYPE='CPP' AND MONNO<>'NA') then 1 END)    
	FROM PCINSTALLATION PC WITH(NOLOCK)  
	INNER JOIN  EQUIPMENT_MASTER E WITH (NOLOCK) ON  PC.CPUTYPE = E.EQUIPMENT_CODE  
	INNER JOIN LOCATION_MASTER LM WITH(NOLOCK) ON LM.LOCATION_CODE =PC.LCODE  
	INNER JOIN AGROUP A WITH(NOLOCK) ON A.CHAIN_CODE =LM.CHAIN_CODE  
	WHERE A.CHAIN_CODE=@CHAIN_CODE 
	GROUP BY A.CHAIN_CODE,E.PRODUCTID
	UNION 
	SELECT   
	A.CHAIN_CODE,  
	E.PRODUCTID,      
	AGENCYPC  = 0,
	AMADEUSPC = COUNT(MPC.QTY)
	FROM MISCINSTALLATION MPC WITH(NOLOCK)  
	INNER JOIN  EQUIPMENT_MASTER E WITH (NOLOCK) ON  MPC.EQUIPMENT_TYPE = E.EQUIPMENT_CODE  
	INNER JOIN LOCATION_MASTER LM WITH(NOLOCK) ON LM.LOCATION_CODE =MPC.LCODE  
	INNER JOIN AGROUP A WITH(NOLOCK) ON A.CHAIN_CODE =LM.CHAIN_CODE  
	WHERE A.CHAIN_CODE=@CHAIN_CODE
	GROUP BY A.CHAIN_CODE,E.PRODUCTID
	 
	
	) AS B ON A.PRODUCTID=B.PRODUCTID
  ) AS C  
  GROUP BY C.BC_EQP_CATG_ID  
  --,C.BC_EQP_CATG_TYPE,C.BC_EQP_CATG_COST    
)  

GO

/****** Object:  UserDefinedFunction [dbo].[FN_GET_PLAN_NIDTFIELDS]    Script Date: 04/28/2011 15:46:31 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

 /*      
'COPYRIGHT NOTICE:  2007 BY BIRD INFORMATION SYSTEMS ALL RIGHTS RESERVED.      
'********************************************************************************************      
' THIS FILE CONTAINS TRADE SECRETS OF BIRD INFORMATION SYSTEMS NO PART      
' MAY BE REPRODUCED OR TRANSMITTED IN ANY FORM BY ANY MEANS OR FOR ANY PURPOSE      
' WITHOUT THE EXPRESS WRITTEN PERMISSION OF BIRD INFORMATION SYSTEMS      
'********************************************************************************************      
NAME: [FN_AIRLINE_BREAKUP]
PURPOSE: THIS FUNCTION RETURNs Last Duplicate LTR of the Agency.      
|--------|--------------------------------------------------------------|
|SL. NO. |DATE		  |DEVELOPERS NAME		|ACTIVITY					|
|-----------------------------------------------------------------------|
|1.		 |01/09/2009  |TAPAN NATH           |CREATION					|
|-----------------------------------------------------------------------|
*/

CREATE FUNCTION [dbo].[FN_GET_PLAN_NIDTFIELDS](
@NIDT_PLAN_FIELDS VARCHAR(50)
) 
 RETURNS @TEMP TABLE
 (INC_PLAN_ID INT,NIDT_FIELD INT)
AS  		
BEGIN	
	--set nocount on
	DECLARE @NIDTPLAN INT
	DECLARE @DELIMITER VARCHAR(1)
	DECLARE @NIDT_PLAN_FIELDSNEW VARCHAR(15)
	SET @DELIMITER=';'
	--SET @NIDT_PLAN_FIELDS='66;5,7'
	SET @NIDTPLAN=RTRIM(LTRIM(SUBSTRING(@NIDT_PLAN_FIELDS,1,CHARINDEX(@DELIMITER,@NIDT_PLAN_FIELDS,0)-1)))
	SET @NIDT_PLAN_FIELDS=RTRIM(LTRIM(SUBSTRING(@NIDT_PLAN_FIELDS,CHARINDEX(@DELIMITER,@NIDT_PLAN_FIELDS,0)+1,LEN(@NIDT_PLAN_FIELDS))))		

	SET @DELIMITER=','
	WHILE CHARINDEX(@DELIMITER,@NIDT_PLAN_FIELDS,0) <> 0
	BEGIN
		SET @NIDT_PLAN_FIELDSNEW=RTRIM(LTRIM(SUBSTRING(@NIDT_PLAN_FIELDS,1,CHARINDEX(@DELIMITER,@NIDT_PLAN_FIELDS,0)-1)))
		SET @NIDT_PLAN_FIELDS=RTRIM(LTRIM(SUBSTRING(@NIDT_PLAN_FIELDS,CHARINDEX(@DELIMITER,@NIDT_PLAN_FIELDS,0)+1,LEN(@NIDT_PLAN_FIELDS))))	
		--SELECT @NIDT_PLAN_FIELDSNEW	
		INSERT INTO @TEMP
		(INC_PLAN_ID,NIDT_FIELD) VALUES(@NIDTPLAN,@NIDT_PLAN_FIELDSNEW)

	END
	IF LEN(@NIDT_PLAN_FIELDS) >0
		BEGIN			
			INSERT INTO @TEMP
			(INC_PLAN_ID,NIDT_FIELD) VALUES(@NIDTPLAN,@NIDT_PLAN_FIELDS)
		END	
	RETURN
END










  







GO

/****** Object:  UserDefinedFunction [dbo].[FN_GETMIDTBREAKUP]    Script Date: 04/28/2011 15:46:31 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





 /*      
'COPYRIGHT NOTICE:  2007 BY BIRD INFORMATION SYSTEMS ALL RIGHTS RESERVED.      
'********************************************************************************************      
' THIS FILE CONTAINS TRADE SECRETS OF BIRD INFORMATION SYSTEMS NO PART      
' MAY BE REPRODUCED OR TRANSMITTED IN ANY FORM BY ANY MEANS OR FOR ANY PURPOSE      
' WITHOUT THE EXPRESS WRITTEN PERMISSION OF BIRD INFORMATION SYSTEMS      
'********************************************************************************************      
NAME: [UP_RPT_PR_CMR]
PURPOSE: THIS PROCEDURE RETURNs MIDT for CMR.      
|--------|--------------------------------------------------------------|
|SL. NO. |DATE		  |DEVELOPERS NAME		|ACTIVITY					|
|-----------------------------------------------------------------------|
|1.		 |12/12/2008  |TAPAN NATH           |CREATION					|
|-----------------------------------------------------------------------|
*/

CREATE FUNCTION [dbo].[FN_GETMIDTBREAKUP]
(@REPORTDATE DATETIME,@FDATE DATETIME,@PMONTH INT,@PYEAR  INT,@P2MONTH  INT,@P2YEAR  INT,@P3MONTH  INT,@P3YEAR  INT,@P4MONTH  INT,@P4YEAR  INT
,@COUNTRY VARCHAR(200)=NULL,
@CITY VARCHAR(50)=NULL,
@LCODE INT=NULL,
@AGENCYNAME VARCHAR(200)=NULL,
@AOFFICE VARCHAR(3)=NULL,
@REGION VARCHAR(50)=NULL
) 
 RETURNS TABLE
AS   RETURN (
		SELECT LCODE,
		'A_PREV'=SUM([1A_PREV]),'A_PREV2'=SUM([1A_PREV2]),'A_PREV3'=SUM([1A_PREV3]),'A_PREV4'=SUM([1A_PREV4]),
		'B_PREV'=SUM([1B_PREV]),'B_PREV2'=SUM([1B_PREV2]),'B_PREV3'=SUM([1B_PREV3]),'B_PREV4'=SUM([1B_PREV4]),
		'G_PREV'=SUM([1G_PREV]),'G_PREV2'=SUM([1G_PREV2]),'G_PREV3'=SUM([1G_PREV3]),'G_PREV4'=SUM([1G_PREV4]),
		'P_PREV'=SUM([1P_PREV]),'P_PREV2'=SUM([1P_PREV2]),'P_PREV3'=SUM([1P_PREV3]),'P_PREV4'=SUM([1P_PREV4]),
		'W_PREV'=SUM([1W_PREV]),'W_PREV2'=SUM([1W_PREV2]),'W_PREV3'=SUM([1W_PREV3]),'W_PREV4'=SUM([1W_PREV4]), 

		MIDTTOTAL_PMONTH=SUM([1A_PREV]) + SUM([1B_PREV]) + SUM([1G_PREV]) + SUM([1P_PREV]) + SUM([1W_PREV]),
		MIDTTOTAL_P2MONTH=SUM([1A_PREV2]) + SUM([1B_PREV2]) + SUM([1G_PREV2]) + SUM([1P_PREV2]) + SUM([1W_PREV2]),
		MIDTTOTAL_P3MONTH=SUM([1A_PREV3]) + SUM([1B_PREV3]) + SUM([1G_PREV3]) + SUM([1P_PREV3]) + SUM([1W_PREV3]), 
		MIDTTOTAL_P4MONTH=SUM([1A_PREV4]) + SUM([1B_PREV4]) + SUM([1G_PREV4]) +  SUM([1P_PREV4]) + SUM([1W_PREV4]) 
		FROM(
			SELECT 
				MP.LCODE,MP.DATE,CRSCODETEXT,
				'1A_PREV'=CASE WHEN (MONTH(DATE) = @PMONTH AND CRS.CRSCODETEXT= '1A') THEN SUM(NETBOOKINGS) ELSE 0 END,
				'1A_PREV2'=CASE WHEN (MONTH(DATE) = @P2MONTH AND CRS.CRSCODETEXT= '1A') THEN SUM(NETBOOKINGS) ELSE 0 END,
				'1A_PREV3'=CASE WHEN (MONTH(DATE) = @P3MONTH AND CRS.CRSCODETEXT= '1A') THEN SUM(NETBOOKINGS) ELSE 0 END,
				'1A_PREV4'=CASE WHEN (MONTH(DATE) = @P4MONTH AND CRS.CRSCODETEXT= '1A') THEN SUM(NETBOOKINGS) ELSE 0 END,


				'1B_PREV'=CASE WHEN (MONTH(DATE) = @PMONTH AND CRS.CRSCODETEXT= '1B') THEN SUM(NETBOOKINGS) ELSE 0 END,
				'1B_PREV2'=CASE WHEN (MONTH(DATE) = @P2MONTH AND CRS.CRSCODETEXT= '1B') THEN SUM(NETBOOKINGS) ELSE 0 END,
				'1B_PREV3'=CASE WHEN (MONTH(DATE) = @P3MONTH AND CRS.CRSCODETEXT= '1B') THEN SUM(NETBOOKINGS) ELSE 0 END,
				'1B_PREV4'=CASE WHEN (MONTH(DATE) = @P4MONTH AND CRS.CRSCODETEXT= '1B') THEN SUM(NETBOOKINGS) ELSE 0 END,


				'1G_PREV'=CASE WHEN (MONTH(DATE) = @PMONTH AND CRS.CRSCODETEXT= '1G') THEN SUM(NETBOOKINGS) ELSE 0 END,
				'1G_PREV2'=CASE WHEN (MONTH(DATE) = @P2MONTH AND CRS.CRSCODETEXT= '1G') THEN SUM(NETBOOKINGS) ELSE 0 END,
				'1G_PREV3'=CASE WHEN (MONTH(DATE) = @P3MONTH AND CRS.CRSCODETEXT= '1G') THEN SUM(NETBOOKINGS) ELSE 0 END,
				'1G_PREV4'=CASE WHEN (MONTH(DATE) = @P4MONTH AND CRS.CRSCODETEXT= '1G') THEN SUM(NETBOOKINGS) ELSE 0 END,


				'1P_PREV'=CASE WHEN (MONTH(DATE) = @PMONTH AND CRS.CRSCODETEXT= '1P') THEN SUM(NETBOOKINGS) ELSE 0 END,
				'1P_PREV2'=CASE WHEN (MONTH(DATE) = @P2MONTH AND CRS.CRSCODETEXT= '1P') THEN SUM(NETBOOKINGS) ELSE 0 END,
				'1P_PREV3'=CASE WHEN (MONTH(DATE) = @P3MONTH AND CRS.CRSCODETEXT= '1P') THEN SUM(NETBOOKINGS) ELSE 0 END,
				'1P_PREV4'=CASE WHEN (MONTH(DATE) = @P4MONTH AND CRS.CRSCODETEXT= '1P') THEN SUM(NETBOOKINGS) ELSE 0 END,


				'1W_PREV'=CASE WHEN (MONTH(DATE) = @PMONTH AND CRS.CRSCODETEXT= '1W') THEN SUM(NETBOOKINGS) ELSE 0 END,
				'1W_PREV2'=CASE WHEN (MONTH(DATE) = @P2MONTH AND CRS.CRSCODETEXT= '1W') THEN SUM(NETBOOKINGS) ELSE 0 END,
				'1W_PREV3'=CASE WHEN (MONTH(DATE) = @P3MONTH AND CRS.CRSCODETEXT= '1W') THEN SUM(NETBOOKINGS) ELSE 0 END,
				'1W_PREV4'=CASE WHEN (MONTH(DATE) = @P4MONTH AND CRS.CRSCODETEXT= '1W') THEN SUM(NETBOOKINGS) ELSE 0 END

			FROM T_MIDTPRODUCTIVITY MP WITH(NOLOCK)
			INNER JOIN T_CRS CRS WITH(NOLOCK) ON MP.CRSCODE=CRS.CRSCODE
			INNER JOIN LOCATION_MASTER LM WITH (NOLOCK) ON LM.LOCATION_CODE=MP.LCODE
			WHERE DATE BETWEEN @FDATE AND @REPORTDATE			
				  AND (@AGENCYNAME  IS NULL OR LM.NAME LIKE '%' + @AGENCYNAME + '%' )
				  AND (@LCODE  IS NULL OR LM.LOCATION_CODE=@LCODE)
				  AND (@CITY IS NULL OR LM.CITY=@CITY)
				  AND (@COUNTRY IS NULL OR LM.COUNTRY=@COUNTRY)
				  AND (@AOFFICE IS NULL OR LM.AOFFICE=@AOFFICE)
				  AND (@REGION IS NULL OR LM.AOFFICE IN(SELECT AOFFICE FROM BRANCH WHERE REGION=@REGION))
			GROUP BY MP.LCODE,MP.DATE,CRSCODETEXT) AS MB
		GROUP BY LCODE
)

















GO

/****** Object:  UserDefinedFunction [dbo].[FN_GETPCCOUNT]    Script Date: 04/28/2011 15:46:33 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



 /*        
'COPYRIGHT NOTICE:  2007 BY BIRD INFORMATION SYSTEMS ALL RIGHTS RESERVED.        
'********************************************************************************************        
' THIS FILE CONTAINS TRADE SECRETS OF BIRD INFORMATION SYSTEMS NO PART        
' MAY BE REPRODUCED OR TRANSMITTED IN ANY FORM BY ANY MEANS OR FOR ANY PURPOSE        
' WITHOUT THE EXPRESS WRITTEN PERMISSION OF BIRD INFORMATION SYSTEMS        
'********************************************************************************************        
NAME: [UP_RPT_PR_CMR]  
PURPOSE: THIS PROCEDURE RETURNs MIDT for CMR.        
|--------|--------------------------------------------------------------|  
|SL. NO. |DATE    |DEVELOPERS NAME  |ACTIVITY     |  
|-----------------------------------------------------------------------|  
|1.   |12/12/2008  |TAPAN NATH       |CREATION     |  
|-----------------------------------------------------------------------|  
*/  
  

-- SELECT * FROM DBO.FN_GETPCCOUNT()
  
CREATE FUNCTION [dbo].[FN_GETPCCOUNT]()   
	RETURNS TABLE  
AS   RETURN 
(  
				SELECT 
				LCODE , 
				'TOTAMADEUSPC'		= SUM(ISNULL(P.PCINSTALLED ,0)), 
				'TOTAGENCYPC'	= SUM(ISNULL(A.AGENCYINSTALLED,0)) , 
				'TOTMISC'		= SUM(ISNULL(T.MISCINSTALLED,0))  
				FROM T_C_ORDERS
				LEFT OUTER JOIN (SELECT ORDERNUMBER,MISCINSTALLED=COUNT(*) FROM MISCINSTALLATION  GROUP BY ORDERNUMBER) AS T
				ON T_C_ORDERS.ORDER_NUMBER = T.ORDERNUMBER 			

				LEFT OUTER JOIN (SELECT ORDERNUMBER,PCINSTALLED=COUNT(*) FROM PCINSTALLATION WHERE CPUTYPE <> 'CPP' GROUP BY ORDERNUMBER) AS P
				ON T_C_ORDERS.ORDER_NUMBER = P.ORDERNUMBER 

				LEFT OUTER JOIN (SELECT ORDERNUMBER,AGENCYINSTALLED=COUNT(*) FROM PCINSTALLATION WHERE CPUTYPE = 'CPP' GROUP BY ORDERNUMBER) AS A
				ON T_C_ORDERS.ORDER_NUMBER = A.ORDERNUMBER 
				
				AND NEWORDER = 1
				GROUP BY LCODE
			

				
)  
  
  
  
  
  
  
  
  
  
  
  
  


GO

/****** Object:  UserDefinedFunction [dbo].[fn_getsubtree]    Script Date: 04/28/2011 15:46:33 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION [dbo].[fn_getsubtree](@empid AS INT) 
    RETURNS @TREE TABLE
(
    empid   INT NOT NULL
    ,empname VARCHAR(25) NOT NULL
    ,mgrid   INT NULL
    ,lvl     INT NOT NULL
)
AS
BEGIN
  WITH Employees_Subtree(empid, empname, mgrid, lvl)
  AS
  ( 
    -- Anchor Member (AM)
    SELECT empid, empname, mgrid, 0
    FROM Employees
    WHERE empid = @empid

    UNION all
    
    -- Recursive Member (RM)
    SELECT e.empid, e.empname, e.mgrid, es.lvl+1
    FROM Employees AS e
      JOIN Employees_Subtree AS es
        ON e.mgrid = es.empid
  )
  INSERT INTO @TREE
    SELECT * FROM Employees_Subtree;

  RETURN
END



GO

/****** Object:  UserDefinedFunction [dbo].[FN_INC_RETURN_PAYMENTPERIOD_INTERVALS]    Script Date: 04/28/2011 15:46:33 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

      
       
 /*      
'COPYRIGHT NOTICE:  2007 BY BIRD INFORMATION SYSTEMS ALL RIGHTS RESERVED.                    
'********************************************************************************************      
' THIS FILE CONTAINS TRADE SECRETS OF BIRD INFORMATION SYSTEMS NO PART                    
' MAY BE REPRODUCED OR TRANSMITTED IN ANY FORM BY ANY MEANS OR FOR ANY PURPOSE                    
' WITHOUT THE EXPRESS WRITTEN PERMISSION OF BIRD INFORMATION SYSTEMS                    
'********************************************************************************************      
      
NAME: [FN_INC_RETURN_PAYMENTPERIOD_INTERVALS]              
PURPOSE: THIS FUNCTION CHECKS IF SPECIFIED THE INTERVALS OF THE PAYMENTS      
      
|-----------------------------------------------------------------------|              
|SL. NO. |DATE   |DEVELOPERS NAME  |ACTIVITY     |      
|-----------------------------------------------------------------------|              
|1.   |06/08/2010 |NEERAJ GOSWAMI    |CREATION     |      
|-----------------------------------------------------------------------|              
      
DECLARE @INTERVAL TABLE (ROWID INT IDENTITY(1,1),[DATEFROM] DATETIME,[DATETO] DATETIME,[MONTH] INT ,[YEAR] INT)      
INSERT INTO @INTERVAL ([DATEFROM],[DATETO] ,[MONTH] ,[YEAR] )      
SELECT [DATEFROM],[DATETO] ,[MONTH] ,[YEAR] FROM dbo.[FN_INC_RETURN_PAYMENTPERIOD_INTERVALS](20090701,20120630,19,7,2009,'Q')      
ORDER BY [YEAR],[MONTH]       
SELECT * FROM @INTERVAL      
      
--SELECT *  FROM T_INC_BC_MASTER      
--SELECT *  FROM T_INC_PAYMENT_PREVIOUS_DETAILS WHERE BC_ID = 19      
--SELECT *  FROM T_INC_PAYMENT_DETAILS WHERE BC_ID = 19      
      
DECLARE @ROWID INT      
SELECT @ROWID= ROWID FROM @INTERVAL WHERE MONTH = 9 AND YEAR = 2010      
      
SELECT [DATEFROM], [DATETO] ,[MONTH] ,[YEAR],((((YEAR*100) + MONTH)*100)+1) FROM @INTERVAL WHERE       
((((YEAR*100) + MONTH)*100)+1) NOT IN (SELECT ((((PAYMENT_YEAR_TO*100) + PAYMENT_MONTH_TO)*100)+1)  FROM T_INC_PAYMENT_DETAILS WHERE BC_ID = 19 )      
AND ROWID <@ROWID       
      
DECLARE @MISSINGPERIODS VARCHAR(2000)      
SELECT @MISSINGPERIODS = MISSING  FROM (      
SELECT  TOP 1 * , (      
SELECT  DateName( month ,[DATETO])  + ' - ' + CAST([YEAR] AS VARCHAR(4))  +', ' AS [text()]       
FROM @INTERVAL WHERE ((((YEAR*100) + MONTH)*100)+1) NOT IN (SELECT ((((PAYMENT_YEAR_TO*100) + PAYMENT_MONTH_TO)*100)+1)  FROM T_INC_PAYMENT_DETAILS WHERE BC_ID = 19 )      
AND ROWID <@ROWID  FOR XML PATH('')) AS MISSING FROM @INTERVAL) AS ABC      
      
SELECT @MISSINGPERIODS      
      
      
      
      
SELECT G.CHAIN_CODE,      
(      
SELECT CAST(OFFICEID AS VARCHAR(9)) + ', ' AS [text()]      
FROM V_CURRENT_OFFICEIDS VO WITH(NOLOCK)      
INNER JOIN LOCATION_MASTER LM WITH(NOLOCK) ON LM.LOCATION_CODE=VO.LCODE      
WHERE G.CHAIN_CODE=LM.CHAIN_CODE      
      
FOR XML PATH('')      
) AS OFFICEIDS      
FROM AGROUP G WITH(NOLOCK)      
WHERE G.CHAIN_CODE = @TEMPCHAIN_CODE      
  
SELECT [DATEFROM],[DATETO] ,[MONTH] ,[YEAR]  FROM dbo.[FN_INC_RETURN_PAYMENTPERIOD_INTERVALS](20090401,20120331,21,9,2009,'Q') ORDER BY [YEAR],[MONTH]  
      
*/      
      
      
              
CREATE FUNCTION [dbo].[FN_INC_RETURN_PAYMENTPERIOD_INTERVALS]      
(                        
   @EFFECTIVEDATE INT,              
   @ENDDATE INT=NULL,      
   @BC_ID INT=NULL,            
   @BILLINGMONTH INT=NULL,            
   @BILLINGYEAR INT=NULL,            
   @TYPE CHAR(1)=NULL      
)              
RETURNS @TEMPTABLE  TABLE ([DATEFROM] DATETIME,[DATETO] DATETIME,[MONTH] INT ,[YEAR] INT)      
AS              
BEGIN      
      
DECLARE @ISBILLINGPERION BIT            
DECLARE @STARTDATE DATETIME             
DECLARE @STARTDATE1 DATETIME           
DECLARE @TODATE DATETIME, @FROMDATE DATETIME               
DECLARE @UPFRONT INT      
DECLARE @UPFRONTFIRSTDATE DATETIME      
      
DECLARE @TEMP TABLE ([DATEFROM] DATETIME,[DATETO] DATETIME,[MONTH] INT ,[YEAR] INT)      
      
 SELECT @UPFRONT = INC_TYPE_ID FROM T_INC_BC_MASTER WITH(NOLOCK) WHERE BC_ID =@BC_ID      
   
            
 IF @TYPE='Q'            
 BEGIN            
   SET @STARTDATE1=CONVERT(DATETIME,CONVERT(VARCHAR(12),@EFFECTIVEDATE))            
   SET @STARTDATE=CONVERT(DATETIME,CONVERT(VARCHAR(12),@EFFECTIVEDATE))            
   SET @STARTDATE= CONVERT(DATETIME,CONVERT(VARCHAR(15),CAST(YEAR(@STARTDATE) AS VARCHAR(4)) + '-' + CAST(MONTH(@STARTDATE)AS VARCHAR(2)) +'-'+CAST('01' AS VARCHAR(2))))          
            
   SET @FROMDATE = DATEADD(MONTH,3,CAST(@STARTDATE AS DATETIME))            
   SET @TODATE=CONVERT(DATETIME,CONVERT(VARCHAR(12),@ENDDATE))            
            
   ;WITH DATESEQUENCE( [DATE] ) AS              
   (               
   SELECT @FROMDATE AS [DATE]               
   UNION ALL              
   SELECT DATEADD(MONTH, 3, [DATE])               
   FROM DATESEQUENCE               
   WHERE DATE < @TODATE               
   )             
            
   INSERT INTO @TEMP([DATEFROM],[DATETO],[MONTH],[YEAR])            
   SELECT  DISTINCT            
   --DATEADD(MONTH,-3,[DATE]) AS [DATEFROM],            
   [DATEFROM] = CASE WHEN ((MONTH(DATEADD(MONTH,-3,[DATE])) = MONTH(@STARTDATE1)) AND (YEAR(DATEADD(MONTH,-3,[DATE])) = YEAR(@STARTDATE1))) THEN          
   @STARTDATE1 ELSE DATEADD(MONTH,-3,[DATE]) END,          
   [DATE] = CASE  WHEN [DATE] > @TODATE THEN @TODATE ELSE            
   DATEADD(DAY,-1,[DATE]) END,            
   [MONTH] = CASE  WHEN [DATE] > @TODATE             
   THEN DATEPART(MONTH,@TODATE) ELSE            
   DATEPART(MONTH,DATEADD(DAY,-1,[DATE]))  END,            
   --DATEPART(YEAR,[DATE]) AS [YEAR]               
 [YEAR]  = CASE WHEN [DATE] > @TODATE THEN DATEPART(YEAR,@TODATE)  ELSE DATEPART(YEAR ,DATEADD(DAY,-1,[DATE]))  END        
   FROM DATESEQUENCE OPTION (MAXRECURSION 10000)      
         
   --SELECT INC_TYPE_ID FROM T_INC_BC_MASTER WHERE BC_ID =19      
         
   IF @UPFRONT =1       
   BEGIN  
  SELECT TOP 1 @UPFRONTFIRSTDATE = DATEFROM  FROM @TEMP ORDER BY YEAR,MONTH          
  DELETE @TEMP WHERE (((YEAR*100) + MONTH)*100)+1 IN ( SELECT DATENUMBER  = MIN((((YEAR*100) + MONTH)*100)+1) FROM @TEMP)        
  INSERT INTO  @TEMPTABLE([DATEFROM] ,[DATETO] ,[MONTH] ,[YEAR] )      
  SELECT 'DATEFROM' = @UPFRONTFIRSTDATE  ,'DATETO' =@UPFRONTFIRSTDATE  ,'MONTH' = MONTH(@UPFRONTFIRSTDATE) ,'YEAR' = YEAR(@UPFRONTFIRSTDATE)     
   END      
  INSERT INTO  @TEMPTABLE([DATEFROM] ,[DATETO] ,[MONTH] ,[YEAR] )      
  SELECT [DATEFROM] ,[DATETO] ,[MONTH] ,[YEAR] FROM @TEMP      
 END            
            
 IF @TYPE='Y'            
 BEGIN            
   SET @STARTDATE1=CONVERT(DATETIME,CONVERT(VARCHAR(12),@EFFECTIVEDATE))            
   SET @STARTDATE=CONVERT(DATETIME,CONVERT(VARCHAR(12),@EFFECTIVEDATE))            
   SET @STARTDATE= CONVERT(DATETIME,CONVERT(VARCHAR(15),CAST(YEAR(@STARTDATE) AS VARCHAR(4)) + '-' + CAST(MONTH(@STARTDATE)AS VARCHAR(2)) +'-'+CAST('01' AS VARCHAR(2))))           
            
   SET @FROMDATE = DATEADD(MONTH,12,CAST(@STARTDATE AS DATETIME))            
   SET @TODATE=CONVERT(DATETIME,CONVERT(VARCHAR(12),@ENDDATE))            
            
   ;WITH DATESEQUENCE( [DATE] ) AS              
   (               
   SELECT @FROMDATE AS [DATE]               
   UNION ALL              
   SELECT DATEADD(MONTH, 12, [DATE])               
   FROM DATESEQUENCE               
   WHERE DATE < @TODATE               
   )             
            
   INSERT INTO @TEMP([DATEFROM],[DATETO],[MONTH],[YEAR])            
   SELECT  DISTINCT            
   --DATEADD(MONTH,-12,[DATE]) AS [DATEFROM],            
   [DATEFROM] = CASE WHEN ((MONTH(DATEADD(MONTH,-12,[DATE])) = MONTH(@STARTDATE1)) AND (YEAR(DATEADD(MONTH,-12,[DATE])) = YEAR(@STARTDATE1))) THEN          
   @STARTDATE1 ELSE DATEADD(MONTH,-12,[DATE]) END,          
   [DATE] = CASE  WHEN [DATE] > @TODATE THEN @TODATE ELSE            
   DATEADD(DAY,-1,[DATE]) END,            
   [MONTH] = CASE  WHEN [DATE] > @TODATE             
   THEN DATEPART(MONTH,@TODATE) ELSE            
   DATEPART(MONTH,DATEADD(DAY,-1,[DATE]))  END,            
   --DATEPART(YEAR,[DATE]) AS [YEAR]               
[YEAR]  = CASE WHEN [DATE] > @TODATE THEN DATEPART(YEAR,@TODATE)  ELSE DATEPART(YEAR ,DATEADD(DAY,-1,[DATE]))  END        
   FROM DATESEQUENCE OPTION (MAXRECURSION 10000)            
   IF @UPFRONT =1       
   BEGIN      
  SELECT TOP 1 @UPFRONTFIRSTDATE = DATEFROM  FROM @TEMP ORDER BY YEAR,MONTH      
  DELETE @TEMP WHERE (((YEAR*100) + MONTH)*100)+1 IN ( SELECT DATENUMBER  = MIN((((YEAR*100) + MONTH)*100)+1) FROM @TEMP)    
  INSERT INTO  @TEMPTABLE([DATEFROM] ,[DATETO] ,[MONTH] ,[YEAR] )      
  SELECT 'DATEFROM' = @UPFRONTFIRSTDATE  ,'DATETO' =@UPFRONTFIRSTDATE  ,'MONTH' = MONTH(@UPFRONTFIRSTDATE) ,'YEAR' = YEAR(@UPFRONTFIRSTDATE)      
   END      
 INSERT INTO  @TEMPTABLE([DATEFROM] ,[DATETO] ,[MONTH] ,[YEAR] )      
 SELECT [DATEFROM] ,[DATETO] ,[MONTH] ,[YEAR] FROM @TEMP      
 END             
       
 IF @TYPE='H'            
 BEGIN            
   SET @STARTDATE1=CONVERT(DATETIME,CONVERT(VARCHAR(12),@EFFECTIVEDATE))            
   SET @STARTDATE=CONVERT(DATETIME,CONVERT(VARCHAR(12),@EFFECTIVEDATE))            
   SET @STARTDATE= CONVERT(DATETIME,CONVERT(VARCHAR(15),CAST(YEAR(@STARTDATE) AS VARCHAR(4)) + '-' + CAST(MONTH(@STARTDATE)AS VARCHAR(2)) +'-'+CAST('01' AS VARCHAR(2))))          
            
   SET @FROMDATE = DATEADD(MONTH,6,CAST(@STARTDATE AS DATETIME))            
   SET @TODATE=CONVERT(DATETIME,CONVERT(VARCHAR(12),@ENDDATE))            
            
 ;WITH DATESEQUENCE( [DATE] ) AS              
   (               
   SELECT @FROMDATE AS [DATE]               
   UNION ALL              
   SELECT DATEADD(MONTH, 6, [DATE])               
   FROM DATESEQUENCE               
   WHERE DATE < @TODATE               
   )             
            
   INSERT INTO @TEMP([DATEFROM],[DATETO],[MONTH],[YEAR])            
   SELECT  DISTINCT            
   --DATEADD(MONTH,-6,[DATE]) AS [DATEFROM],            
   [DATEFROM] = CASE WHEN ((MONTH(DATEADD(MONTH,-6,[DATE])) = MONTH(@STARTDATE1)) AND (YEAR(DATEADD(MONTH,-6,[DATE])) = YEAR(@STARTDATE1))) THEN          
   @STARTDATE1 ELSE DATEADD(MONTH,-6,[DATE]) END,          
   [DATE] = CASE  WHEN [DATE] > @TODATE THEN @TODATE ELSE            
   DATEADD(DAY,-1,[DATE]) END,            
   [MONTH] = CASE  WHEN [DATE] > @TODATE             
   THEN DATEPART(MONTH,@TODATE) ELSE            
   DATEPART(MONTH,DATEADD(DAY,-1,[DATE]))  END,            
   --DATEPART(YEAR,[DATE]) AS [YEAR]               
   [YEAR]  = CASE WHEN [DATE] > @TODATE THEN DATEPART(YEAR,@TODATE)  ELSE DATEPART(YEAR ,DATEADD(DAY,-1,[DATE]))  END        
   FROM DATESEQUENCE OPTION (MAXRECURSION 10000)            
   IF @UPFRONT =1       
   BEGIN      
  SELECT TOP 1 @UPFRONTFIRSTDATE = DATEFROM  FROM @TEMP ORDER BY YEAR,MONTH      
  DELETE @TEMP WHERE (((YEAR*100) + MONTH)*100)+1 IN ( SELECT DATENUMBER  = MIN((((YEAR*100) + MONTH)*100)+1) FROM @TEMP)    
  INSERT INTO  @TEMPTABLE([DATEFROM] ,[DATETO] ,[MONTH] ,[YEAR] )      
  SELECT 'DATEFROM' = @UPFRONTFIRSTDATE  ,'DATETO' =@UPFRONTFIRSTDATE  ,'MONTH' = MONTH(@UPFRONTFIRSTDATE) ,'YEAR' = YEAR(@UPFRONTFIRSTDATE)      
   END      
    INSERT INTO  @TEMPTABLE([DATEFROM] ,[DATETO] ,[MONTH] ,[YEAR] )      
 SELECT [DATEFROM] ,[DATETO] ,[MONTH] ,[YEAR] FROM @TEMP      
      
 END              
 IF @TYPE='M'            
 BEGIN            
   SET @STARTDATE1=CONVERT(DATETIME,CONVERT(VARCHAR(12),@EFFECTIVEDATE))            
   SET @STARTDATE=CONVERT(DATETIME,CONVERT(VARCHAR(12),@EFFECTIVEDATE))            
   SET @STARTDATE= CONVERT(DATETIME,CONVERT(VARCHAR(15),CAST(YEAR(@STARTDATE) AS VARCHAR(4)) + '-' + CAST(MONTH(@STARTDATE)AS VARCHAR(2)) +'-'+CAST('01' AS VARCHAR(2))))          
            
   SET @FROMDATE = DATEADD(MONTH,1,CAST(@STARTDATE AS DATETIME))            
   SET @TODATE=CONVERT(DATETIME,CONVERT(VARCHAR(12),@ENDDATE))            
            
   ;WITH DATESEQUENCE( [DATE] ) AS              
   (               
   SELECT @FROMDATE AS [DATE]               
   UNION ALL              
   SELECT DATEADD(MONTH, 1, [DATE])               
   FROM DATESEQUENCE               
   WHERE DATE < @TODATE              
   )               
   INSERT INTO @TEMP([DATEFROM],[DATETO],[MONTH],[YEAR])            
   SELECT  DISTINCT            
   [DATEFROM] = CASE WHEN ((MONTH(DATEADD(MONTH,-1,[DATE])) = MONTH(@STARTDATE1)) AND (YEAR(DATEADD(MONTH,-1,[DATE])) = YEAR(@STARTDATE1))) THEN          
   @STARTDATE1 ELSE DATEADD(MONTH,-1,[DATE]) END,          
   [DATE]  = CASE  WHEN [DATE] > @TODATE THEN @TODATE ELSE DATEADD(DAY,-1,[DATE]) END,            
   [MONTH] = CASE WHEN [DATE] > @TODATE THEN DATEPART(MONTH,@TODATE) ELSE DATEPART(MONTH,DATEADD(DAY,-1,[DATE]))  END,            
   [YEAR]  = CASE WHEN [DATE] > @TODATE THEN DATEPART(YEAR,@TODATE)  ELSE DATEPART(YEAR ,DATEADD(DAY,-1,[DATE]))  END            
   FROM DATESEQUENCE OPTION (MAXRECURSION 10000)            
   IF @UPFRONT =1       
   BEGIN      
  SELECT TOP 1 @UPFRONTFIRSTDATE = DATEFROM  FROM @TEMP ORDER BY YEAR,MONTH      
  DELETE @TEMP WHERE (((YEAR*100) + MONTH)*100)+1 IN ( SELECT DATENUMBER  = MIN((((YEAR*100) + MONTH)*100)+1) FROM @TEMP)    
  INSERT INTO  @TEMPTABLE([DATEFROM] ,[DATETO] ,[MONTH] ,[YEAR] )      
  SELECT 'DATEFROM' = @UPFRONTFIRSTDATE  ,'DATETO' =@UPFRONTFIRSTDATE  ,'MONTH' = MONTH(@UPFRONTFIRSTDATE) ,'YEAR' = YEAR(@UPFRONTFIRSTDATE)      
   END      
    INSERT INTO  @TEMPTABLE([DATEFROM] ,[DATETO] ,[MONTH] ,[YEAR] )      
 SELECT [DATEFROM] ,[DATETO] ,[MONTH] ,[YEAR] FROM @TEMP      
 END             
RETURN      
END 
GO

/****** Object:  UserDefinedFunction [dbo].[GETDATES_BETWEEN_DATE]    Script Date: 04/28/2011 15:46:34 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/*
'COPYRIGHT NOTICE:  2007 BY BIRD INFORMATION SYSTEMS ALL RIGHTS RESERVED.      
'********************************************************************************************      
' THIS FILE CONTAINS TRADE SECRETS OF BIRD INFORMATION SYSTEMS NO PART      
' MAY BE REPRODUCED OR TRANSMITTED IN ANY FORM BY ANY MEANS OR FOR ANY PURPOSE      
' WITHOUT THE EXPRESS WRITTEN PERMISSION OF BIRD INFORMATION SYSTEMS      
'********************************************************************************************      
NAME: [FN_AGENCYLTRS]
PURPOSE: THIS FUNCTION RETURNs Last Duplicate LTR of the Agency.      
|--------|--------------------------------------------------------------|
|SL. NO. |DATE		  |DEVELOPERS NAME		|ACTIVITY					|
|-----------------------------------------------------------------------|
|1.		 |10/01/2009  |NEERAJ GOSWAMI	    |CREATION					|
|-----------------------------------------------------------------------|


SELECT DATEDIFF(day,	
	CONVERT(SMALLDATETIME,CONVERT(VARCHAR,CONVERT(INTEGER,CONVERT(VARCHAR,CONVERT(DATETIME,CONVERT(DATETIME,CONVERT(VARCHAR,'01/05/2009'),103)),112))),6) , 
	CONVERT(SMALLDATETIME,CONVERT(VARCHAR,CONVERT(INTEGER,CONVERT(VARCHAR,CONVERT(DATETIME,CONVERT(DATETIME,CONVERT(VARCHAR,'31/05/2009'),103)),112))),6)
	)AS NumberOfDays

SELECT CONVERT(SMALLDATETIME,CONVERT(VARCHAR,CONVERT(INTEGER,CONVERT(VARCHAR,CONVERT(DATETIME,'31/05/2009'),112))),6)
SELECT CONVERT(SMALLDATETIME,CONVERT(VARCHAR,CONVERT(INTEGER,CONVERT(VARCHAR,CONVERT(DATETIME,CONVERT(DATETIME,CONVERT(VARCHAR,'01/05/2009'),103)),112))),6)
SELECT REPLACE(CONVERT(VARCHAR,CONVERT(SMALLDATETIME,CONVERT(VARCHAR,CONVERT(INTEGER,CONVERT(VARCHAR,CONVERT(DATETIME,'01/05/2009'),112)))),6),' ' , '-')

EXECUTE FUNCTION

SELECT DATES FROM GETDATES_BETWEEN_DATE ('05/01/2009','05/31/2009')

*/

-- METHOD TO GET DATES BETWEEN TWO DATES



CREATE FUNCTION [dbo].[GETDATES_BETWEEN_DATE]( @FDATE DATETIME,@TDATE DATETIME)
RETURNS @temptable TABLE
(
	DATES DATETIME
)

AS

BEGIN
	DECLARE @X INT
	DECLARE @ALLDATE VARCHAR(MAX)
	SET @ALLDATE =''

	SELECT @X = DATEDIFF(day,	
		CONVERT(SMALLDATETIME,CONVERT(VARCHAR,CONVERT(INTEGER,CONVERT(VARCHAR,CONVERT(DATETIME,CONVERT(DATETIME,CONVERT(VARCHAR,@FDATE),103)),112))),6) , 
		CONVERT(SMALLDATETIME,CONVERT(VARCHAR,CONVERT(INTEGER,CONVERT(VARCHAR,CONVERT(DATETIME,CONVERT(DATETIME,CONVERT(VARCHAR,@TDATE),103)),112))),6)
		)

	
	WHILE @X>0
	BEGIN
			--PRINT DATEADD(day,@X,@FDATE)
			INSERT INTO @temptable VALUES(DATEADD(day,@X,@FDATE))
			SET @X= @X-1
	END	
	INSERT INTO @temptable VALUES(@FDATE)		
	RETURN 
END


GO

/****** Object:  UserDefinedFunction [dbo].[SPLIT]    Script Date: 04/28/2011 15:46:34 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

create FUNCTION [dbo].[SPLIT] (
@STRINGTOSPLIT VARCHAR(2048),
@SEPARATOR VARCHAR(128))
RETURNS TABLE AS RETURN

WITH INDICES AS
(
SELECT 0 S, 1 E
UNION ALL
SELECT E, CHARINDEX(@SEPARATOR, @STRINGTOSPLIT, E) + LEN(@SEPARATOR)
FROM INDICES
WHERE E > S
)
SELECT SUBSTRING(@STRINGTOSPLIT,S,
CASE WHEN E > LEN(@SEPARATOR) THEN E-S-LEN(@SEPARATOR) ELSE LEN(@STRINGTOSPLIT) - S + 1 END) STRING
,S STARTINDEX
FROM INDICES WHERE S >0 
GO

/****** Object:  UserDefinedFunction [dbo].[strToTable]    Script Date: 04/28/2011 15:46:35 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

create FUNCTION [dbo].[strToTable]
(
@array varchar(max),
@del char(1)
)
RETURNS
@listTable TABLE
(
item VARCHAR(100)
)
AS
BEGIN

WITH rep (item,list) AS
(
SELECT SUBSTRING(@array,1,CHARINDEX(@del,@array,1) - 1) as item,
SUBSTRING(@array,CHARINDEX(@del,@array,1) + 1, LEN(@array)) + @del list

UNION ALL

SELECT SUBSTRING(list,1,CHARINDEX(@del,list,1) - 1) as item,
SUBSTRING(list,CHARINDEX(@del,list,1) + 1, LEN(list)) list
FROM rep
WHERE LEN(rep.list) > 0
)
INSERT INTO @listTable
SELECT item FROM rep

RETURN
END


GO

/****** Object:  UserDefinedFunction [dbo].[TableFormDelimetedStringWithoutNumberList]    Script Date: 04/28/2011 15:46:35 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION [dbo].[TableFormDelimetedStringWithoutNumberList]
(
 @list       NVARCHAR(MAX),
  @delim  NCHAR(1) = ','
)
RETURNS @tmp TABLE
(
    ID  INT IDENTITY (1, 1),
    Data    Varchar(MAX)
)
BEGIN
  ;WITH CTETable (start, stop)
   AS
 (
       SELECT start = CONVERT(bigint, 1),
          stop = CHARINDEX(@delim, @list + @delim)
        UNION ALL   -- added for recursive part of CTE
      SELECT start = stop + 1,
            stop = CHARINDEX(@delim, @list + @delim, stop + 1)  -- added for recursive part of CTE
      FROM   CTETable
     WHERE  stop > 0
  )
   INSERT INTO @tmp (Data)
 SELECT LTRIM(RTRIM(SUBSTRING(@list, start,
     CASE
           WHEN stop > 0 
           THEN stop - start 
          ELSE 0 
     END))) AS Data
  FROM CTETable
   WHERE stop > 0
RETURN
END

GO

/****** Object:  UserDefinedFunction [dbo].[VW_GROUP_PRODUCTIVITY]    Script Date: 04/28/2011 15:46:36 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE FUNCTION [dbo].[VW_GROUP_PRODUCTIVITY]
(
	@CITY VARCHAR(50) =NULL,  
	@COUNTRY VARCHAR(50) =NULL,  
	@REGION VARCHAR(50) =NULL,  
	@CHAINCODE  INT =NULL,  	
	@CHAINNAME VARCHAR(200) =NULL,  	
	@AOFFICE VARCHAR(3)=NULL,
	@CRS VARCHAR(5)=NULL,
	@TP_SYMBOL VARCHAR(50) =NULL,
	@TP_FROM INT=10,
	@TP_TO INT=NULL,
	@CRSTYPE VARCHAR(10)=NULL,
	@GROUPDATA BIT=NULL,	
	@GROUPTYPEID INT=NULL,
	@DATEFROM VARCHAR(10)=NULL,
	@DATETO VARCHAR(10)=NULL,
	@EMPLOYEEID INT=24,
	@LIMITED_TO_AOFFICE VARCHAR(3)=NULL, --SEND AOFFICE
	@LIMITED_TO_REGION INT=NULL,  -- SECURITY REGION
	@LIMITED_TO_OWNAAGENCY INT=NULL,
	@BRANCHAOFFICE VARCHAR(3)=null
) 
RETURNS TABLE
AS  		
	RETURN(
		SELECT GP.CHAIN_CODE,GP.CHAIN_NAME,'1A'=SUM(ISNULL(GP.[1A],0)),'1B'=SUM(ISNULL(GP.[1B],0)),'1G'=SUM(ISNULL(GP.[1G],0)),'1P'=SUM(ISNULL(GP.[1P],0)),'1W'=SUM(ISNULL(GP.[1W],0)),'TOTAL'=SUM(ISNULL(GP.[TOTAL],0)) FROM(
		SELECT GRP.CHAIN_CODE,GRP.CHAIN_NAME,GRP.CRSCODETEXT,GRP.PRODUCTIVITY as Total, 
			'1A'=CASE WHEN CRSCODETEXT='1A' THEN GRP.PRODUCTIVITY END,
			'1B'=CASE WHEN CRSCODETEXT='1B' THEN GRP.PRODUCTIVITY END,
			'1G'=CASE WHEN CRSCODETEXT='1G' THEN GRP.PRODUCTIVITY END,
			'1P'=CASE WHEN CRSCODETEXT='1P' THEN GRP.PRODUCTIVITY END,
			'1W'=CASE WHEN CRSCODETEXT='1W' THEN GRP.PRODUCTIVITY END
		FROM(
		SELECT 
		AG.CHAIN_CODE,AG.CHAIN_NAME,CRS.CRSCODETEXT,
		'PRODUCTIVITY'=SUM(ISNULL(MP.NETBOOKINGS,0)) 
		FROM T_MIDTPRODUCTIVITY MP WITH(NOLOCK)
		INNER JOIN LOCATION_MASTER LM WITH(NOLOCK) ON LM.LOCATION_CODE=MP.LCODE		
		INNER JOIN AGROUP AG WITH(NOLOCK) ON LM.CHAIN_CODE=AG.CHAIN_CODE		
		INNER JOIN T_CRS CRS WITH(NOLOCK) ON CRS.CRSCODE=MP.CRSCODE
		WHERE MP.DATE BETWEEN @DATEFROM AND @DATETO		
		AND (@COUNTRY IS NULL OR LM.COUNTRY=@COUNTRY)
		AND (@CITY IS NULL OR LM.CITY=@CITY)
		AND (@AOFFICE IS NULL OR LM.AOFFICE=@AOFFICE)	
		--AND (@BRANCHAOFFICE IS NULL OR AG.AOFFICE=@BRANCHAOFFICE)		
		AND (@CHAINCODE IS NULL OR LM.CHAIN_CODE=@CHAINCODE)		
		AND (@CHAINNAME IS NULL OR AG.CHAIN_NAME LIKE '%' + @CHAINNAME + '%'	)
		AND (@GROUPTYPEID IS NULL OR AG.GROUPTYPEID=@GROUPTYPEID)	
		AND (@REGION IS NULL OR LM.AOFFICE IN (SELECT AOFFICE FROM BRANCH  WITH (NOLOCK) WHERE REGION=@REGION))		
		AND LM.CHAIN_CODE IN ( SELECT CHAIN_CODE FROM T_G_EMP_AGENCY_GROUP  WITH (NOLOCK) WHERE EMPLOYEEID = @EMPLOYEEID) 

		GROUP BY AG.CHAIN_CODE,AG.CHAIN_NAME,CRS.CRSCODETEXT) AS GRP) AS GP
		GROUP BY GP.CHAIN_CODE,GP.CHAIN_NAME
	)





GO

/****** Object:  UserDefinedFunction [dbo].[VW_GROUP_PRODUCTIVITY_NEW]    Script Date: 04/28/2011 15:46:37 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[VW_GROUP_PRODUCTIVITY_NEW]
(
	@CITY VARCHAR(50) =NULL,  
	@COUNTRY VARCHAR(50) =NULL,  
	@REGION VARCHAR(50) =NULL,  
	@CHAINCODE  INT =NULL,  	
	@CHAINNAME VARCHAR(200) =NULL,  	
	@AOFFICE VARCHAR(3)=NULL,
	@CRS VARCHAR(5)=NULL,
	@TP_SYMBOL VARCHAR(50) =NULL,
	@TP_FROM INT=10,
	@TP_TO INT=NULL,
	@CRSTYPE VARCHAR(10)=NULL,
	@GROUPDATA BIT=NULL,	
	@GROUPTYPEID INT=NULL,
	@DATEFROM VARCHAR(10)=NULL,
	@DATETO VARCHAR(10)=NULL,
	@EMPLOYEEID INT=24,
	@LIMITED_TO_AOFFICE VARCHAR(3)=NULL, --SEND AOFFICE
	@LIMITED_TO_REGION INT=NULL,  -- SECURITY REGION
	@LIMITED_TO_OWNAAGENCY INT=NULL
) 
RETURNS TABLE
AS  		
	RETURN(
		SELECT GP.CHAIN_CODE,GP.CHAIN_NAME,'1A'=SUM(ISNULL(GP.[1A],0)),'1B'=SUM(ISNULL(GP.[1B],0)),'1G'=SUM(ISNULL(GP.[1G],0)),'1P'=SUM(ISNULL(GP.[1P],0)),'1W'=SUM(ISNULL(GP.[1W],0)),'TOTAL'=SUM(ISNULL(GP.[TOTAL],0)) FROM(
		SELECT GRP.CHAIN_CODE,GRP.CHAIN_NAME,GRP.CRSCODETEXT,GRP.PRODUCTIVITY as Total, 
			'1A'=CASE WHEN CRSCODETEXT='1A' THEN GRP.PRODUCTIVITY END,
			'1B'=CASE WHEN CRSCODETEXT='1B' THEN GRP.PRODUCTIVITY END,
			'1G'=CASE WHEN CRSCODETEXT='1G' THEN GRP.PRODUCTIVITY END,
			'1P'=CASE WHEN CRSCODETEXT='1P' THEN GRP.PRODUCTIVITY END,
			'1W'=CASE WHEN CRSCODETEXT='1W' THEN GRP.PRODUCTIVITY END
		FROM(
		SELECT 
		AG.CHAIN_CODE,AG.CHAIN_NAME,CRS.CRSCODETEXT,
		'PRODUCTIVITY'=SUM(ISNULL(MP.NETBOOKINGS,0)) 
		FROM T_MIDTPRODUCTIVITY MP WITH(NOLOCK)
		INNER JOIN LOCATION_MASTER LM WITH(NOLOCK) ON LM.LOCATION_CODE=MP.LCODE		
		INNER JOIN AGROUP AG WITH(NOLOCK) ON LM.CHAIN_CODE=AG.CHAIN_CODE		
		INNER JOIN T_CRS CRS WITH(NOLOCK) ON CRS.CRSCODE=MP.CRSCODE
		WHERE MP.DATE BETWEEN @DATEFROM AND @DATETO		
		AND (@COUNTRY IS NULL OR LM.COUNTRY=@COUNTRY)
		AND (@CITY IS NULL OR LM.CITY=@CITY)
		AND (@AOFFICE IS NULL OR LM.AOFFICE=@AOFFICE)		
		AND (@CHAINCODE IS NULL OR LM.CHAIN_CODE=@CHAINCODE)		
		AND (@CHAINNAME IS NULL OR AG.CHAIN_NAME LIKE '%' + @CHAINNAME + '%'	)
		AND (@GROUPTYPEID IS NULL OR AG.GROUPTYPEID=@GROUPTYPEID)	
		AND (@REGION IS NULL OR LM.AOFFICE IN (SELECT AOFFICE FROM BRANCH  WITH (NOLOCK) WHERE REGION=@REGION))		
		AND LM.CHAIN_CODE IN ( SELECT CHAIN_CODE FROM T_G_EMP_AGENCY_GROUP  WITH (NOLOCK) WHERE EMPLOYEEID = @EMPLOYEEID) 

		GROUP BY AG.CHAIN_CODE,AG.CHAIN_NAME,CRS.CRSCODETEXT) AS GRP) AS GP
		GROUP BY GP.CHAIN_CODE,GP.CHAIN_NAME
	)


GO


